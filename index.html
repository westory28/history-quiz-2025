<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ìš©ì‹ ì¤‘í•™êµ ì—­ì‚¬êµì‚¬ ë°©ì¬ì„</title>
    
    <!-- í•„ìˆ˜ ë¼ì´ë¸ŒëŸ¬ë¦¬ -->
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    
    <!-- Firebase SDK -->
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-firestore.js"></script>

    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+KR:wght@400;500;700&family=Noto+Serif+KR:wght@700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">

    <style>
        body { font-family: 'Noto Sans KR', sans-serif; background-color: #f5f5f4; }
        .serif { font-family: 'Noto Serif KR', serif; }
        .fade-in { animation: fadeIn 0.3s ease-in-out; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(5px); } to { opacity: 1; transform: translateY(0); } }
        
        .timer-bar { transition: width 1s linear; }
        .timer-urgent { background-color: #ef4444 !important; animation: pulse 1s infinite; }
        @keyframes pulse { 0%, 100% { opacity: 1; } 50% { opacity: 0.5; } }

        .teacher-btn {
            background-color: #44403c; color: white; padding: 6px 12px;
            border-radius: 8px; font-size: 0.85rem; font-weight: bold;
            display: flex; align-items: center; gap: 6px; cursor: pointer;
            border: 1px solid #57534e; z-index: 50;
        }
        .teacher-btn:hover { background-color: #292524; }

        .modal-overlay { background-color: rgba(0, 0, 0, 0.5); }
        
        .admin-table th, .admin-table td { border-bottom: 1px solid #e5e7eb; vertical-align: middle; }
        .admin-table th:not(:last-child), .admin-table td:not(:last-child) { border-right: 2px solid #d6d3d1; }
        .col-answer { background-color: #fffbeb; color: #b45309; font-weight: bold; }

        /* ë²„íŠ¼ ìŠ¤íƒ€ì¼ */
        .seq-btn { padding: 8px 12px; border-radius: 6px; font-weight: bold; border: 1px solid #d1d5db; transition: all 0.2s; cursor: pointer; margin: 4px; }
        .seq-btn-default { background-color: #ffffff !important; color: #1f2937 !important; }
        .seq-btn-selected { background-color: #d97706 !important; color: #ffffff !important; border-color: #b45309 !important; box-shadow: 0 2px 4px rgba(0,0,0,0.1); }

        .ox-btn { height: 80px; font-size: 2.5rem; font-weight: 900; border-radius: 12px; transition: all 0.2s; border: 2px solid transparent; width: 100%; }
        .ox-btn:hover { transform: translateY(-2px); box-shadow: 0 4px 6px rgba(0,0,0,0.1); }
        .btn-o { background-color: #e0f2fe; color: #0284c7; border-color: #0284c7; }
        .btn-o.selected { background-color: #0284c7; color: white; }
        .btn-x { background-color: #fee2e2; color: #dc2626; border-color: #dc2626; }
        .btn-x.selected { background-color: #dc2626; color: white; }

        #loading-overlay { display: none; position: fixed; inset: 0; background: rgba(255,255,255,0.9); z-index: 9999; justify-content: center; align-items: center; flex-direction: column; }
        
        .logo-btn { cursor: pointer; transition: opacity 0.2s; }
        .logo-btn:hover { opacity: 0.8; }
        
        /* ì´ë¯¸ì§€ ìŠ¤íƒ€ì¼ */
        .q-image-thumb { 
            max-width: 100%; max-height: 250px; 
            border-radius: 8px; margin: 10px auto; 
            border: 1px solid #e5e7eb; display: block; object-fit: contain; 
            cursor: zoom-in;
            transition: transform 0.2s;
        }
        .q-image-thumb:hover { transform: scale(1.02); }

        /* ì´ë¯¸ì§€ í™•ëŒ€ ëª¨ë‹¬ */
        #image-zoom-modal { display: none; position: fixed; inset: 0; background: rgba(0,0,0,0.9); z-index: 10000; justify-content: center; align-items: center; cursor: zoom-out; }
        #image-zoom-content { max-width: 95%; max-height: 95%; border-radius: 4px; box-shadow: 0 20px 25px -5px rgba(0, 0, 0, 0.1), 0 10px 10px -5px rgba(0, 0, 0, 0.04); }
    </style>
</head>
<body class="text-stone-800 min-h-screen flex flex-col">

    <!-- ë¡œë”© ì˜¤ë²„ë ˆì´ -->
    <div id="loading-overlay">
        <div class="animate-spin rounded-full h-16 w-16 border-t-4 border-amber-600 border-solid mb-4"></div>
        <p class="text-xl font-bold text-stone-700" id="loading-text">ë°ì´í„° ì²˜ë¦¬ ì¤‘...</p>
    </div>

    <!-- ì´ë¯¸ì§€ í™•ëŒ€ ëª¨ë‹¬ -->
    <div id="image-zoom-modal" onclick="app.closeImageZoom()">
        <img id="image-zoom-content" src="" alt="í™•ëŒ€ ì´ë¯¸ì§€">
    </div>

    <!-- í—¤ë” -->
    <header class="bg-stone-900 text-white py-4 shadow-lg sticky top-0 z-40">
        <div class="container mx-auto px-4 flex justify-between items-center relative">
            <h1 class="text-lg md:text-xl font-bold tracking-tight truncate pr-2 logo-btn" onclick="app.goToMain()">
                <span class="mr-2">ğŸ§‘â€ğŸ«</span> ìš©ì‹ ì¤‘í•™êµ ì—­ì‚¬êµì‚¬ ë°©ì¬ì„
            </h1>
            <button id="btn-teacher-mode" class="teacher-btn">
                <i class="fas fa-lock"></i> êµì‚¬
            </button>
        </div>
    </header>

    <main class="flex-grow container mx-auto px-4 py-6">
        
        <!-- 1. ë¡œê·¸ì¸ -->
        <section id="view-login" class="max-w-md mx-auto bg-white p-8 rounded-xl shadow-lg fade-in mt-8 border-t-4 border-amber-500">
            <div class="text-center mb-8">
                <span class="bg-amber-100 text-amber-900 text-sm font-bold px-3 py-1 rounded-full">ìš©ì‹ ì¤‘í•™êµ 2í•™ë…„ 2í•™ê¸° ì—­ì‚¬1</span>
                <h2 class="text-2xl font-bold serif text-stone-900 mt-4">ë‹¹ì‹ ì˜ ì—­ì‚¬ ì‹¤ë ¥ì€?</h2>
                <p class="text-red-500 font-bold text-sm mt-2"><i class="fas fa-stopwatch mr-1"></i> ì œí•œì‹œê°„ 60ì´ˆ (5ë¬¸ì œ)</p>
            </div>
            <div class="space-y-4">
                <div>
                    <label class="text-xs font-bold text-stone-500 block mb-1">í•™ë²ˆ ì •ë³´</label>
                    <div class="flex gap-2">
                        <div class="w-1/4 bg-stone-100 border border-stone-300 rounded flex items-center justify-center font-bold text-stone-600">2í•™ë…„</div>
                        <select id="input-class" class="w-2/4 p-3 border border-stone-300 rounded focus:border-amber-500 outline-none">
                            <option value="">ë°˜ ì„ íƒ</option>
                            <option value="1">1ë°˜</option><option value="2">2ë°˜</option><option value="3">3ë°˜</option>
                            <option value="4">4ë°˜</option><option value="5">5ë°˜</option><option value="6">6ë°˜</option>
                            <option value="7">7ë°˜</option><option value="8">8ë°˜</option><option value="9">9ë°˜</option>
                            <option value="10">10ë°˜</option>
                        </select>
                        <input type="number" id="input-number" placeholder="ë²ˆí˜¸" class="w-1/4 p-3 border border-stone-300 rounded focus:border-amber-500 outline-none text-center">
                    </div>
                </div>
                <div>
                    <label class="text-xs font-bold text-stone-500 block mb-1">ì´ë¦„</label>
                    <input type="text" id="input-name" placeholder="ì´ë¦„ ì…ë ¥" class="w-full p-3 border border-stone-300 rounded focus:border-amber-500 outline-none">
                </div>
                <button onclick="app.startQuiz()" class="w-full bg-stone-900 text-white font-bold py-4 rounded-lg hover:bg-stone-700 transition shadow-lg mt-4 transform active:scale-95">ë„ì „ ì‹œì‘ <i class="fas fa-play ml-2"></i></button>
            </div>
        </section>

        <!-- 2. í€´ì¦ˆ í™”ë©´ -->
        <section id="view-quiz" class="hidden max-w-2xl mx-auto fade-in">
            <div class="bg-white rounded-lg shadow-sm mb-6 sticky top-20 z-30 overflow-hidden border border-stone-200">
                <div class="flex justify-between items-center px-4 py-2 bg-stone-50 border-b border-stone-100">
                    <span class="text-sm font-bold text-stone-600" id="quiz-progress-text">1 / 5</span>
                    <span class="text-lg font-bold text-red-600 font-mono" id="timer-text">60ì´ˆ</span>
                </div>
                <div class="w-full bg-stone-200 h-2"><div id="timer-bar" class="bg-amber-500 h-full timer-bar" style="width: 100%"></div></div>
            </div>
            <div class="bg-white p-6 md:p-10 rounded-lg min-h-[400px] flex flex-col relative shadow-md">
                <div class="mb-4">
                    <span id="student-question-unit" class="inline-block bg-stone-100 text-stone-500 text-xs font-bold px-2 py-1 rounded mb-1"></span>
                    <div class="flex justify-between items-center">
                        <span id="question-badge" class="bg-amber-100 text-amber-800 text-xs font-bold px-2 py-1 rounded border border-amber-200">ìœ í˜•</span>
                    </div>
                </div>
                <!-- ì´ë¯¸ì§€ ì˜ì—­ -->
                <div id="question-image-area" class="mb-4 hidden text-center">
                    <img id="question-image" src="" alt="ë¬¸ì œ ì´ë¯¸ì§€" class="q-image-thumb" onclick="app.openImageZoom(this.src)">
                    <p class="text-[10px] text-gray-400 mt-1">ì´ë¯¸ì§€ë¥¼ í´ë¦­í•˜ë©´ í™•ëŒ€ë©ë‹ˆë‹¤.</p>
                </div>
                <h3 id="question-text" class="text-xl md:text-2xl font-bold mt-2 mb-8 text-stone-900 leading-relaxed serif break-keep"></h3>
                <div id="answer-area" class="flex-grow mb-6"></div>
                <div class="flex gap-3 mt-auto">
                    <button id="btn-prev" onclick="app.prevQuestion()" class="hidden w-1/3 bg-stone-200 text-stone-700 font-bold py-4 rounded-lg hover:bg-stone-300 transition shadow-sm"><i class="fas fa-chevron-left mr-1"></i> ì´ì „</button>
                    <button id="btn-next" onclick="app.submitAnswer()" class="w-full bg-amber-600 text-white font-bold py-4 rounded-lg hover:bg-amber-700 transition shadow-md">ë‹¤ìŒ <i class="fas fa-chevron-right ml-1"></i></button>
                </div>
            </div>
        </section>

        <!-- 3. ê²°ê³¼ í™”ë©´ -->
        <section id="view-results" class="hidden max-w-lg mx-auto fade-in mt-6">
            <div class="bg-white p-8 rounded-xl shadow-xl text-center border-t-8 border-amber-500">
                <h2 class="text-3xl font-bold serif mb-2 text-stone-800">í‰ê°€ ì¢…ë£Œ</h2>
                <p class="text-stone-500 mb-6"><span id="result-name" class="font-bold text-stone-900"></span> í•™ìƒì˜ ìµœì¢… ê¸°ë¡</p>
                <div class="relative w-48 h-48 mx-auto mb-4">
                    <canvas id="scoreChart"></canvas>
                    <div class="absolute inset-0 flex items-center justify-center flex-col"><span class="text-5xl font-bold text-amber-600 font-mono" id="score-text">0</span><span class="text-xs text-stone-400">ì </span></div>
                </div>
                <div id="submission-status" class="bg-stone-50 p-3 rounded text-sm mb-6 border border-stone-200 text-stone-500"><i class="fas fa-circle-notch fa-spin"></i> ë°ì´í„° ì €ì¥ ì¤‘...</div>
                <div class="grid grid-cols-2 gap-3">
                    <button onclick="app.toggleReview()" class="bg-white border-2 border-stone-200 text-stone-700 font-bold py-3 rounded hover:bg-stone-50 hover:border-stone-400 transition"><i class="fas fa-book-open mr-1"></i> ì˜¤ë‹µë…¸íŠ¸</button>
                    <button onclick="location.reload()" class="bg-stone-900 text-white font-bold py-3 rounded hover:bg-stone-700 transition shadow-lg"><i class="fas fa-redo mr-1"></i> ë‹¤ì‹œ ë„ì „</button>
                </div>
            </div>
            <div id="review-section" class="hidden mt-6 bg-white p-6 rounded-xl shadow-lg border border-red-200">
                <h3 class="font-bold text-lg mb-4 text-red-600 border-b pb-2"><i class="fas fa-check-circle"></i> ì˜¤ë‹µ í™•ì¸</h3>
                <div id="review-list" class="space-y-4 text-left"></div>
            </div>
        </section>

        <!-- 4. êµì‚¬ ëŒ€ì‹œë³´ë“œ -->
        <section id="view-teacher" class="hidden max-w-6xl mx-auto bg-white p-6 rounded shadow-xl mt-4 border border-stone-300 relative">
            <div class="flex justify-between items-center mb-6 border-b pb-4">
                <div><h2 class="font-bold text-2xl text-stone-800"><i class="fas fa-chalkboard-teacher text-amber-600 mr-2"></i>êµì‚¬ ëŒ€ì‹œë³´ë“œ</h2><p class="text-xs text-stone-500 mt-1">ë¹„ë°€ë²ˆí˜¸: **** | <span class="text-blue-600 font-bold">Firebase ì—°ë™ë¨</span></p></div>
                <button onclick="app.closeTeacherMode()" class="bg-stone-200 hover:bg-stone-300 text-stone-700 px-4 py-2 rounded text-sm font-bold">ë‚˜ê°€ê¸°</button>
            </div>
            <div class="flex flex-wrap gap-2 mb-6">
                <button onclick="app.setTeacherTab('log')" id="btn-tab-log" class="px-5 py-2 rounded-full bg-stone-800 text-white text-sm font-bold shadow transition"><i class="fas fa-list mr-1"></i> ì‹¤ì‹œê°„ ê¸°ë¡</button>
                <button onclick="app.setTeacherTab('bank')" id="btn-tab-bank" class="px-5 py-2 rounded-full bg-stone-100 text-stone-600 text-sm font-bold hover:bg-stone-200 shadow transition"><i class="fas fa-database mr-1"></i> ë¬¸ì œ ì€í–‰</button>
                <button onclick="app.setTeacherTab('add')" id="btn-tab-add" class="px-5 py-2 rounded-full bg-stone-100 text-stone-600 text-sm font-bold hover:bg-stone-200 shadow transition"><i class="fas fa-plus-circle mr-1"></i> ë¬¸ì œ ì¶”ê°€/ì—…ë¡œë“œ</button>
            </div>

            <!-- íƒ­: ê¸°ë¡ -->
            <div id="tab-log">
                <div class="flex justify-between items-center mb-4 flex-wrap gap-2">
                    <h3 class="font-bold text-lg flex items-center">ì œì¶œ í˜„í™© <span id="log-count" class="text-sm font-normal text-stone-500 ml-2">(ë¡œë”©ì¤‘...)</span></h3>
                    <div class="flex gap-2 items-center">
                        <select id="filter-class" onchange="app.renderLogs()" class="p-2 border rounded text-sm bg-white"><option value="all">ì „ì²´ ë°˜ ë³´ê¸°</option><option value="1">1ë°˜</option><option value="2">2ë°˜</option><option value="3">3ë°˜</option><option value="4">4ë°˜</option><option value="5">5ë°˜</option><option value="6">6ë°˜</option><option value="7">7ë°˜</option><option value="8">8ë°˜</option><option value="9">9ë°˜</option><option value="10">10ë°˜</option></select>
                        <button onclick="app.loadServerLogs()" class="bg-blue-600 hover:bg-blue-700 text-white px-3 py-2 rounded text-sm font-bold shadow"><i class="fas fa-sync-alt"></i></button>
                        <button onclick="app.downloadExcel()" class="bg-green-600 hover:bg-green-700 text-white px-3 py-2 rounded text-sm font-bold shadow"><i class="fas fa-file-excel mr-1"></i> ì—‘ì…€</button>
                    </div>
                </div>
                <div class="overflow-auto max-h-[500px] border rounded bg-stone-50">
                    <table class="w-full text-sm text-left admin-table"><thead class="bg-stone-200 text-stone-700 sticky top-0 font-bold"><tr><th class="p-3">ì‹œê°„</th><th class="p-3">ì •ë³´</th><th class="p-3">ì ìˆ˜</th><th class="p-3">ìƒíƒœ</th><th class="p-3">ì‚­ì œ</th></tr></thead><tbody id="teacher-log-body" class="bg-white"><tr><td colspan="5" class="p-4 text-center text-stone-400">ë°ì´í„°ë¥¼ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘...</td></tr></tbody></table>
                </div>
            </div>

            <!-- íƒ­: ë¬¸ì œ ì€í–‰ -->
            <div id="tab-bank" class="hidden">
                <div class="flex flex-col md:flex-row justify-between items-center mb-4 bg-stone-50 p-3 rounded border border-stone-200 gap-3">
                    <div class="flex items-center gap-2"><h3 class="font-bold text-lg">ì „ì²´ ë¬¸ì œ ë¦¬ìŠ¤íŠ¸ <span id="total-q-count" class="text-sm text-stone-500"></span></h3></div>
                    <div class="flex gap-2 flex-wrap">
                        <select id="bank-sort" onchange="app.renderBank()" class="p-2 border rounded text-xs"><option value="id">ë²ˆí˜¸ìˆœ</option><option value="unit">ë‹¨ì›ìˆœ</option><option value="type">ìœ í˜•ìˆœ</option></select>
                        <select id="bank-filter-unit" onchange="app.renderBank()" class="p-2 border rounded text-xs w-32"><option value="all">ëª¨ë“  ë‹¨ì›</option><option value="I.">I. ê³ ëŒ€</option><option value="II.">II. ì¢…êµ/ë¬¸í™”</option><option value="III.">III. ì§€ì—­êµë¥˜</option><option value="IV.">IV. ì œêµ­ì£¼ì˜</option><option value="V.">V. ì„¸ê³„ëŒ€ì „</option></select>
                        <button onclick="app.resetServerQuestions()" class="bg-red-100 text-red-600 border border-red-200 px-3 py-2 rounded text-xs font-bold hover:bg-red-200 transition flex items-center shadow-sm"><i class="fas fa-trash-alt mr-1"></i> ì´ˆê¸°í™”</button>
                    </div>
                </div>
                <div class="overflow-auto max-h-[500px] border rounded bg-stone-50">
                    <table class="w-full text-sm text-left admin-table table-bordered">
                        <thead class="bg-stone-200 text-stone-700 sticky top-0 font-bold">
                            <tr><th class="p-3 w-16 text-center">ID</th><th class="p-3 w-32">ë‹¨ì›</th><th class="p-3 w-20 text-center">ìœ í˜•</th><th class="p-3">ë¬¸ì œ (í´ë¦­í•˜ì—¬ ìˆ˜ì •)</th><th class="p-3 w-20 text-center">ë¯¸ë¦¬ë³´ê¸°</th><th class="p-3 w-32 col-answer text-center">ì •ë‹µ</th></tr>
                        </thead>
                        <tbody id="bank-body" class="bg-white"></tbody>
                    </table>
                </div>
            </div>

            <!-- íƒ­: ë¬¸ì œ ì¶”ê°€ -->
            <div id="tab-add" class="hidden">
                <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                    <div class="bg-stone-50 p-6 rounded border border-stone-200">
                        <div class="flex justify-between items-center mb-4 border-b pb-2"><h3 class="font-bold text-xl">ì§ì ‘ ë¬¸ì œ ë§Œë“¤ê¸°</h3><span id="next-q-id-display" class="bg-amber-100 text-amber-800 text-xs font-bold px-3 py-1 rounded-full border border-amber-200"></span></div>
                        <div class="space-y-4">
                            <div><label class="block text-sm font-bold mb-1">ë‹¨ì› ì„ íƒ</label><select id="new-q-unit" class="w-full p-2 border rounded bg-white"><option value="I. ë¬¸ëª…ì˜ ë°œìƒê³¼ ê³ ëŒ€ ì„¸ê³„ì˜ í˜•ì„±">I. ê³ ëŒ€ ì„¸ê³„</option><option value="II. ì„¸ê³„ ì¢…êµì˜ í™•ì‚°ê³¼ ì§€ì—­ ë¬¸í™”ì˜ í˜•ì„±">II. ì„¸ê³„ ì¢…êµ/ì§€ì—­ ë¬¸í™”</option><option value="III. ì§€ì—­ ì„¸ê³„ì˜ êµë¥˜ì™€ ë³€í™”">III. ì§€ì—­ ì„¸ê³„ êµë¥˜</option><option value="IV. ì œêµ­ì£¼ì˜ ì¹¨ëµê³¼ êµ­ë¯¼ êµ­ê°€ ê±´ì„¤ ìš´ë™">IV. ì œêµ­ì£¼ì˜/êµ­ë¯¼ êµ­ê°€</option><option value="V. ì„¸ê³„ ëŒ€ì „ê³¼ ì‚¬íšŒ ë³€ë™">V. ì„¸ê³„ ëŒ€ì „/ì‚¬íšŒ ë³€ë™</option></select></div>
                            <div><label class="block text-sm font-bold mb-1">ìœ í˜•</label><select id="new-q-type" class="w-full p-2 border rounded" onchange="app.toggleOptionInput('new')"><option value="choice">ê°ê´€ì‹</option><option value="word">ë‹¨ë‹µí˜•</option><option value="order">ìˆœì„œ ë§ì¶”ê¸°</option><option value="ox">O/X í€´ì¦ˆ</option></select></div>
                            <div>
                                <label class="block text-sm font-bold mb-1">ì´ë¯¸ì§€ (ì„ íƒ)</label>
                                <input type="file" id="new-q-image" accept="image/*" class="w-full text-xs p-2 border rounded bg-white" onchange="app.handleImageUpload(this, 'new')">
                                <p class="text-xs text-gray-500 mt-1">* ê³ í™”ì§ˆ ì´ë¯¸ì§€ëŠ” ìë™ìœ¼ë¡œ ìµœì í™”ë˜ì–´ ì €ì¥ë©ë‹ˆë‹¤.</p>
                                <img id="new-q-image-preview" class="hidden mt-2 h-20 rounded border border-gray-300">
                                <input type="hidden" id="new-q-image-base64">
                            </div>
                            <div><label class="block text-sm font-bold mb-1">ë¬¸ì œ</label><textarea id="new-q-text" class="w-full p-2 border rounded h-20"></textarea></div>
                            <div id="option-container-new"><label class="block text-sm font-bold mb-1">ë³´ê¸° (ì½¤ë§ˆë¡œ êµ¬ë¶„)</label><input type="text" id="new-q-options" class="w-full p-2 border rounded" placeholder="ì˜ˆ: A, B, C, D"></div>
                            <div><label class="block text-sm font-bold mb-1">ì •ë‹µ</label><input type="text" id="new-q-answer" class="w-full p-2 border rounded"></div>
                            <div><label class="block text-sm font-bold mb-1">í•´ì„¤</label><input type="text" id="new-q-exp" class="w-full p-2 border rounded"></div>
                            <button onclick="app.addCustomQuestion()" class="w-full bg-amber-600 text-white font-bold py-3 rounded hover:bg-amber-700 transition">ì¶”ê°€í•˜ê¸°</button>
                        </div>
                    </div>
                    <div class="bg-green-50 p-6 rounded border border-green-200 h-fit">
                        <h3 class="font-bold text-xl mb-4 border-b pb-2 text-green-800">ì—‘ì…€ ì¼ê´„ ì—…ë¡œë“œ</h3>
                        <p class="text-sm text-green-700 mb-4">ì—‘ì…€ íŒŒì¼ì„ ì—…ë¡œë“œí•˜ì—¬ ë¬¸ì œë¥¼ í•œ ë²ˆì— ì¶”ê°€í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.<br>* ê¸°ì¡´ ë¬¸ì œëŠ” ìœ ì§€ë˜ê³  ë²ˆí˜¸ê°€ ì´ì–´ì„œ ìƒì„±ë©ë‹ˆë‹¤.</p>
                        <input type="file" id="excel-file" accept=".xlsx, .xls" class="block w-full text-sm text-slate-500 file:mr-4 file:py-2 file:px-4 file:rounded-full file:border-0 file:text-sm file:font-semibold file:bg-green-100 file:text-green-700 hover:file:bg-green-200 mb-4"/>
                        <button onclick="app.uploadExcel()" class="w-full bg-green-600 text-white font-bold py-3 rounded hover:bg-green-700 transition shadow"><i class="fas fa-file-upload mr-1"></i> ì—‘ì…€ ì—…ë¡œë“œ ì‹œì‘</button>
                        <div class="mt-4 text-center"><button onclick="app.downloadTemplate()" class="text-xs text-gray-500 underline hover:text-blue-500">ì—‘ì…€ ì–‘ì‹ ë‹¤ìš´ë¡œë“œ</button></div>
                    </div>
                </div>
            </div>
        </section>

        <!-- ë¬¸ì œ ìˆ˜ì • ëª¨ë‹¬ -->
        <div id="edit-modal" class="fixed inset-0 z-50 hidden flex items-center justify-center">
            <div class="modal-overlay absolute inset-0" onclick="app.closeEditModal()"></div>
            <div class="bg-white p-6 rounded-lg shadow-xl z-10 w-full max-w-2xl mx-4 max-h-[90vh] overflow-y-auto">
                <h3 class="font-bold text-xl mb-4 border-b pb-2">ë¬¸ì œ ìˆ˜ì •</h3>
                <input type="hidden" id="edit-q-id">
                <div class="space-y-4">
                    <div><label class="block text-sm font-bold mb-1">ë‹¨ì›</label><select id="edit-q-unit" class="w-full p-2 border rounded"><option value="I. ë¬¸ëª…ì˜ ë°œìƒê³¼ ê³ ëŒ€ ì„¸ê³„ì˜ í˜•ì„±">I. ê³ ëŒ€ ì„¸ê³„</option><option value="II. ì„¸ê³„ ì¢…êµì˜ í™•ì‚°ê³¼ ì§€ì—­ ë¬¸í™”ì˜ í˜•ì„±">II. ì„¸ê³„ ì¢…êµ</option><option value="III. ì§€ì—­ ì„¸ê³„ì˜ êµë¥˜ì™€ ë³€í™”">III. ì§€ì—­ ì„¸ê³„</option><option value="IV. ì œêµ­ì£¼ì˜ ì¹¨ëµê³¼ êµ­ë¯¼ êµ­ê°€ ê±´ì„¤ ìš´ë™">IV. ì œêµ­ì£¼ì˜</option><option value="V. ì„¸ê³„ ëŒ€ì „ê³¼ ì‚¬íšŒ ë³€ë™">V. ì„¸ê³„ ëŒ€ì „</option></select></div>
                    <div><label class="block text-sm font-bold mb-1">ìœ í˜•</label><select id="edit-q-type" class="w-full p-2 border rounded" onchange="app.toggleOptionInput('edit')"><option value="choice">ê°ê´€ì‹</option><option value="word">ë‹¨ë‹µí˜•</option><option value="order">ìˆœì„œ ë§ì¶”ê¸°</option><option value="ox">O/X í€´ì¦ˆ</option></select></div>
                    <!-- ì´ë¯¸ì§€ ìˆ˜ì • -->
                    <div>
                        <label class="block text-sm font-bold mb-1">ì´ë¯¸ì§€ ìˆ˜ì •</label>
                        <input type="file" id="edit-q-image-input" accept="image/*" class="w-full text-xs p-2 border rounded" onchange="app.handleImageUpload(this, 'edit')">
                        <img id="edit-q-image-preview" class="hidden q-image-thumb mt-2">
                        <input type="hidden" id="edit-q-image-base64">
                        <button onclick="app.removeEditImage()" class="text-red-500 text-xs mt-1 hover:underline">ì´ë¯¸ì§€ ì‚­ì œ</button>
                    </div>
                    <div><label class="block text-sm font-bold mb-1">ë¬¸ì œ</label><textarea id="edit-q-text" class="w-full p-2 border rounded h-20"></textarea></div>
                    <div id="option-container-edit"><label class="block text-sm font-bold mb-1">ë³´ê¸° (ì½¤ë§ˆë¡œ êµ¬ë¶„)</label><input type="text" id="edit-q-options" class="w-full p-2 border rounded"></div>
                    <div><label class="block text-sm font-bold mb-1">ì •ë‹µ</label><input type="text" id="edit-q-answer" class="w-full p-2 border rounded"></div>
                    <div><label class="block text-sm font-bold mb-1">í•´ì„¤</label><input type="text" id="edit-q-exp" class="w-full p-2 border rounded"></div>
                    <div class="flex gap-2 pt-2"><button onclick="app.saveEditedQuestion()" class="flex-1 bg-green-600 text-white font-bold py-3 rounded hover:bg-green-700">ì €ì¥</button><button onclick="app.closeEditModal()" class="flex-1 bg-stone-200 text-stone-700 font-bold py-3 rounded hover:bg-stone-300">ì·¨ì†Œ</button></div>
                </div>
            </div>
        </div>

        <!-- ë¯¸ë¦¬ë³´ê¸° ëª¨ë‹¬ -->
        <div id="preview-modal" class="fixed inset-0 z-50 hidden flex items-center justify-center">
            <div class="modal-overlay absolute inset-0" onclick="document.getElementById('preview-modal').classList.add('hidden')"></div>
            <div class="bg-white p-8 rounded-lg shadow-2xl z-10 w-full max-w-lg mx-4 border-t-8 border-amber-500 max-h-[80vh] overflow-y-auto">
                <div class="flex justify-between items-center mb-4">
                    <span class="bg-stone-100 text-stone-600 text-xs font-bold px-2 py-1 rounded">ë¯¸ë¦¬ë³´ê¸° ëª¨ë“œ (ì‹¤ì œ ì‘ë™)</span>
                    <button onclick="document.getElementById('preview-modal').classList.add('hidden')" class="text-gray-400 hover:text-gray-600"><i class="fas fa-times"></i></button>
                </div>
                <div id="preview-content"></div>
                <div class="mt-6 text-center">
                     <button onclick="document.getElementById('preview-modal').classList.add('hidden')" class="bg-stone-200 px-4 py-2 rounded text-sm font-bold hover:bg-stone-300">ë‹«ê¸°</button>
                </div>
            </div>
        </div>

    </main>

    <footer class="bg-stone-100 py-6 mt-8 border-t border-stone-200 text-center">
        <p class="text-stone-400 text-xs font-bold font-mono">Copyright Â© ìš©ì‹ ì¤‘í•™êµ ì—­ì‚¬êµì‚¬ ë°©ì¬ì„. All rights reserved.</p>
    </footer>

    <script>
        const firebaseConfig = { apiKey: "AIzaSyAOlPQ5PFmL0zxmGrGcuEBnqBXisph7kPU", authDomain: "history-quiz-yongsin.firebaseapp.com", projectId: "history-quiz-yongsin", storageBucket: "history-quiz-yongsin.firebasestorage.app", messagingSenderId: "177587430482", appId: "1:177587430482:web:d79cc145c11e335cc3ab8b", measurementId: "G-LHN97D7R2R" };
        let db; try { if (!firebase.apps.length) { firebase.initializeApp(firebaseConfig); } db = firebase.firestore(); } catch(e) { alert("Firebase ì˜¤ë¥˜"); }

        /* ì´ˆê¸° ë¬¸ì œ ë¦¬ìŠ¤íŠ¸ ë¹„ì›€ */
        const defaultQuestions = []; 
        
        /* ì•”í˜¸í™” ì œê±°ëœ ë¹„ë°€ë²ˆí˜¸ */
        const TEACHER_PW = "19960423";

        const app = {
            state: { student:{}, questions:[], allQuestions:[], currentIndex:0, answers:{}, score:0, isTeacherMode:false, timer:null, timeLeft:60, isTimeOut:false, customBank:[], logs:[], isQuizActive: false },
            
            init: function() {
                const btnTeacher = document.getElementById('btn-teacher-mode');
                if(btnTeacher) btnTeacher.onclick = () => this.toggleTeacherMode();
                this.loadQuestionsFromFirebase();
            },
            
            goToMain: function() {
                if(this.state.isQuizActive) {
                    if(confirm("ì •ë§ ë¬¸ì œ ì‘ì‹œë¥¼ í¬ê¸°í•˜ê³  ë©”ì¸ í™”ë©´ìœ¼ë¡œ ì´ë™í•˜ê² ìŠµë‹ˆê¹Œ? ì´ë™ ì‹œ 5ë¶„ ê°„ ì¬ì‘ì‹œ ë¶ˆê°€í•©ë‹ˆë‹¤.")) {
                        this.state.isTimeOut = true; 
                        this.saveToFirebase(); 
                        this.showView('view-login');
                        this.state.isQuizActive = false;
                        clearInterval(this.state.timer);
                    }
                } else {
                    this.showView('view-login');
                }
            },

            showLoading: function(show) {
                document.getElementById('loading-overlay').style.display = show ? 'flex' : 'none';
            },
            
            openImageZoom: function(src) {
                const modal = document.getElementById('image-zoom-modal');
                const content = document.getElementById('image-zoom-content');
                content.src = src;
                modal.style.display = 'flex';
            },
            
            closeImageZoom: function() {
                document.getElementById('image-zoom-modal').style.display = 'none';
            },

            loadQuestionsFromFirebase: function() {
                if(!db) return;
                this.showLoading(true);
                db.collection("quiz_questions").get().then((querySnapshot) => {
                    const loadedData = [];
                    querySnapshot.forEach((doc) => {
                        let data = doc.data();
                        data.id = parseInt(doc.id); 
                        loadedData.push(data);
                    });
                    loadedData.sort((a, b) => a.id - b.id);
                    this.state.allQuestions = loadedData;
                    console.log("ë¬¸ì œ ë¡œë“œ ì™„ë£Œ:", loadedData.length);
                    this.showLoading(false);
                    if(this.state.isTeacherMode) this.renderBank();
                }).catch((error) => {
                    console.error("ë¬¸ì œ ë¡œë“œ ì‹¤íŒ¨:", error);
                    this.showLoading(false);
                    this.state.allQuestions = [];
                });
            },

            startQuiz: async function() {
                const cls = document.getElementById('input-class').value;
                const num = document.getElementById('input-number').value;
                const name = document.getElementById('input-name').value.trim();
                if(!cls || !num || !name) { alert("ì •ë³´ë¥¼ ëª¨ë‘ ì…ë ¥í•˜ì„¸ìš”."); return; }
                
                this.showLoading(true);
                
                try {
                    const logsRef = db.collection("quiz_results");
                    const snapshot = await logsRef
                        .where("class", "==", cls)
                        .where("number", "==", num)
                        .where("name", "==", name)
                        .get();

                    let recentSubmission = null;
                    snapshot.forEach(doc => {
                        const data = doc.data();
                        if (data.timestamp) {
                            const date = data.timestamp.toDate();
                            if (!recentSubmission || date > recentSubmission) {
                                recentSubmission = date;
                            }
                        }
                    });

                    if (recentSubmission) {
                        const now = new Date();
                        const diffMs = now - recentSubmission;
                        const diffMins = diffMs / (1000 * 60);
                        if (diffMins < 5) {
                            this.showLoading(false);
                            const waitTime = Math.ceil(5 - diffMins);
                            alert(`ì´ë¯¸ ì œì¶œí•˜ì…¨ìŠµë‹ˆë‹¤.\n${waitTime}ë¶„ ë’¤ì— ë‹¤ì‹œ ì‹œë„í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.`);
                            return;
                        }
                    }
                } catch(e) { console.error("ì¤‘ë³µ ì²´í¬ ì˜¤ë¥˜:", e); }
                
                this.showLoading(false);
                this.state.student = { class:cls, number:num, name:name };
                if(this.state.allQuestions.length === 0) { alert("ë¬¸ì œê°€ ì—†ìŠµë‹ˆë‹¤. ì„ ìƒë‹˜ê»˜ ë¬¸ì˜í•˜ì„¸ìš”."); return; }
                const unitGroups = {}; this.state.allQuestions.forEach(q => { const u = q.unit || "ê¸°íƒ€"; if(!unitGroups[u]) unitGroups[u] = []; unitGroups[u].push(q); });
                const targetUnits = ["I. ë¬¸ëª…ì˜ ë°œìƒê³¼ ê³ ëŒ€ ì„¸ê³„ì˜ í˜•ì„±", "II. ì„¸ê³„ ì¢…êµì˜ í™•ì‚°ê³¼ ì§€ì—­ ë¬¸í™”ì˜ í˜•ì„±", "III. ì§€ì—­ ì„¸ê³„ì˜ êµë¥˜ì™€ ë³€í™”", "IV. ì œêµ­ì£¼ì˜ ì¹¨ëµê³¼ êµ­ë¯¼ êµ­ê°€ ê±´ì„¤ ìš´ë™", "V. ì„¸ê³„ ëŒ€ì „ê³¼ ì‚¬íšŒ ë³€ë™"];
                const selectedQuestions = []; const usedIds = new Set();
                targetUnits.forEach(u => { if(unitGroups[u] && unitGroups[u].length > 0) { const randIdx = Math.floor(Math.random() * unitGroups[u].length); const q = unitGroups[u][randIdx]; selectedQuestions.push(q); usedIds.add(q.id); } });
                if (selectedQuestions.length < 5) { const remainingPool = this.state.allQuestions.filter(q => !usedIds.has(q.id)); const shuffledRemaining = this.shuffleArray(remainingPool); const needed = 5 - selectedQuestions.length; for(let i=0; i<needed; i++) { if(shuffledRemaining[i]) selectedQuestions.push(shuffledRemaining[i]); } }
                this.state.questions = this.shuffleArray(selectedQuestions);
                this.state.currentIndex = 0; this.state.answers = {}; this.state.score = 0; this.state.timeLeft = 60; this.state.isTimeOut = false;
                this.state.isQuizActive = true; 
                this.showView('view-quiz'); this.renderQuestion(); this.startTimer();
            },
            
            shuffleArray: function(array) { for (let i = array.length - 1; i > 0; i--) { const j = Math.floor(Math.random() * (i + 1)); [array[i], array[j]] = [array[j], array[i]]; } return array; },
            startTimer: function() { if(this.state.timer) clearInterval(this.state.timer); const bar = document.getElementById('timer-bar'), txt = document.getElementById('timer-text'); bar.style.width='100%'; bar.classList.remove('timer-urgent'); txt.innerText='60ì´ˆ'; this.state.timer = setInterval(() => { this.state.timeLeft--; txt.innerText = this.state.timeLeft + 'ì´ˆ'; bar.style.width = (this.state.timeLeft/60)*100 + '%'; if(this.state.timeLeft<=10) { bar.classList.add('timer-urgent'); txt.classList.add('animate-pulse'); } if(this.state.timeLeft<=0) { clearInterval(this.state.timer); this.state.isTimeOut=true; alert("ì‹œê°„ ì¢…ë£Œ!"); this.finishQuiz(); } }, 1000); },
            
            renderQuestion: function() {
                const q = this.state.questions[this.state.currentIndex];
                document.getElementById('quiz-progress-text').innerText = `${this.state.currentIndex+1}/5`;
                document.getElementById('question-badge').innerText = {'choice':'ê°ê´€ì‹','blank':'ë‹¨ë‹µ','word':'ë‹¨ë‹µ','order':'ìˆœì„œ','ox':'O/X'}[q.type] || 'ë¬¸ì œ';
                document.getElementById('student-question-unit').innerText = q.unit || "ê¸°íƒ€";
                const imgArea = document.getElementById('question-image-area'); const imgTag = document.getElementById('question-image');
                if (q.image) { imgTag.src = q.image; imgArea.classList.remove('hidden'); } else { imgArea.classList.add('hidden'); }
                document.getElementById('question-text').innerText = q.question;
                const area = document.getElementById('answer-area'); area.innerHTML = ''; 
                this.tempAnswer = this.state.answers[q.id] || null; 
                document.getElementById('btn-prev').classList.toggle('hidden', this.state.currentIndex === 0);
                document.getElementById('btn-next').className = this.state.currentIndex === 0 ? "w-full bg-amber-600 text-white font-bold py-4 rounded-lg hover:bg-amber-700 transition shadow-md" : "w-2/3 bg-amber-600 text-white font-bold py-4 rounded-lg hover:bg-amber-700 transition shadow-md";

                if(q.type === 'choice') {
                    const grid = document.createElement('div'); grid.className="grid grid-cols-1 gap-3";
                    q.options.forEach((opt,i) => {
                        const btn = document.createElement('button');
                        const isSelected = (this.tempAnswer === opt);
                        btn.className = isSelected ? "w-full text-left p-4 rounded border-2 border-amber-600 bg-amber-600 text-white font-bold shadow-sm" : "w-full text-left p-4 rounded border border-stone-200 hover:bg-stone-50 bg-white";
                        const spanClass = isSelected ? "w-6 h-6 rounded-full bg-white text-amber-600 inline-flex items-center justify-center text-xs font-bold mr-3" : "w-6 h-6 rounded-full bg-stone-200 inline-flex items-center justify-center text-xs font-bold mr-3";
                        btn.innerHTML = `<span class="${spanClass}">${i+1}</span> ${opt}`;
                        btn.onclick = () => {
                            Array.from(grid.children).forEach(c => {
                                c.className = "w-full text-left p-4 rounded border border-stone-200 bg-white";
                                c.querySelector('span').className = "w-6 h-6 rounded-full bg-stone-200 inline-flex items-center justify-center text-xs font-bold mr-3";
                            });
                            btn.className = "w-full text-left p-4 rounded border-2 border-amber-600 bg-amber-600 text-white font-bold shadow-sm";
                            btn.querySelector('span').className = "w-6 h-6 rounded-full bg-white text-amber-600 inline-flex items-center justify-center text-xs font-bold mr-3";
                            this.tempAnswer = opt;
                        };
                        grid.appendChild(btn);
                    });
                    area.appendChild(grid);
                } else if(q.type === 'ox') {
                    const box = document.createElement('div'); box.className="flex gap-4 h-40";
                    const btnO = document.createElement('button'); btnO.className="flex-1 ox-btn btn-o"; btnO.innerText="O";
                    if(this.tempAnswer==='O') btnO.classList.add('selected');
                    const btnX = document.createElement('button'); btnX.className="flex-1 ox-btn btn-x"; btnX.innerText="X";
                    if(this.tempAnswer==='X') btnX.classList.add('selected');
                    btnO.onclick=()=>{this.tempAnswer='O'; btnO.classList.add('selected'); btnX.classList.remove('selected');};
                    btnX.onclick=()=>{this.tempAnswer='X'; btnX.classList.add('selected'); btnO.classList.remove('selected');};
                    box.append(btnO,btnX); area.appendChild(box);
                } else if(q.type === 'order') {
                    this.orderTemp = this.tempAnswer ? this.tempAnswer.split('-') : [];
                    const box = document.createElement('div'); box.className="border-2 dashed border-amber-300 rounded p-4 mb-3 bg-amber-50 min-h-[50px] flex flex-wrap gap-2";
                    const opts = document.createElement('div'); opts.className="flex flex-wrap gap-2";
                    const renderButton = (text, isSelected) => { const btn = document.createElement('button'); btn.innerText = text; if (isSelected) btn.className = "seq-btn seq-btn-selected"; else btn.className = "seq-btn seq-btn-default"; return btn; };
                    this.orderTemp.forEach(opt => { const btn = renderButton(opt, true); btn.onclick = () => { opts.appendChild(btn); btn.className = "seq-btn seq-btn-default"; this.orderTemp = this.orderTemp.filter(x=>x!==opt); }; box.appendChild(btn); });
                    q.options.filter(o => !this.orderTemp.includes(o)).sort(()=>0.5-Math.random()).forEach(opt => { const btn = renderButton(opt, false); btn.onclick = () => { if(btn.parentElement===opts) { box.appendChild(btn); btn.className = "seq-btn seq-btn-selected"; this.orderTemp.push(opt); } else { opts.appendChild(btn); btn.className = "seq-btn seq-btn-default"; this.orderTemp = this.orderTemp.filter(x=>x!==opt); } }; opts.appendChild(btn); });
                    area.append(box, opts);
                } else {
                    const inp = document.createElement('input'); inp.type="text"; inp.className="w-full p-4 border-b-2 border-stone-300 focus:border-amber-500 text-center text-lg outline-none";
                    inp.placeholder="ì •ë‹µ ì…ë ¥"; if(this.tempAnswer) inp.value = this.tempAnswer;
                    inp.oninput = (e) => this.tempAnswer=e.target.value;
                    inp.onkeydown = (e) => { if(e.key==='Enter') this.submitAnswer(); };
                    area.appendChild(inp);
                }
            },
            prevQuestion: function() { const q = this.state.questions[this.state.currentIndex]; if (q.type === 'order') { if (this.orderTemp && this.orderTemp.length > 0) this.state.answers[q.id] = this.orderTemp.join('-'); } else { if (this.tempAnswer) this.state.answers[q.id] = this.tempAnswer; } if (this.state.currentIndex > 0) { this.state.currentIndex--; this.renderQuestion(); } },
            submitAnswer: function() { const q = this.state.questions[this.state.currentIndex]; let ans = this.tempAnswer; if(q.type==='order') { if(!this.orderTemp || this.orderTemp.length !== q.options.length) { alert("ìˆœì„œë¥¼ ì™„ì„±í•˜ì„¸ìš”"); return; } ans = this.orderTemp.join('-'); } else if(!ans) { alert("ì •ë‹µì„ ì…ë ¥í•˜ì„¸ìš”"); return; } this.state.answers[q.id] = ans; if(this.state.currentIndex < 4) { this.state.currentIndex++; this.renderQuestion(); } else this.finishQuiz(); },
            finishQuiz: function() { clearInterval(this.state.timer); this.state.isQuizActive = false; let correct = 0; let details = []; this.state.questions.forEach(q => { const u = (this.state.answers[q.id]||"").toString().replace(/\s+/g,'').trim(); const a = q.answer.toString().replace(/\s+/g,'').trim(); let isC = false; if (q.type === 'word' || q.type === 'blank') isC = (u.includes(a)||a.includes(u)); else isC = (u === a); if(isC) correct++; else details.push({q:q.question, u:u||"ë¯¸ì…ë ¥", a:q.answer, exp:q.explanation}); }); this.state.score = correct * 20; this.state.incorrectDetails = details; this.showView('view-results'); this.renderResults(); this.saveToFirebase(); },
            renderResults: function() { document.getElementById('result-name').innerText = this.state.student.name; document.getElementById('score-text').innerText = this.state.score; const ctx = document.getElementById('scoreChart').getContext('2d'); if(window.myChart) window.myChart.destroy(); window.myChart = new Chart(ctx, { type:'doughnut', data:{labels:['ì •ë‹µ','ì˜¤ë‹µ'], datasets:[{data:[this.state.score, 100-this.state.score], backgroundColor:['#d97706','#e5e7eb'], borderWidth:0}]}, options:{cutout:'80%', plugins:{legend:{display:false}}} }); const list = document.getElementById('review-list'); list.innerHTML = this.state.incorrectDetails.length===0 ? '<div class="text-center py-4">ë§Œì ì…ë‹ˆë‹¤! ğŸ‰</div>' : this.state.incorrectDetails.map(d => `<div class="border-b pb-3 last:border-0"><p class="font-bold text-stone-800 mb-1">Q. ${d.q}</p><div class="flex gap-2 text-xs mb-2"><span class="text-red-600 bg-red-50 px-2 py-1 rounded">ë‚´ ë‹µ: ${d.u}</span><span class="text-green-600 bg-green-50 px-2 py-1 rounded font-bold">ì •ë‹µ: ${d.a}</span></div><p class="text-xs text-stone-500 bg-stone-50 p-2 rounded">${d.exp}</p></div>`).join(''); },
            saveToFirebase: function() { const status = document.getElementById('submission-status'); if(!db) { status.innerHTML = "âš ï¸ DB ì—°ê²° ì‹¤íŒ¨"; return; } const data = { timestamp: firebase.firestore.FieldValue.serverTimestamp(), timeString: new Date().toLocaleString(), class: this.state.student.class, number: this.state.student.number, name: this.state.student.name, score: this.state.score, status: this.state.isTimeOut ? "ì‹œê°„ì´ˆê³¼" : "ì™„ë£Œ" }; db.collection("quiz_results").add(data).then(() => { status.className = "bg-green-100 text-green-700 p-3 rounded text-sm mb-6 border border-green-200 font-bold"; status.innerHTML = '<i class="fas fa-check-circle"></i> ì œì¶œ ì™„ë£Œ!'; }).catch((error) => { console.error("Error: ", error); status.className = "bg-red-100 text-red-700 p-3 rounded text-sm mb-6 border border-red-200"; status.innerHTML = 'âš ï¸ ì „ì†¡ ì‹¤íŒ¨. (ë„¤íŠ¸ì›Œí¬ í™•ì¸)'; }); },
            
            toggleTeacherMode: function() {
                if(this.state.isTeacherMode) { this.closeTeacherMode(); return; }
                const pw = prompt("êµì‚¬ìš© ë¹„ë°€ë²ˆí˜¸:");
                if(pw === TEACHER_PW) { this.state.isTeacherMode=true; this.showView('view-teacher'); this.loadLogs(); }
                else if(pw!==null) alert("ë¹„ë°€ë²ˆí˜¸ ì˜¤ë¥˜");
            },
            closeTeacherMode: function() { this.state.isTeacherMode=false; this.showView('view-login'); },
            showView: function(id) { document.querySelectorAll('main > section').forEach(el => el.classList.add('hidden')); document.getElementById(id).classList.remove('hidden'); window.scrollTo(0,0); },
            toggleReview: function() { document.getElementById('review-section').classList.toggle('hidden'); },
            setTeacherTab: function(tab) {
                ['log','bank','add'].forEach(t => document.getElementById('tab-'+t).classList.add('hidden'));
                document.getElementById('tab-'+tab).classList.remove('hidden');
                ['log','bank','add'].forEach(t => { const btn = document.getElementById('btn-tab-'+t); if(t===tab) btn.className = "px-5 py-2 rounded-full bg-stone-800 text-white text-sm font-bold shadow transition"; else btn.className = "px-5 py-2 rounded-full bg-stone-100 text-stone-600 text-sm font-bold hover:bg-stone-200 shadow transition"; });
                if(tab === 'log') this.loadServerLogs(); else if (tab === 'add') this.updateNextQuestionNumber(); else this.renderBank();
            },
            loadServerLogs: function() { if(!db) return; const tbody = document.getElementById('teacher-log-body'); tbody.innerHTML = '<tr><td colspan="5" class="p-4 text-center">ë¡œë”© ì¤‘...</td></tr>'; db.collection("quiz_results").orderBy("timestamp", "desc").limit(100).get().then((querySnapshot) => { let logs = []; querySnapshot.forEach((doc) => { let d = doc.data(); d.docId = doc.id; logs.push(d); }); this.state.logs = logs; this.renderLogs(); document.getElementById('log-count').innerText = `(ìµœê·¼ ${logs.length}ê±´)`; }); },
            renderLogs: function() { const clsFilter = document.getElementById('filter-class').value; const tbody = document.getElementById('teacher-log-body'); let filtered = this.state.logs; if (clsFilter !== 'all') filtered = filtered.filter(l => l.class === clsFilter); if (filtered.length === 0) { tbody.innerHTML = '<tr><td colspan="5" class="p-4 text-center">ê¸°ë¡ ì—†ìŒ</td></tr>'; } else { let html = ''; filtered.forEach((d) => { html += `<tr class="border-b hover:bg-stone-50"><td class="p-3 text-stone-500 text-xs">${d.timeString}</td><td class="p-3 font-medium">${d.class}ë°˜ ${d.number}ë²ˆ ${d.name}</td><td class="p-3 font-bold text-amber-600">${d.score}</td><td class="p-3 text-xs">${d.status}</td><td class="p-3 text-center"><button onclick="app.deleteLog('${d.docId}')" class="text-red-500 hover:text-red-700"><i class="fas fa-trash-alt"></i></button></td></tr>`; }); tbody.innerHTML = html; } },
            deleteLog: function(docId) { if(confirm("ì‚­ì œ?")) db.collection("quiz_results").doc(docId).delete().then(() => this.loadServerLogs()); },
            downloadExcel: function() { if(!this.state.logs || !this.state.logs.length) { alert("ë°ì´í„°ê°€ ì—†ìŠµë‹ˆë‹¤."); return; } let csv = "\uFEFFì‹œê°„,ë°˜,ë²ˆí˜¸,ì´ë¦„,ì ìˆ˜,ìƒíƒœ\n" + this.state.logs.map(l => `${l.timeString},${l.class},${l.number},${l.name},${l.score},${l.status}`).join("\n"); const link = document.createElement("a"); link.href = "data:text/csv;charset=utf-8," + encodeURI(csv); link.download = "ì—­ì‚¬í‰ê°€_ê²°ê³¼.csv"; link.click(); },
            
            renderBank: function() {
                let filtered = [...this.state.allQuestions];
                const unitFilter = document.getElementById('bank-filter-unit').value; if (unitFilter !== 'all') filtered = filtered.filter(q => (q.unit || "").startsWith(unitFilter));
                const sortType = document.getElementById('bank-sort').value; if (sortType === 'id') filtered.sort((a, b) => a.id - b.id); else if (sortType === 'unit') filtered.sort((a, b) => (a.unit || "").localeCompare(b.unit || "")); else if (sortType === 'type') filtered.sort((a, b) => a.type.localeCompare(b.type));
                document.getElementById('total-q-count').innerText = `(${filtered.length}ë¬¸í•­)`;
                document.getElementById('bank-body').innerHTML = filtered.map(q => `<tr class="border-b hover:bg-stone-50"><td class="p-3 text-xs text-stone-400 font-mono text-center">${q.id}</td><td class="p-3"><div class="text-xs text-gray-500 mb-1">${q.unit || 'ê¸°íƒ€'}</div></td><td class="p-3 text-center"><span class="bg-stone-100 border px-1 rounded text-xs">${{'choice':'ê°ê´€','word':'ë‹¨ë‹µ','order':'ìˆœì„œ','ox':'O/X'}[q.type]}</span></td><td class="p-3 text-sm text-stone-800 hover:text-blue-600 font-medium break-words max-w-xs border-r border-stone-300 cursor-pointer" onclick="app.editQuestion(${q.id})">${q.question}</td><td class="p-3 text-center"><button onclick="app.previewQuestion(${q.id})" class="text-stone-400 hover:text-amber-600"><i class="fas fa-eye"></i></button></td><td class="p-3 text-xs font-bold text-amber-700 col-answer text-center">${q.answer}</td></tr>`).join('');
            },
            
            previewQuestion: function(id) {
                const q = this.state.allQuestions.find(x => x.id === id);
                if(!q) return;
                const tempContainer = document.getElementById('preview-content');
                tempContainer.innerHTML = `<div class="mb-2"><span class="bg-amber-100 text-amber-800 text-xs font-bold px-2 py-1 rounded">${{'choice':'ê°ê´€ì‹','word':'ë‹¨ë‹µí˜•','order':'ìˆœì„œ ë§ì¶”ê¸°','ox':'O/X'}[q.type]}</span></div>${q.image ? `<img src="${q.image}" class="q-image-thumb" onclick="app.openImageZoom(this.src)">` : ''}<h3 class="text-xl font-bold mb-4">${q.question}</h3><div id="preview-answer-area"></div>`;
                const area = document.getElementById('preview-answer-area');
                if(q.type === 'choice') { const grid = document.createElement('div'); grid.className="grid grid-cols-1 gap-2"; q.options.forEach((opt,i) => { const btn = document.createElement('div'); btn.className = "w-full text-left p-3 rounded border border-stone-200 bg-white flex items-center cursor-pointer hover:bg-stone-100"; btn.innerHTML = `<span class="w-6 h-6 rounded-full bg-stone-200 inline-flex items-center justify-center text-xs font-bold mr-3">${i+1}</span> ${opt}`; btn.onclick = function() { Array.from(grid.children).forEach(c => c.className = "w-full text-left p-3 rounded border border-stone-200 bg-white flex items-center cursor-pointer hover:bg-stone-100"); this.className = "w-full text-left p-3 rounded border-2 border-amber-600 bg-amber-600 text-white font-bold shadow-sm flex items-center cursor-pointer"; if(opt === q.answer) alert("ì •ë‹µì…ë‹ˆë‹¤! (ë¯¸ë¦¬ë³´ê¸°)"); else alert("ì˜¤ë‹µì…ë‹ˆë‹¤. (ë¯¸ë¦¬ë³´ê¸°)"); }; grid.appendChild(btn); }); area.appendChild(grid); } 
                else if(q.type === 'ox') { area.innerHTML = `<div class="flex gap-4 h-20"><button class="flex-1 ox-btn btn-o" onclick="alert(this.innerText==='${q.answer}'?'ì •ë‹µ!':'ì˜¤ë‹µ!')">O</button><button class="flex-1 ox-btn btn-x" onclick="alert(this.innerText==='${q.answer}'?'ì •ë‹µ!':'ì˜¤ë‹µ!')">X</button></div>`; } 
                else if(q.type === 'order') { area.innerHTML = `<div class="flex flex-wrap gap-2 mb-2 text-xs text-gray-500">* ë¯¸ë¦¬ë³´ê¸°ì—ì„œëŠ” ìˆœì„œ í´ë¦­ë§Œ ê°€ëŠ¥í•©ë‹ˆë‹¤.</div><div class="flex flex-wrap gap-2">${q.options.map(o=>`<button class="px-2 py-1 bg-white border rounded text-sm hover:bg-amber-100">${o}</button>`).join('')}</div>`; } 
                else { area.innerHTML = `<input type="text" class="w-full p-3 border-b-2 border-stone-300 text-center" placeholder="ì •ë‹µ ì…ë ¥ (ì—”í„°ë¡œ í™•ì¸)" onkeydown="if(event.key==='Enter') alert(this.value.replace(/\\s+/g,'')==='${q.answer.replace(/\s+/g,'')}'?'ì •ë‹µ!':'ì˜¤ë‹µ!')">`; }
                document.getElementById('preview-modal').classList.remove('hidden');
            },
            editQuestion: function(id) {
                const q = this.state.allQuestions.find(q => q.id === id); if(!q) return;
                document.getElementById('edit-q-id').value = q.id; document.getElementById('edit-q-unit').value = q.unit; document.getElementById('edit-q-type').value = q.type; document.getElementById('edit-q-text').value = q.question; document.getElementById('edit-q-answer').value = q.answer; document.getElementById('edit-q-exp').value = q.explanation;
                this.toggleOptionInput('edit'); if (q.options) document.getElementById('edit-q-options').value = q.options.join(', '); else document.getElementById('edit-q-options').value = '';
                const imgPreview = document.getElementById('edit-q-image-preview'); const imgInput = document.getElementById('edit-q-image-input'); const imgBase64 = document.getElementById('edit-q-image-base64');
                imgInput.value = ''; if(q.image) { imgPreview.src = q.image; imgPreview.classList.remove('hidden'); imgBase64.value = q.image; } else { imgPreview.classList.add('hidden'); imgBase64.value = ''; }
                document.getElementById('edit-modal').classList.remove('hidden');
            },
            closeEditModal: function() { document.getElementById('edit-modal').classList.add('hidden'); },
            removeEditImage: function() { document.getElementById('edit-q-image-preview').classList.add('hidden'); document.getElementById('edit-q-image-base64').value = ''; document.getElementById('edit-q-image-input').value = ''; },
            saveEditedQuestion: function() {
                this.showLoading(true); const id = parseInt(document.getElementById('edit-q-id').value); const unit = document.getElementById('edit-q-unit').value; const type = document.getElementById('edit-q-type').value; const text = document.getElementById('edit-q-text').value; const answer = document.getElementById('edit-q-answer').value; const exp = document.getElementById('edit-q-exp').value; const optText = document.getElementById('edit-q-options').value; const image = document.getElementById('edit-q-image-base64').value || null;
                let options = null; if (type === 'choice' || type === 'order') options = optText.split(',').map(s => s.trim());
                const updatedQ = { id, unit, type, question: text, options, answer, explanation: exp, image };
                db.collection("quiz_questions").doc(String(id)).set(updatedQ).then(() => { this.showLoading(false); alert("ìˆ˜ì •ë˜ì—ˆìŠµë‹ˆë‹¤."); this.closeEditModal(); this.loadQuestionsFromFirebase(); }).catch(e => { this.showLoading(false); alert("ìˆ˜ì • ì‹¤íŒ¨: " + e); });
            },
            toggleOptionInput: function(prefix) { const t = document.getElementById(prefix + '-q-type').value; document.getElementById('option-container-' + prefix).classList.toggle('hidden', !(t==='choice'||t==='order')); },
            updateNextQuestionNumber: function() { const maxId = this.state.allQuestions.reduce((max, item) => Math.max(max, item.id), 0); const nextId = maxId + 1; document.getElementById('next-q-id-display').innerText = `í˜„ì¬ ${nextId}ë²ˆ ë¬¸ì œ ìƒì„± ì¤‘`; },
            handleImageUpload: function(input, prefix) {
                if (input.files && input.files[0]) {
                    const file = input.files[0]; const reader = new FileReader();
                    reader.onload = function(e) {
                        const img = new Image(); img.src = e.target.result;
                        img.onload = function() {
                            const canvas = document.createElement('canvas'); const ctx = canvas.getContext('2d');
                            const MAX_WIDTH = 1024; let width = img.width; let height = img.height;
                            if (width > MAX_WIDTH) { height *= MAX_WIDTH / width; width = MAX_WIDTH; }
                            canvas.width = width; canvas.height = height; ctx.drawImage(img, 0, 0, width, height);
                            const dataUrl = canvas.toDataURL('image/jpeg', 0.8);
                            document.getElementById(prefix + '-q-image-base64').value = dataUrl; const preview = document.getElementById(prefix + '-q-image-preview'); preview.src = dataUrl; preview.classList.remove('hidden');
                        }
                    }
                    reader.readAsDataURL(file);
                }
            },
            addCustomQuestion: function() {
                const unit = document.getElementById('new-q-unit').value; const t = document.getElementById('new-q-type').value; const q = document.getElementById('new-q-text').value.trim(); const a = document.getElementById('new-q-answer').value.trim(); const e = document.getElementById('new-q-exp').value.trim(); const img = document.getElementById('new-q-image-base64').value || null; let o = [];
                if(!q || !a) { alert("í•„ìˆ˜ ì…ë ¥"); return; } if(t==='choice'||t==='order') { const ot = document.getElementById('new-q-options').value.trim(); if(!ot) { alert("ë³´ê¸°ë¥¼ ì…ë ¥í•˜ì„¸ìš”."); return; } o = ot.split(',').map(s=>s.trim()); }
                this.showLoading(true); const maxId = this.state.allQuestions.reduce((max, item) => Math.max(max, item.id), 0); const newId = maxId + 1;
                const newQ = { id: newId, unit: unit, type: t, question: q, options: o.length ? o : null, answer: a, explanation: e || "í•´ì„¤ ì—†ìŒ", image: img };
                db.collection("quiz_questions").doc(String(newId)).set(newQ).then(() => { this.showLoading(false); alert("ì¶”ê°€ë˜ì—ˆìŠµë‹ˆë‹¤."); document.getElementById('new-q-text').value = ''; document.getElementById('new-q-options').value = ''; document.getElementById('new-q-answer').value = ''; document.getElementById('new-q-exp').value = ''; document.getElementById('new-q-image').value = ''; document.getElementById('new-q-image-preview').classList.add('hidden'); document.getElementById('new-q-image-base64').value = ''; this.loadQuestionsFromFirebase(); this.updateNextQuestionNumber(); }).catch(err => { this.showLoading(false); alert("ì €ì¥ ì‹¤íŒ¨: " + err); });
            },
            resetServerQuestions: function() {
                if(confirm("ëª¨ë“  ë¬¸ì œë¥¼ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ? (ë³µêµ¬ ë¶ˆê°€)")) { 
                    this.showLoading(true); db.collection("quiz_questions").get().then(snapshot => { const batch = db.batch(); snapshot.docs.forEach(doc => batch.delete(doc.ref)); return batch.commit(); }).then(() => { this.showLoading(false); alert("ì´ˆê¸°í™”ë˜ì—ˆìŠµë‹ˆë‹¤."); this.state.allQuestions = []; this.renderBank(); }).catch(e => { this.showLoading(false); alert("ì´ˆê¸°í™” ì‹¤íŒ¨: " + e); });
                }
            },
            downloadTemplate: function() {
                const ws_data = [["ë‹¨ì›", "ìœ í˜•", "ë¬¸ì œ", "ë³´ê¸°(ì½¤ë§ˆë¡œ êµ¬ë¶„)", "ì •ë‹µ", "í•´ì„¤"], ["I. ë¬¸ëª…ì˜ ë°œìƒ...", "choice", "ë‹¤ìŒ ì¤‘...", "ë³´ê¸°1, ë³´ê¸°2, ë³´ê¸°3", "ë³´ê¸°1", "í•´ì„¤ì…ë‹ˆë‹¤."]];
                const ws = XLSX.utils.aoa_to_sheet(ws_data); const wb = XLSX.utils.book_new(); XLSX.utils.book_append_sheet(wb, ws, "ë¬¸ì œì–‘ì‹"); XLSX.writeFile(wb, "ë¬¸ì œì—…ë¡œë“œ_ì–‘ì‹.xlsx");
            },
            uploadExcel: function() {
                const fileInput = document.getElementById('excel-file'); if(!fileInput.files.length) { alert("íŒŒì¼ì„ ì„ íƒí•´ì£¼ì„¸ìš”."); return; } this.showLoading(true); const file = fileInput.files[0]; const reader = new FileReader();
                reader.onload = (e) => {
                    try {
                        const data = new Uint8Array(e.target.result); const workbook = XLSX.read(data, {type: 'array'}); const firstSheet = workbook.Sheets[workbook.SheetNames[0]]; const jsonData = XLSX.utils.sheet_to_json(firstSheet, {header: 1});
                        let batch = db.batch(); let count = 0; let currentId = this.state.allQuestions.reduce((max, item) => Math.max(max, item.id), 0);
                        for(let i=1; i<jsonData.length; i++) {
                            const row = jsonData[i]; if(!row[2] || !row[4]) continue; 
                            currentId++; const newQ = { id: currentId, unit: row[0] || "ê¸°íƒ€", type: row[1] || "word", question: row[2], options: row[3] ? row[3].split(',').map(s=>s.trim()) : null, answer: row[4], explanation: row[5] || "í•´ì„¤ ì—†ìŒ", image: null };
                            const docRef = db.collection("quiz_questions").doc(String(currentId)); batch.set(docRef, newQ); count++;
                        }
                        batch.commit().then(() => { this.showLoading(false); alert(count + "ê°œ ë¬¸ì œê°€ ì¶”ê°€ë˜ì—ˆìŠµë‹ˆë‹¤."); this.loadQuestionsFromFirebase(); fileInput.value = ""; }).catch(err => { this.showLoading(false); alert("ì—…ë¡œë“œ ì¤‘ ì˜¤ë¥˜: " + err); });
                    } catch(err) { this.showLoading(false); alert("ì—‘ì…€ ì½ê¸° ì‹¤íŒ¨: " + err); }
                };
                reader.readAsArrayBuffer(file);
            }
        };

        window.app = app;
        window.onload = function() { app.init(); };
    </script>
</body>
</html>
