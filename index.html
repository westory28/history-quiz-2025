<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ìš©ì‹ ì¤‘í•™êµ 2í•™ë…„ 2í•™ê¸° ì—­ì‚¬1 í˜•ì„±í‰ê°€</title>
    
    <!-- í•„ìˆ˜ ë¼ì´ë¸ŒëŸ¬ë¦¬ -->
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    
    <!-- Firebase SDK -->
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-firestore.js"></script>

    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+KR:wght@400;500;700&family=Noto+Serif+KR:wght@700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">

    <style>
        body { font-family: 'Noto Sans KR', sans-serif; background-color: #f5f5f4; }
        .serif { font-family: 'Noto Serif KR', serif; }
        .fade-in { animation: fadeIn 0.3s ease-in-out; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(5px); } to { opacity: 1; transform: translateY(0); } }
        
        .timer-bar { transition: width 1s linear; }
        .timer-urgent { background-color: #ef4444 !important; animation: pulse 1s infinite; }
        @keyframes pulse { 0%, 100% { opacity: 1; } 50% { opacity: 0.5; } }

        .teacher-btn {
            background-color: #44403c; color: white; padding: 6px 12px;
            border-radius: 8px; font-size: 0.85rem; font-weight: bold;
            display: flex; align-items: center; gap: 6px; cursor: pointer;
            border: 1px solid #57534e; z-index: 9999;
        }
        .teacher-btn:hover { background-color: #292524; }
    </style>
</head>
<body class="text-stone-800 min-h-screen flex flex-col">

    <!-- ìƒë‹¨ í—¤ë” -->
    <header class="bg-stone-900 text-white py-4 shadow-lg sticky top-0 z-50">
        <div class="container mx-auto px-4 flex justify-between items-center relative">
            <h1 class="text-lg md:text-xl font-bold tracking-tight truncate pr-2">
                <i class="fas fa-history text-amber-500 mr-2"></i>ìš©ì‹ ì¤‘í•™êµ 2í•™ë…„ 2í•™ê¸° ì—­ì‚¬1
            </h1>
            <button id="btn-teacher-mode" class="teacher-btn">
                <i class="fas fa-lock"></i> êµì‚¬
            </button>
        </div>
    </header>

    <main class="flex-grow container mx-auto px-4 py-6">
        
        <!-- 1. ë¡œê·¸ì¸ í™”ë©´ -->
        <section id="view-login" class="max-w-md mx-auto bg-white p-8 rounded-xl shadow-lg fade-in mt-8 border-t-4 border-amber-500">
            <div class="text-center mb-8">
                <!-- [ìˆ˜ì •] ë¬¸êµ¬ ë³€ê²½ -->
                <span class="bg-amber-100 text-amber-900 text-xs font-bold px-3 py-1 rounded-full">ìš©ì‹ ì¤‘í•™êµ ì—­ì‚¬êµì‚¬ ë°©ì¬ì„</span>
                <h2 class="text-2xl font-bold serif text-stone-900 mt-3">ë‹¹ì‹ ì˜ ì—­ì‚¬ ì‹¤ë ¥ì€?</h2>
                <p class="text-red-500 font-bold text-sm mt-2"><i class="fas fa-stopwatch mr-1"></i> ì œí•œì‹œê°„ 60ì´ˆ (5ë¬¸ì œ)</p>
            </div>
            
            <div class="space-y-4">
                <div>
                    <label class="text-xs font-bold text-stone-500 block mb-1">í•™ë²ˆ ì •ë³´</label>
                    <div class="flex gap-2">
                        <div class="w-1/4 bg-stone-100 border border-stone-300 rounded flex items-center justify-center font-bold text-stone-600">2í•™ë…„</div>
                        <select id="input-class" class="w-2/4 p-3 border border-stone-300 rounded focus:border-amber-500 outline-none">
                            <option value="">ë°˜ ì„ íƒ</option>
                            <option value="1">1ë°˜</option><option value="2">2ë°˜</option><option value="3">3ë°˜</option>
                            <option value="4">4ë°˜</option><option value="5">5ë°˜</option><option value="6">6ë°˜</option>
                            <option value="7">7ë°˜</option><option value="8">8ë°˜</option><option value="9">9ë°˜</option>
                            <option value="10">10ë°˜</option>
                        </select>
                        <input type="number" id="input-number" placeholder="ë²ˆí˜¸" class="w-1/4 p-3 border border-stone-300 rounded focus:border-amber-500 outline-none text-center">
                    </div>
                </div>
                <div>
                    <label class="text-xs font-bold text-stone-500 block mb-1">ì´ë¦„</label>
                    <input type="text" id="input-name" placeholder="ì´ë¦„ ì…ë ¥" class="w-full p-3 border border-stone-300 rounded focus:border-amber-500 outline-none">
                </div>
                
                <button onclick="app.startQuiz()" class="w-full bg-stone-900 text-white font-bold py-4 rounded-lg hover:bg-stone-700 transition shadow-lg mt-4 transform active:scale-95">
                    ë„ì „ ì‹œì‘ <i class="fas fa-play ml-2"></i>
                </button>
            </div>
        </section>

        <!-- 2. í€´ì¦ˆ í™”ë©´ -->
        <section id="view-quiz" class="hidden max-w-2xl mx-auto fade-in">
            <div class="bg-white rounded-lg shadow-sm mb-6 sticky top-20 z-40 overflow-hidden border border-stone-200">
                <div class="flex justify-between items-center px-4 py-2 bg-stone-50 border-b border-stone-100">
                    <span class="text-sm font-bold text-stone-600" id="quiz-progress-text">1 / 5</span>
                    <span class="text-lg font-bold text-red-600 font-mono" id="timer-text">60ì´ˆ</span>
                </div>
                <div class="w-full bg-stone-200 h-2">
                    <div id="timer-bar" class="bg-amber-500 h-full timer-bar" style="width: 100%"></div>
                </div>
            </div>

            <div class="bg-white p-6 md:p-10 rounded-lg min-h-[400px] flex flex-col relative shadow-md">
                <span id="question-badge" class="absolute top-0 right-0 bg-stone-100 text-stone-600 text-xs font-bold px-3 py-1 rounded-bl-lg border-l border-b border-stone-200">
                    ìœ í˜•
                </span>
                
                <h3 id="question-text" class="text-xl md:text-2xl font-bold mt-4 mb-8 text-stone-900 leading-relaxed serif break-keep">
                    <!-- ë¬¸ì œ ë‚´ìš© -->
                </h3>

                <div id="answer-area" class="flex-grow mb-6">
                    <!-- ì •ë‹µ ì…ë ¥ë€ -->
                </div>

                <!-- [ìˆ˜ì •] ë²„íŠ¼ ì˜ì—­: ì´ì „ / ë‹¤ìŒ -->
                <div class="flex gap-3 mt-auto">
                    <button id="btn-prev" onclick="app.prevQuestion()" class="hidden w-1/3 bg-stone-200 text-stone-700 font-bold py-4 rounded-lg hover:bg-stone-300 transition shadow-sm">
                        <i class="fas fa-chevron-left mr-1"></i> ì´ì „
                    </button>
                    <button id="btn-next" onclick="app.submitAnswer()" class="w-full bg-amber-600 text-white font-bold py-4 rounded-lg hover:bg-amber-700 transition shadow-md">
                        ë‹¤ìŒ ë¬¸ì œ <i class="fas fa-chevron-right ml-1"></i>
                    </button>
                </div>
            </div>
        </section>

        <!-- 3. ê²°ê³¼ í™”ë©´ -->
        <section id="view-results" class="hidden max-w-lg mx-auto fade-in mt-6">
            <div class="bg-white p-8 rounded-xl shadow-xl text-center border-t-8 border-amber-500">
                <h2 class="text-3xl font-bold serif mb-2 text-stone-800">í‰ê°€ ì¢…ë£Œ</h2>
                <p class="text-stone-500 mb-6"><span id="result-name" class="font-bold text-stone-900"></span> í•™ìƒì˜ ìµœì¢… ê¸°ë¡</p>
                
                <div class="relative w-48 h-48 mx-auto mb-4">
                    <canvas id="scoreChart"></canvas>
                    <div class="absolute inset-0 flex items-center justify-center flex-col">
                        <span class="text-5xl font-bold text-amber-600 font-mono" id="score-text">0</span>
                        <span class="text-xs text-stone-400">ì </span>
                    </div>
                </div>

                <div id="submission-status" class="bg-stone-50 p-3 rounded text-sm mb-6 border border-stone-200 text-stone-500">
                    <i class="fas fa-circle-notch fa-spin"></i> ë°ì´í„° ì €ì¥ ì¤‘...
                </div>

                <div class="grid grid-cols-2 gap-3">
                    <button onclick="app.toggleReview()" class="bg-white border-2 border-stone-200 text-stone-700 font-bold py-3 rounded hover:bg-stone-50 hover:border-stone-400 transition">
                        <i class="fas fa-book-open mr-1"></i> ì˜¤ë‹µë…¸íŠ¸
                    </button>
                    <button onclick="location.reload()" class="bg-stone-900 text-white font-bold py-3 rounded hover:bg-stone-700 transition shadow-lg">
                        <i class="fas fa-redo mr-1"></i> ë‹¤ì‹œ ë„ì „
                    </button>
                </div>
            </div>

            <!-- ì˜¤ë‹µë…¸íŠ¸ -->
            <div id="review-section" class="hidden mt-6 bg-white p-6 rounded-xl shadow-lg border border-red-200">
                <h3 class="font-bold text-lg mb-4 text-red-600 border-b pb-2"><i class="fas fa-check-circle"></i> ì˜¤ë‹µ í™•ì¸</h3>
                <div id="review-list" class="space-y-4 text-left"></div>
            </div>
        </section>

        <!-- 4. êµì‚¬ìš© ëŒ€ì‹œë³´ë“œ -->
        <section id="view-teacher" class="hidden max-w-6xl mx-auto bg-white p-6 rounded shadow-xl mt-4 border border-stone-300">
            <div class="flex justify-between items-center mb-6 border-b pb-4">
                <div>
                    <h2 class="font-bold text-2xl text-stone-800"><i class="fas fa-chalkboard-teacher text-amber-600 mr-2"></i>êµì‚¬ ëŒ€ì‹œë³´ë“œ</h2>
                    <p class="text-xs text-stone-500 mt-1">ë¹„ë°€ë²ˆí˜¸: 0423 | <span class="text-blue-600 font-bold">Firebase ì—°ë™ë¨</span></p>
                </div>
                <button onclick="app.closeTeacherMode()" class="bg-stone-200 hover:bg-stone-300 text-stone-700 px-4 py-2 rounded text-sm font-bold">ë‚˜ê°€ê¸°</button>
            </div>
            
            <div class="flex flex-wrap gap-2 mb-6">
                <button onclick="app.setTeacherTab('log')" id="btn-tab-log" class="px-5 py-2 rounded-full bg-stone-800 text-white text-sm font-bold shadow transition"><i class="fas fa-list mr-1"></i> ì‹¤ì‹œê°„ ê¸°ë¡</button>
                <button onclick="app.setTeacherTab('bank')" id="btn-tab-bank" class="px-5 py-2 rounded-full bg-stone-100 text-stone-600 text-sm font-bold hover:bg-stone-200 shadow transition"><i class="fas fa-database mr-1"></i> ë¬¸ì œ ì€í–‰</button>
                <button onclick="app.setTeacherTab('add')" id="btn-tab-add" class="px-5 py-2 rounded-full bg-stone-100 text-stone-600 text-sm font-bold hover:bg-stone-200 shadow transition"><i class="fas fa-plus-circle mr-1"></i> ë¬¸ì œ ì¶”ê°€</button>
            </div>

            <!-- íƒ­ 1: í•™ìƒ ê¸°ë¡ -->
            <div id="tab-log">
                <div class="flex justify-between items-center mb-4">
                    <h3 class="font-bold text-lg">ì œì¶œ í˜„í™© <span id="log-count" class="text-sm font-normal text-stone-500 ml-2">(ë¡œë”©ì¤‘...)</span></h3>
                    <div class="flex gap-2">
                        <button onclick="app.loadServerLogs()" class="bg-blue-600 hover:bg-blue-700 text-white px-3 py-2 rounded text-sm font-bold shadow"><i class="fas fa-sync-alt mr-1"></i> ìƒˆë¡œê³ ì¹¨</button>
                        <button onclick="app.downloadExcel()" class="bg-green-600 hover:bg-green-700 text-white px-3 py-2 rounded text-sm font-bold shadow"><i class="fas fa-file-excel mr-1"></i> ì—‘ì…€ ë‹¤ìš´</button>
                    </div>
                </div>
                <div class="overflow-auto max-h-[500px] border rounded bg-stone-50">
                    <table class="w-full text-sm text-left">
                        <thead class="bg-stone-200 text-stone-700 sticky top-0 font-bold">
                            <tr><th class="p-3">ì‹œê°„</th><th class="p-3">ì •ë³´</th><th class="p-3">ì ìˆ˜</th><th class="p-3">ìƒíƒœ</th></tr>
                        </thead>
                        <tbody id="teacher-log-body" class="bg-white">
                            <tr><td colspan="4" class="p-4 text-center text-stone-400">ë°ì´í„°ë¥¼ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘...</td></tr>
                        </tbody>
                    </table>
                </div>
            </div>

            <!-- íƒ­ 2: ë¬¸ì œ ì€í–‰ -->
            <div id="tab-bank" class="hidden">
                <div class="flex justify-between items-center mb-4">
                    <h3 class="font-bold text-lg">ì „ì²´ ë¬¸ì œ ë¦¬ìŠ¤íŠ¸</h3>
                    <button onclick="app.resetCustomQuestions()" class="text-red-500 text-xs hover:underline">ì‚¬ìš©ì ë¬¸ì œ ì´ˆê¸°í™”</button>
                </div>
                <div class="overflow-auto max-h-[500px] border rounded bg-stone-50"><table class="w-full text-sm text-left"><thead class="bg-stone-200 text-stone-700 sticky top-0 font-bold"><tr><th class="p-3 w-12">ID</th><th class="p-3 w-20">ìœ í˜•</th><th class="p-3">ë¬¸ì œ</th><th class="p-3 w-32">ì •ë‹µ</th></tr></thead><tbody id="bank-body" class="bg-white"></tbody></table></div>
            </div>

            <!-- íƒ­ 3: ë¬¸ì œ ì¶”ê°€ -->
            <div id="tab-add" class="hidden">
                <div class="bg-stone-50 p-6 rounded border border-stone-200 max-w-2xl mx-auto">
                    <h3 class="font-bold text-xl mb-4 border-b pb-2">ìƒˆ ë¬¸ì œ ë§Œë“¤ê¸°</h3>
                    <div class="space-y-4">
                        <div><label class="block text-sm font-bold mb-1">ìœ í˜•</label><select id="new-q-type" class="w-full p-2 border rounded" onchange="app.toggleOptionInput()"><option value="choice">ê°ê´€ì‹</option><option value="blank">ë¹ˆì¹¸ ì±„ìš°ê¸°</option><option value="word">ë‹¨ë‹µí˜•</option><option value="order">ìˆœì„œ ë§ì¶”ê¸°</option></select></div>
                        <div><label class="block text-sm font-bold mb-1">ë¬¸ì œ</label><textarea id="new-q-text" class="w-full p-2 border rounded h-20"></textarea></div>
                        <div id="option-container"><label class="block text-sm font-bold mb-1">ë³´ê¸° (ì½¤ë§ˆë¡œ êµ¬ë¶„)</label><input type="text" id="new-q-options" class="w-full p-2 border rounded" placeholder="ì˜ˆ: A, B, C, D"></div>
                        <div><label class="block text-sm font-bold mb-1">ì •ë‹µ</label><input type="text" id="new-q-answer" class="w-full p-2 border rounded"></div>
                        <div><label class="block text-sm font-bold mb-1">í•´ì„¤</label><input type="text" id="new-q-exp" class="w-full p-2 border rounded"></div>
                        <button onclick="app.addCustomQuestion()" class="w-full bg-amber-600 text-white font-bold py-3 rounded hover:bg-amber-700 transition">ì¶”ê°€í•˜ê¸°</button>
                    </div>
                </div>
            </div>
        </section>
    </main>

    <script>
        // ======================================================================================
        // [ì„ ìƒë‹˜ì˜ Firebase ì„¤ì •]
        // ======================================================================================
        const firebaseConfig = {
            apiKey: "AIzaSyAOlPQ5PFmL0zxmGrGcuEBnqBXisph7kPU",
            authDomain: "history-quiz-yongsin.firebaseapp.com",
            projectId: "history-quiz-yongsin",
            storageBucket: "history-quiz-yongsin.firebasestorage.app",
            messagingSenderId: "177587430482",
            appId: "1:177587430482:web:d79cc145c11e335cc3ab8b",
            measurementId: "G-LHN97D7R2R"
        };
        // ======================================================================================

        // Firebase ì´ˆê¸°í™”
        let db;
        try {
            if (!firebase.apps.length) {
                firebase.initializeApp(firebaseConfig);
            }
            db = firebase.firestore();
            console.log("Firebase Connected");
        } catch(e) {
            console.error("Firebase Init Error:", e);
            alert("Firebase ì„¤ì • ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.");
        }

        /* ë¬¸ì œ ë°ì´í„° */
        const defaultQuestions = [
            { id: 1, type: "choice", question: "ì•„í…Œë„¤ ë¯¼ì£¼ ì •ì¹˜ì˜ ì „ì„±ê¸° ì§€ë„ìëŠ”?", answer: "í˜ë¦¬í´ë ˆìŠ¤", options: ["í˜ë¦¬í´ë ˆìŠ¤", "ì•Œë ‰ì‚°ë“œë¡œìŠ¤", "ì¹´ì´ì‚¬ë¥´", "ì†”ë¡ "], explanation: "í˜ë¦¬í´ë ˆìŠ¤ ì‹œëŒ€ì— ì§ì ‘ ë¯¼ì£¼ì£¼ì˜ê°€ ì™„ì„±ë¨." },
            { id: 2, type: "blank", question: "ì•„í…Œë„¤ ë¯¼ì£¼ ì •ì¹˜ì—ì„œ ì—¬ì„±, ë…¸ì˜ˆ, [ _____ ]ì€ ì°¸ì •ê¶Œì´ ì—†ì—ˆë‹¤.", answer: "ì™¸êµ­ì¸", explanation: "ì œí•œì  ë¯¼ì£¼ì •ì¹˜ì˜€ìŒ." },
            { id: 3, type: "choice", question: "ê·¸ë¦¬ìŠ¤ê°€ í˜ë¥´ì‹œì•„ ì „ìŸ ìŠ¹ë¦¬ í›„ ë§ºì€ ë™ë§¹ì€?", answer: "ë¸ë¡œìŠ¤ ë™ë§¹", options: ["í ë¡œí°ë„¤ì†ŒìŠ¤ ë™ë§¹", "ë¸ë¡œìŠ¤ ë™ë§¹", "ì‹ ì„± ë™ë§¹", "ì‚¼êµ­ ë™ë§¹"], explanation: "ì•„í…Œë„¤ê°€ ë§¹ì£¼ê°€ ë¨." },
            { id: 4, type: "word", question: "ê·¸ë¦¬ìŠ¤-í˜ë¥´ì‹œì•„ ì „ìŸ ìŠ¹ì „ë³´ì˜ ìœ ë˜ê°€ ëœ ì „íˆ¬ëŠ”?", answer: "ë§ˆë¼í†¤", explanation: "ë§ˆë¼í†¤ ê²½ê¸°ì˜ ê¸°ì›." },
            { id: 5, type: "choice", question: "ë¡œë§ˆ ê³µí™”ì • ì´ˆê¸° ê·€ì¡±ë“¤ì˜ ìµœê³  ì˜ê²° ê¸°ê´€ì€?", answer: "ì›ë¡œì›", options: ["ì›ë¡œì›", "ë¯¼íšŒ", "í˜¸ë¯¼ê´€", "ì§‘ì •ê´€"], explanation: "ì‹¤ê¶Œ ì¥ì•…." },
            { id: 6, type: "word", question: "ë¡œë§ˆ í‰ë¯¼ ëŒ€í‘œ ì§ì±…ì€?", answer: "í˜¸ë¯¼ê´€", explanation: "ê±°ë¶€ê¶Œ í–‰ì‚¬ ê°€ëŠ¥." },
            { id: 7, type: "choice", question: "ë¡œë§ˆ ì´ˆëŒ€ í™©ì œ ì•„ìš°êµ¬ìŠ¤íˆ¬ìŠ¤ëŠ” ëˆ„êµ¬?", answer: "ì˜¥íƒ€ë¹„ì•„ëˆ„ìŠ¤", options: ["ì¹´ì´ì‚¬ë¥´", "ì˜¥íƒ€ë¹„ì•„ëˆ„ìŠ¤", "ì•ˆí† ë‹ˆìš°ìŠ¤", "ë„¤ë¡œ"], explanation: "ì œì • ì‹œì‘." },
            { id: 8, type: "blank", question: "ë¡œë§ˆì˜ í‰í™” ì‹œëŒ€ë¥¼ [ _____ ] ë¡œë§ˆë‚˜ ë¼ê³  í•œë‹¤.", answer: "íŒìŠ¤", explanation: "Pax Romana." },
            { id: 9, type: "choice", question: "ë¡œë§ˆ ì œêµ­ì„ 4ë¶„í•  í†µì¹˜í•œ í™©ì œëŠ”?", answer: "ë””ì˜¤í´ë ˆí‹°ì•„ëˆ„ìŠ¤", options: ["ì½˜ìŠ¤íƒ„í‹°ëˆ„ìŠ¤", "ë””ì˜¤í´ë ˆí‹°ì•„ëˆ„ìŠ¤", "í…Œì˜¤ë„ì‹œìš°ìŠ¤", "íŠ¸ë¼ì•¼ëˆ„ìŠ¤"], explanation: "íš¨ìœ¨ì  í†µì¹˜ ëª©ì ." },
            { id: 10, type: "choice", question: "ë´‰ê±´ì œì—ì„œ ì£¼êµ°ì´ ë´‰ì‹ ì—ê²Œ ì¤€ ê²ƒì€?", answer: "ë´‰í† ", options: ["ë´‰í† ", "ë…¸ì˜ˆ", "í™”í", "ì„±ê²½"], explanation: "í† ì§€ ë§¤ê°œ ê³„ì•½." },
            { id: 11, type: "blank", question: "ì¥ì›ì— ì˜ˆì†ëœ ë†ë¯¼ì„ [ _____ ]ë¼ê³  í•œë‹¤.", answer: "ë†ë…¸", explanation: "ê±°ì£¼ ì´ì „ ììœ  ì—†ìŒ." },
            { id: 12, type: "word", question: "êµí™©ê¶Œì´ í™©ì œê¶Œë³´ë‹¤ ê°•í•´ì§„ ì‚¬ê±´ì€? (ã…‹ã„´ã……ì˜ êµ´ìš•)", answer: "ì¹´ë…¸ì‚¬ì˜ êµ´ìš•", explanation: "í•˜ì¸ë¦¬íˆ 4ì„¸ê°€ êµ´ë³µí•¨." },
            { id: 13, type: "choice", question: "ì‹­ìêµ° ì „ìŸ ê²°ê³¼ëŠ”?", answer: "êµí™©ê¶Œ ì‡ í‡´", options: ["êµí™©ê¶Œ ê°•í™”", "êµí™©ê¶Œ ì‡ í‡´", "ë´‰ê±´ì œ ê°•í™”", "ë¬´ì—­ ì‡ í‡´"], explanation: "ì‹¤íŒ¨ë¡œ ì¸í•œ ê¶Œìœ„ ì¶”ë½." },
            { id: 14, type: "choice", question: "ì‹ ì•™ê³¼ ì´ì„±ì˜ ì¡°í™”ë¥¼ ì¶”êµ¬í•œ ì¤‘ì„¸ ì² í•™ì€?", answer: "ìŠ¤ì½œë¼ ì² í•™", options: ["ìŠ¤ì½œë¼ ì² í•™", "ê²½í—˜ì£¼ì˜", "ì‹¤ì¡´ì£¼ì˜", "ê³„ëª½ ì‚¬ìƒ"], explanation: "í† ë§ˆìŠ¤ ì•„í€´ë‚˜ìŠ¤." },
            { id: 15, type: "blank", question: "ìŠ¤ì½œë¼ ì² í•™ ì§‘ëŒ€ì„±: í† ë§ˆìŠ¤ [ _____ ]", answer: "ì•„í€´ë‚˜ìŠ¤", explanation: "ì‹ í•™ ëŒ€ì „ ì €ìˆ ." },
            { id: 16, type: "choice", question: "ë¾°ì¡±í•œ ì²¨íƒ‘, ìŠ¤í…Œì¸ë“œê¸€ë¼ìŠ¤ ê±´ì¶• ì–‘ì‹ì€?", answer: "ê³ ë”• ì–‘ì‹", options: ["ë¡œë§ˆë„¤ìŠ¤í¬", "ê³ ë”• ì–‘ì‹", "ë¹„ì”í‹°ì›€", "ë°”ë¡œí¬"], explanation: "ì¤‘ì„¸ ëŒ€í‘œ ì–‘ì‹." },
            { id: 17, type: "word", question: "ìœ ìŠ¤í‹°ë‹ˆì•„ëˆ„ìŠ¤ ëŒ€ì œê°€ í¸ì°¬í•œ ë²•ì „ì€?", answer: "ìœ ìŠ¤í‹°ë‹ˆì•„ëˆ„ìŠ¤ ë²•ì „", explanation: "ë¡œë§ˆë²• ì§‘ëŒ€ì„±." },
            { id: 18, type: "choice", question: "ì´íƒˆë¦¬ì•„ ë¥´ë„¤ìƒìŠ¤ì˜ ê·¼ë³¸ ì •ì‹ ì€?", answer: "ì¸ë¬¸ì£¼ì˜", options: ["ì‹ ë³¸ì£¼ì˜", "ì¸ë¬¸ì£¼ì˜", "ë¯¼ì¡±ì£¼ì˜", "ì œêµ­ì£¼ì˜"], explanation: "ì¸ê°„ ì¤‘ì‹¬." },
            { id: 19, type: "choice", question: "ëª¨ë‚˜ë¦¬ìë¥¼ ê·¸ë¦° í™”ê°€ëŠ”?", answer: "ë ˆì˜¤ë‚˜ë¥´ë„ ë‹¤ë¹ˆì¹˜", options: ["ë¯¸ì¼ˆë€ì ¤ë¡œ", "ë¼íŒŒì—˜ë¡œ", "ë ˆì˜¤ë‚˜ë¥´ë„ ë‹¤ë¹ˆì¹˜", "ë³´í‹°ì²¼ë¦¬"], explanation: "ë¥´ë„¤ìƒìŠ¤ ë§¨." },
            { id: 20, type: "blank", question: "ì•Œí”„ìŠ¤ ì´ë¶ ë¥´ë„¤ìƒìŠ¤ëŠ” [ _____ ] ë¹„íŒ ì„±ê²©ì´ ê°•í–ˆë‹¤.", answer: "êµíšŒ", explanation: "ì‚¬íšŒ ë¹„íŒì ." },
            { id: 21, type: "word", question: "í™œíŒ ì¸ì‡„ìˆ  ë°œëª…ê°€ëŠ”?", answer: "êµ¬í…ë² ë¥´í¬", explanation: "ì§€ì‹ í˜ëª…." },
            { id: 22, type: "choice", question: "ë£¨í„°ê°€ ë¹„íŒí•œ ê²ƒì€?", answer: "ë©´ë²Œë¶€ íŒë§¤", options: ["ì„±ì§ ë§¤ë§¤", "ë©´ë²Œë¶€ íŒë§¤", "ì‹­ìêµ°", "ë§ˆë…€ ì‚¬ëƒ¥"], explanation: "95ê°œì¡° ë°˜ë°•ë¬¸." },
            { id: 23, type: "choice", question: "ì˜ˆì •ì„¤ì„ ì£¼ì¥í•œ ì‚¬ëŒì€?", answer: "ì¹¼ë±…", options: ["ë£¨í„°", "ì¹¼ë±…", "í—¨ë¦¬ 8ì„¸", "ì¯”ë¹™ê¸€ë¦¬"], explanation: "ì§ì—… ì†Œëª…ì„¤." },
            { id: 24, type: "choice", question: "ì´í˜¼ ë¬¸ì œë¡œ ì¢…êµ ê°œí˜í•œ ì™•ì€?", answer: "í—¨ë¦¬ 8ì„¸", options: ["ì—˜ë¦¬ìë² ìŠ¤ 1ì„¸", "í—¨ë¦¬ 8ì„¸", "ë£¨ì´ 14ì„¸", "ì°°ìŠ¤ 1ì„¸"], explanation: "ì˜êµ­ êµ­êµíšŒ ì„±ë¦½." },
            { id: 25, type: "choice", question: "ì‹ í•­ë¡œ ê°œì²™, ì•„ë©”ë¦¬ì¹´ ë°œê²¬ìëŠ”?", answer: "ì½œëŸ¼ë²„ìŠ¤", options: ["ë°”ìŠ¤ì½” ë‹¤ ê°€ë§ˆ", "ë§ˆì ¤ë€", "ì½œëŸ¼ë²„ìŠ¤", "ë””ì•„ìŠ¤"], explanation: "ì„œì¸ë„ ì œë„ ë„ì°©." },
            { id: 26, type: "word", question: "ìµœì´ˆ ì„¸ê³„ ì¼ì£¼ ì„±ê³µ íŒ€ì€?", answer: "ë§ˆì ¤ë€", explanation: "ì§€êµ¬ êµ¬í˜•ì„¤ ì…ì¦." },
            { id: 27, type: "blank", question: "ì™•ê¶Œì€ ì‹ ì´ ì£¼ì—ˆë‹¤ëŠ” [ _____ ]ì„¤.", answer: "ì™•ê¶Œì‹ ìˆ˜", explanation: "ì ˆëŒ€ì™•ì • ì‚¬ìƒì  ê¸°ë°˜." },
            { id: 28, type: "choice", question: "ë¬´ì í•¨ëŒ€ë¥¼ ë§Œë“  ì—ìŠ¤íŒŒëƒ ì™•ì€?", answer: "í ë¦¬í˜ 2ì„¸", options: ["í ë¦¬í˜ 2ì„¸", "ì—˜ë¦¬ìë² ìŠ¤ 1ì„¸", "ë£¨ì´ 14ì„¸", "í‘œíŠ¸ë¥´ ëŒ€ì œ"], explanation: "ì „ì„±ê¸° êµ¬ê°€." },
            { id: 29, type: "choice", question: "íƒœì–‘ì™•, ë² ë¥´ì‚¬ìœ  ê¶ì „ ì£¼ì¸ì€?", answer: "ë£¨ì´ 14ì„¸", options: ["ë£¨ì´ 16ì„¸", "ë£¨ì´ 14ì„¸", "ë‚˜í´ë ˆì˜¹", "ì•™ë¦¬ 4ì„¸"], explanation: "ì§ì´ ê³§ êµ­ê°€ë‹¤." },
            { id: 30, type: "word", question: "ëŸ¬ì‹œì•„ ì„œìœ ëŸ½í™” ì •ì±… ì¶”ì§„ í™©ì œëŠ”?", answer: "í‘œíŠ¸ë¥´ ëŒ€ì œ", explanation: "ìˆ˜ì—¼ì„¸." },
            { id: 31, type: "choice", question: "ëª…ì˜ˆí˜ëª… ê²°ê³¼ ìŠ¹ì¸ëœ ë¬¸ì„œëŠ”?", answer: "ê¶Œë¦¬ì¥ì „", options: ["ëŒ€í—Œì¥", "ê¶Œë¦¬ì²­ì›", "ê¶Œë¦¬ì¥ì „", "ë…ë¦½ì„ ì–¸ë¬¸"], explanation: "ì…í—Œêµ°ì£¼ì œ í† ëŒ€." },
            { id: 32, type: "blank", question: "ë¯¸êµ­ í˜ëª… ë°œë‹¨: [ _____ ] ì°¨ ì‚¬ê±´.", answer: "ë³´ìŠ¤í„´", explanation: "ëŒ€í‘œ ì—†ìœ¼ë©´ ê³¼ì„¸ ì—†ë‹¤." },
            { id: 33, type: "order", question: "í”„ë‘ìŠ¤ í˜ëª… ìˆœì„œ", answer: "ì‚¼ë¶€íšŒ-ë°”ìŠ¤í‹°ìœ -ì¸ê¶Œì„ ì–¸-ê³µí¬ì •ì¹˜", options: ["ë°”ìŠ¤í‹°ìœ ìŠµê²©", "ê³µí¬ì •ì¹˜", "ì¸ê¶Œì„ ì–¸", "ì‚¼ë¶€íšŒì†Œì§‘"], explanation: "ì „ê°œ ê³¼ì • ì•”ê¸°." },
            { id: 34, type: "choice", question: "ê³µí¬ ì •ì¹˜ ì£¼ë„ ì¸ë¬¼ì€?", answer: "ë¡œë² ìŠ¤í”¼ì—ë¥´", options: ["ë£¨ì´ 16ì„¸", "ë¡œë² ìŠ¤í”¼ì—ë¥´", "ë‚˜í´ë ˆì˜¹", "ë‹¹í†µ"], explanation: "ê³µì•ˆ ìœ„ì›íšŒ." },
            { id: 35, type: "choice", question: "ê°€ë¦¬ë°œë””ê°€ ì´ëˆ ë¶€ëŒ€ëŠ”?", answer: "ë¶‰ì€ ì…”ì¸ ëŒ€", options: ["ë¶‰ì€ ì…”ì¸ ëŒ€", "ì² í˜ˆ ë¶€ëŒ€", "ì‹­ìêµ°", "ì˜ìš©êµ°"], explanation: "ì´íƒˆë¦¬ì•„ í†µì¼ ê¸°ì—¬." },
            { id: 36, type: "word", question: "ë¹„ìŠ¤ë§ˆë¥´í¬ì˜ í†µì¼ ì •ì±…ì€?", answer: "ì² í˜ˆ ì •ì±…", explanation: "ë…ì¼ í†µì¼." },
            { id: 37, type: "choice", question: "ì‚°ì—…í˜ëª… ë°œìƒì§€ëŠ”?", answer: "ì˜êµ­", options: ["í”„ë‘ìŠ¤", "ë…ì¼", "ë¯¸êµ­", "ì˜êµ­"], explanation: "ì¡°ê±´ì´ ì¢‹ì•˜ìŒ." },
            { id: 38, type: "blank", question: "ì œêµ­ì£¼ì˜ ì •ë‹¹í™” ë…¼ë¦¬: [ _____ ]ë¡ .", answer: "ì‚¬íšŒì§„í™”", explanation: "ìŠ¤íœì„œ." },
            { id: 39, type: "choice", question: "ì‹ë¯¼ì§€ ìŸíƒˆì „ ê°€ì¥ ì¹˜ì—´í–ˆë˜ ê³³?", answer: "ì•„í”„ë¦¬ì¹´", options: ["ì•„ì‹œì•„", "ì•„í”„ë¦¬ì¹´", "ì•„ë©”ë¦¬ì¹´", "ìœ ëŸ½"], explanation: "ë¶„í• ë¨." },
            { id: 40, type: "choice", question: "1ì°¨ ëŒ€ì „ ì›ì¸ ì‚¬ê±´?", answer: "ì‚¬ë¼ì˜ˆë³´ ì‚¬ê±´", options: ["ë³´ìŠ¤í„´ ì°¨ ì‚¬ê±´", "ì‚¬ë¼ì˜ˆë³´ ì‚¬ê±´", "í”¼ì˜ ì¼ìš”ì¼", "ì§„ì£¼ë§Œ"], explanation: "ì˜¤ìŠ¤íŠ¸ë¦¬ì•„ í™©íƒœì ì•”ì‚´." },
            { id: 41, type: "choice", question: "ì˜êµ­, í”„ë‘ìŠ¤, ëŸ¬ì‹œì•„ ë™ë§¹ì€?", answer: "ì‚¼êµ­ í˜‘ìƒ", options: ["ì‚¼êµ­ ë™ë§¹", "ì‚¼êµ­ í˜‘ìƒ", "ì¶”ì¶•êµ­", "ì—°í•©êµ­"], explanation: "ë…ì¼ í¬ìœ„." },
            { id: 42, type: "word", question: "ë…ì¼ì—ê²Œ ë§‰ëŒ€í•œ ë°°ìƒê¸ˆ ë¬¼ë¦° ì¡°ì•½?", answer: "ë² ë¥´ì‚¬ìœ  ì¡°ì•½", explanation: "2ì°¨ ëŒ€ì „ ì”¨ì•—." },
            { id: 43, type: "blank", question: "ë¯¸êµ­ ëŒ€ê³µí™© ê·¹ë³µ ì •ì±…: [ _____ ] ì •ì±….", answer: "ë‰´ë”œ", explanation: "ë£¨ì¦ˆë²¨íŠ¸." },
            { id: 44, type: "choice", question: "êµ­ê°€ ì „ì²´ ìš°ì„  ì‚¬ìƒì€?", answer: "ì „ì²´ì£¼ì˜", options: ["ììœ ì£¼ì˜", "ë¯¼ì£¼ì£¼ì˜", "ì „ì²´ì£¼ì˜", "ê°œì¸ì£¼ì˜"], explanation: "íŒŒì‹œì¦˜, ë‚˜ì¹˜ì¦˜." },
            { id: 45, type: "choice", question: "ë‚˜ì¹˜ì˜ ìœ ëŒ€ì¸ í•™ì‚´ì€?", answer: "í™€ë¡œì½”ìŠ¤íŠ¸", options: ["í™€ë¡œì½”ìŠ¤íŠ¸", "ì•„íŒŒë¥´íŠ¸í—¤ì´íŠ¸", "í‚¬ë§í•„ë“œ", "ì¸ì¢… ì²­ì†Œ"], explanation: "ì œë…¸ì‚¬ì´ë“œ." },
            { id: 46, type: "choice", question: "ëŒ€í‘œì  ê³ ë”• ê±´ì¶•ë¬¼?", answer: "ë…¸íŠ¸ë¥´ë‹´ ëŒ€ì„±ë‹¹", options: ["íŒí…Œì˜¨", "íŒŒë¥´í…Œë…¼", "ë…¸íŠ¸ë¥´ë‹´ ëŒ€ì„±ë‹¹", "ì½œë¡œì„¸ì›€"], explanation: "íŒŒë¦¬ ì†Œì¬." },
            { id: 47, type: "blank", question: "ë£¨ì´ 14ì„¸ì˜ ê¶ì „: [ _____ ] ê¶ì „.", answer: "ë² ë¥´ì‚¬ìœ ", explanation: "ë°”ë¡œí¬ ì–‘ì‹." },
            { id: 48, type: "choice", question: "ì²­êµë„ í˜ëª… ì§€ë„ì?", answer: "í¬ë¡¬ì›°", options: ["ì°°ìŠ¤ 1ì„¸", "í¬ë¡¬ì›°", "ì œì„ìŠ¤ 2ì„¸", "ìœŒë¦¬ì—„ 3ì„¸"], explanation: "í˜¸êµ­ê²½ ì·¨ì„." },
            { id: 49, type: "word", question: "ì²œë¶€ì¸ê¶Œ: ìƒëª…, ììœ , [  ] ì¶”êµ¬.", answer: "í–‰ë³µ", explanation: "ë¯¸êµ­ ë…ë¦½ ì„ ì–¸." },
            { id: 50, type: "choice", question: "ë‚˜í´ë ˆì˜¹ì´ ì „íŒŒí•œ ì‚¬ìƒ?", answer: "ììœ ì£¼ì˜", options: ["ì™•ê¶Œì‹ ìˆ˜ì„¤", "ììœ ì£¼ì˜", "ë³µê³ ì£¼ì˜", "ì „ì²´ì£¼ì˜"], explanation: "í˜ëª… ì •ì‹ ." }
        ];

        /* ì•± ë¡œì§ */
        const app = {
            state: { student:{}, questions:[], allQuestions:[], currentIndex:0, answers:{}, score:0, isTeacherMode:false, timer:null, timeLeft:60, isTimeOut:false, customBank:[], logs:[] },
            
            init: function() {
                const btnTeacher = document.getElementById('btn-teacher-mode');
                if(btnTeacher) btnTeacher.onclick = () => this.toggleTeacherMode();
                const saved = localStorage.getItem('hq_custom_q');
                if(saved) this.state.customBank = JSON.parse(saved);
                this.state.allQuestions = [...defaultQuestions, ...this.state.customBank];
            },

            // --- í€´ì¦ˆ ë¡œì§ ---
            startQuiz: function() {
                const cls = document.getElementById('input-class').value;
                const num = document.getElementById('input-number').value;
                const name = document.getElementById('input-name').value.trim();
                if(!cls || !num || !name) { alert("ì •ë³´ë¥¼ ëª¨ë‘ ì…ë ¥í•˜ì„¸ìš”."); return; }
                this.state.student = { class:cls, number:num, name:name };
                this.state.allQuestions = [...defaultQuestions, ...this.state.customBank];
                const shuffled = this.state.allQuestions.sort(() => 0.5 - Math.random());
                this.state.questions = shuffled.slice(0, 5);
                this.state.currentIndex = 0; this.state.answers = {}; this.state.score = 0; this.state.timeLeft = 60; this.state.isTimeOut = false;
                this.showView('view-quiz'); this.renderQuestion(); this.startTimer();
            },
            startTimer: function() {
                if(this.state.timer) clearInterval(this.state.timer);
                const bar = document.getElementById('timer-bar'), txt = document.getElementById('timer-text');
                bar.style.width='100%'; bar.classList.remove('timer-urgent'); txt.innerText='60ì´ˆ';
                this.state.timer = setInterval(() => {
                    this.state.timeLeft--;
                    txt.innerText = this.state.timeLeft + 'ì´ˆ';
                    bar.style.width = (this.state.timeLeft/60)*100 + '%';
                    if(this.state.timeLeft<=10) { bar.classList.add('timer-urgent'); txt.classList.add('animate-pulse'); }
                    if(this.state.timeLeft<=0) { clearInterval(this.state.timer); this.state.isTimeOut=true; alert("ì‹œê°„ ì¢…ë£Œ!"); this.finishQuiz(); }
                }, 1000);
            },
            renderQuestion: function() {
                const q = this.state.questions[this.state.currentIndex];
                document.getElementById('quiz-progress-text').innerText = `${this.state.currentIndex+1}/5`;
                document.getElementById('question-badge').innerText = {'choice':'ê°ê´€ì‹','blank':'ë¹ˆì¹¸','word':'ë‹¨ë‹µ','order':'ìˆœì„œ'}[q.type] || 'ë¬¸ì œ';
                document.getElementById('question-text').innerText = q.question;
                const area = document.getElementById('answer-area'); area.innerHTML = ''; 
                this.tempAnswer = this.state.answers[q.id] || null; // Restore previous answer if exists
                
                // Show/Hide Previous Button
                const btnPrev = document.getElementById('btn-prev');
                if (this.state.currentIndex === 0) btnPrev.classList.add('hidden');
                else btnPrev.classList.remove('hidden');

                if(q.type === 'choice') {
                    const grid = document.createElement('div'); grid.className="grid grid-cols-1 gap-3";
                    q.options.forEach((opt,i) => {
                        const btn = document.createElement('button');
                        // ê¸°ë³¸ ìŠ¤íƒ€ì¼
                        let baseClass = "w-full text-left p-4 rounded border border-stone-200 bg-white";
                        let innerSpanClass = "w-6 h-6 rounded-full bg-stone-200 inline-flex items-center justify-center text-xs font-bold mr-3";
                        
                        // ì´ë¯¸ ì„ íƒëœ ë‹µì•ˆì¸ ê²½ìš° ìŠ¤íƒ€ì¼ ì ìš©
                        if (this.tempAnswer === opt) {
                            baseClass = "w-full text-left p-4 rounded border-2 border-amber-600 bg-amber-600 text-white font-bold shadow-sm";
                            innerSpanClass = "w-6 h-6 rounded-full bg-white text-amber-600 inline-flex items-center justify-center text-xs font-bold mr-3";
                        }

                        btn.className = baseClass;
                        btn.innerHTML = `<span class="${innerSpanClass}">${i+1}</span> ${opt}`;
                        btn.onclick = () => {
                            Array.from(grid.children).forEach(c => {
                                c.className = "w-full text-left p-4 rounded border border-stone-200 bg-white";
                                c.querySelector('span').className = "w-6 h-6 rounded-full bg-stone-200 inline-flex items-center justify-center text-xs font-bold mr-3";
                            });
                            btn.className = "w-full text-left p-4 rounded border-2 border-amber-600 bg-amber-600 text-white font-bold shadow-sm";
                            btn.querySelector('span').className = "w-6 h-6 rounded-full bg-white text-amber-600 inline-flex items-center justify-center text-xs font-bold mr-3";
                            this.tempAnswer = opt;
                        };
                        grid.appendChild(btn);
                    });
                    area.appendChild(grid);
                } else if(q.type === 'order') {
                    this.orderTemp = [];
                    // ì´ë¯¸ ë‹µí•œ ë‚´ìš©ì´ ìˆìœ¼ë©´ íŒŒì‹±í•´ì„œ ë³µêµ¬
                    if (this.tempAnswer) {
                        this.orderTemp = this.tempAnswer.split('-');
                    }

                    const box = document.createElement('div'); box.className="border-2 dashed border-amber-300 rounded p-4 mb-3 bg-amber-50 min-h-[50px] flex flex-wrap gap-2";
                    const opts = document.createElement('div'); opts.className="flex flex-wrap gap-2";
                    
                    // ì •ë‹µ ë°•ìŠ¤ì— ì´ë¯¸ ì„ íƒëœ í•­ëª© ë¨¼ì € ì¶”ê°€
                    this.orderTemp.forEach(opt => {
                        const btn = document.createElement('button'); 
                        btn.className="px-3 py-2 bg-amber-600 text-white border rounded shadow-sm"; 
                        btn.innerText=opt;
                        btn.onclick = () => {
                            // í´ë¦­ ì‹œ ë‹¤ì‹œ ì•„ë˜ë¡œ ë‚´ë ¤ê° (ì‚­ì œ)
                            opts.appendChild(btn); 
                            btn.classList.remove('bg-amber-600','text-white');
                            this.orderTemp = this.orderTemp.filter(x=>x!==opt);
                        };
                        box.appendChild(btn);
                    });

                    // ë³´ê¸° ë°•ìŠ¤ì— ì„ íƒë˜ì§€ ì•Šì€ í•­ëª© ì¶”ê°€
                    q.options.sort(()=>0.5-Math.random()).forEach(opt => {
                        // ì´ë¯¸ ìœ„ìª½ì— ìˆìœ¼ë©´ ê±´ë„ˆëœ€
                        if (this.orderTemp.includes(opt)) {
                             // ëŒ€ì‹  ì•„ë˜ìª½ ë°•ìŠ¤ì— ì•ˆë³´ì´ê²Œ ë„£ê±°ë‚˜, ì•„ë˜ìª½ ë°•ìŠ¤ì— ë„£ì€ ë’¤ ìˆ¨ê¸°ëŠ” ë¡œì§ ë“±ì´ í•„ìš”í•˜ì§€ë§Œ
                             // ê°„ë‹¨í•˜ê²Œ: ìˆœì„œ ë§ì¶”ê¸°ëŠ” ë¡œì§ì´ ë³µì¡í•´ì§€ë¯€ë¡œ, ê·¸ëƒ¥ ì•„ë˜ìª½ì— ìƒì„±í•˜ë˜ í´ë¦­í•˜ë©´ ìœ„ë¡œ ì´ë™í•˜ëŠ” ê¸°ë³¸ ë¡œì§ ì‚¬ìš©.
                             // *ìˆ˜ì •*: ë³µêµ¬ ë¡œì§ì´ ë³µì¡í•˜ë¯€ë¡œ, ì´ë¯¸ ì„ íƒëœ ê²ƒì€ ìœ„ì—, ì•ˆëœ ê²ƒì€ ì•„ë˜ì— ë‘¡ë‹ˆë‹¤.
                             return; 
                        }
                        const btn = document.createElement('button'); btn.className="px-3 py-2 bg-white border rounded shadow-sm"; btn.innerText=opt;
                        btn.onclick = () => {
                            if(btn.parentElement===opts) { box.appendChild(btn); btn.classList.add('bg-amber-600','text-white'); this.orderTemp.push(opt); }
                            else { opts.appendChild(btn); btn.classList.remove('bg-amber-600','text-white'); this.orderTemp = this.orderTemp.filter(x=>x!==opt); }
                        };
                        opts.appendChild(btn);
                    });
                    
                    // ë³µêµ¬ëœ í•­ëª©ë“¤ì— ëŒ€í•´ì„œë„ í´ë¦­ ì´ë²¤íŠ¸ê°€ í•„ìš”í•˜ë¯€ë¡œ ìœ„ìª½ ë£¨í”„ ìˆ˜ì •
                    // (ìœ„ìª½ ë£¨í”„ì—ì„œ ìƒì„±ëœ ë²„íŠ¼ë“¤ë„ ë‹¤ì‹œ ë‚´ë ¤ê°ˆ ìˆ˜ ìˆì–´ì•¼ í•¨)
                    // ë³µì¡ì„±ì„ ì¤„ì´ê¸° ìœ„í•´, ì¬ë Œë”ë§ ì‹œ this.orderTempê°€ ìˆìœ¼ë©´ ê·¸ê²ƒìœ¼ë¡œ boxë¥¼ ì±„ì›ë‹ˆë‹¤.
                    // ìœ„ ì½”ë“œ íë¦„ìƒ orderTempì— ìˆëŠ”ê±´ boxì—, ì—†ëŠ”ê±´ optsì— ë„£ëŠ” ë¡œì§ìœ¼ë¡œ ì •ë¦¬ë¨.

                    area.append(box, opts);
                } else {
                    const inp = document.createElement('input'); inp.type="text"; inp.className="w-full p-4 border-b-2 border-stone-300 focus:border-amber-500 text-center text-lg outline-none";
                    inp.placeholder="ì •ë‹µ ì…ë ¥"; 
                    if(this.tempAnswer) inp.value = this.tempAnswer; // ê°’ ë³µêµ¬
                    inp.oninput = (e) => this.tempAnswer=e.target.value;
                    inp.onkeydown = (e) => { if(e.key==='Enter') this.submitAnswer(); };
                    area.appendChild(inp);
                }
            },
            
            // [ì¶”ê°€] ì´ì „ ë¬¸ì œ í•¨ìˆ˜
            prevQuestion: function() {
                // í˜„ì¬ ì…ë ¥ëœ ë‹µì´ ìˆìœ¼ë©´ ì €ì¥í•´ë‘  (ì„ íƒì‚¬í•­ì´ì§€ë§Œ UXìƒ ì¢‹ìŒ)
                // ë‹¨, ìˆœì„œë§ì¶”ê¸°ëŠ” ì²˜ë¦¬ê°€ ë³µì¡í•˜ë¯€ë¡œ, ì¼ë‹¨ 'ì´ì „' ëˆ„ë¥´ë©´ í˜„ì¬ ë¬¸ì œëŠ” ì €ì¥ ì•ˆí•˜ê³  ë„˜ì–´ê°€ëŠ” ê²ƒìœ¼ë¡œ ì²˜ë¦¬í•˜ê±°ë‚˜
                // í˜„ì¬ ë¡œì§ìƒ this.tempAnswerê°€ ìˆìœ¼ë©´ ì €ì¥.
                if (this.tempAnswer) {
                    if (this.state.questions[this.state.currentIndex].type === 'order') {
                         if (this.orderTemp && this.orderTemp.length > 0) {
                             this.state.answers[this.state.questions[this.state.currentIndex].id] = this.orderTemp.join('-');
                         }
                    } else {
                        this.state.answers[this.state.questions[this.state.currentIndex].id] = this.tempAnswer;
                    }
                }

                if (this.state.currentIndex > 0) {
                    this.state.currentIndex--;
                    this.renderQuestion();
                }
            },

            submitAnswer: function() {
                const q = this.state.questions[this.state.currentIndex];
                let ans = this.tempAnswer;
                
                // ìˆœì„œ ë§ì¶”ê¸°ì˜ ê²½ìš° orderTemp ì‚¬ìš©
                if(q.type==='order') {
                    // ë‹¤ìŒ ë¬¸ì œë¡œ ë„˜ì–´ê°ˆ ë•ŒëŠ” ì™„ì„± ì—¬ë¶€ ì²´í¬
                    if(!this.orderTemp || this.orderTemp.length !== q.options.length) { alert("ìˆœì„œë¥¼ ì™„ì„±í•˜ì„¸ìš”"); return; }
                    ans = this.orderTemp.join('-');
                } else {
                    if(!ans) { alert("ì •ë‹µì„ ì…ë ¥í•˜ì„¸ìš”"); return; }
                }
                
                this.state.answers[q.id] = ans;
                if(this.state.currentIndex < 4) { this.state.currentIndex++; this.renderQuestion(); }
                else this.finishQuiz();
            },
            finishQuiz: function() {
                clearInterval(this.state.timer);
                let correct = 0; let details = [];
                this.state.questions.forEach(q => {
                    const u = (this.state.answers[q.id]||"").toString().replace(/\s+/g,'').trim();
                    const a = q.answer.toString().replace(/\s+/g,'').trim();
                    let isC = (q.type==='word') ? (u.includes(a)||a.includes(u)) : (u===a);
                    if(isC) correct++; else details.push({q:q.question, u:u||"ë¯¸ì…ë ¥", a:q.answer, exp:q.explanation});
                });
                this.state.score = correct * 20; this.state.incorrectDetails = details;
                this.showView('view-results'); this.renderResults(); this.saveToFirebase();
            },
            renderResults: function() {
                document.getElementById('result-name').innerText = this.state.student.name;
                document.getElementById('score-text').innerText = this.state.score;
                const ctx = document.getElementById('scoreChart').getContext('2d');
                if(window.myChart) window.myChart.destroy();
                window.myChart = new Chart(ctx, { type:'doughnut', data:{labels:['ì •ë‹µ','ì˜¤ë‹µ'], datasets:[{data:[this.state.score, 100-this.state.score], backgroundColor:['#d97706','#e5e7eb'], borderWidth:0}]}, options:{cutout:'80%', plugins:{legend:{display:false}}} });
                const list = document.getElementById('review-list');
                list.innerHTML = this.state.incorrectDetails.length===0 ? '<div class="text-center py-4">ë§Œì ì…ë‹ˆë‹¤! ğŸ‰</div>' : this.state.incorrectDetails.map(d => `<div class="border-b pb-3 last:border-0"><p class="font-bold text-stone-800 mb-1">Q. ${d.q}</p><div class="flex gap-2 text-xs mb-2"><span class="text-red-600 bg-red-50 px-2 py-1 rounded">ë‚´ ë‹µ: ${d.u}</span><span class="text-green-600 bg-green-50 px-2 py-1 rounded font-bold">ì •ë‹µ: ${d.a}</span></div><p class="text-xs text-stone-500 bg-stone-50 p-2 rounded">${d.exp}</p></div>`).join('');
            },

            // --- Firebase ì €ì¥ (í•µì‹¬) ---
            saveToFirebase: function() {
                const status = document.getElementById('submission-status');
                if(!db) { status.innerHTML = "âš ï¸ DB ì—°ê²° ì‹¤íŒ¨ (ì„¤ì • í•„ìš”)"; return; }
                
                const data = {
                    timestamp: firebase.firestore.FieldValue.serverTimestamp(),
                    timeString: new Date().toLocaleString(),
                    class: this.state.student.class,
                    number: this.state.student.number,
                    name: this.state.student.name,
                    score: this.state.score,
                    status: this.state.isTimeOut ? "ì‹œê°„ì´ˆê³¼" : "ì™„ë£Œ"
                };

                // ì»¬ë ‰ì…˜ ì´ë¦„ì„ 'quiz_results'ë¡œ ì‚¬ìš©
                db.collection("quiz_results").add(data)
                .then(() => {
                    status.className = "bg-green-100 text-green-700 p-3 rounded text-sm mb-6 border border-green-200 font-bold";
                    status.innerHTML = '<i class="fas fa-check-circle"></i> ì œì¶œ ì™„ë£Œ!';
                })
                .catch((error) => {
                    console.error("Error adding document: ", error);
                    status.className = "bg-red-100 text-red-700 p-3 rounded text-sm mb-6 border border-red-200";
                    status.innerHTML = 'âš ï¸ ì „ì†¡ ì‹¤íŒ¨. (ë„¤íŠ¸ì›Œí¬ í™•ì¸)';
                });
            },

            // --- êµì‚¬ìš© í™”ë©´ ---
            toggleTeacherMode: function() {
                if(this.state.isTeacherMode) { this.closeTeacherMode(); return; }
                const pw = prompt("êµì‚¬ìš© ë¹„ë°€ë²ˆí˜¸:");
                if(pw==='0423') { this.state.isTeacherMode=true; this.showView('view-teacher'); this.loadLogs(); }
                else if(pw!==null) alert("ë¹„ë°€ë²ˆí˜¸ ì˜¤ë¥˜");
            },
            closeTeacherMode: function() { this.state.isTeacherMode=false; this.showView('view-login'); },
            showView: function(id) { document.querySelectorAll('main > section').forEach(el => el.classList.add('hidden')); document.getElementById(id).classList.remove('hidden'); window.scrollTo(0,0); },
            toggleReview: function() { document.getElementById('review-section').classList.toggle('hidden'); },
            setTeacherTab: function(tab) {
                ['log','bank','add'].forEach(t => document.getElementById('tab-'+t).classList.add('hidden'));
                document.getElementById('tab-'+tab).classList.remove('hidden');
                ['log','bank','add'].forEach(t => {
                    const btn = document.getElementById('btn-tab-'+t);
                    if(t===tab) btn.className = "px-5 py-2 rounded-full bg-stone-800 text-white text-sm font-bold shadow transition";
                    else btn.className = "px-5 py-2 rounded-full bg-stone-100 text-stone-600 text-sm font-bold hover:bg-stone-200 shadow transition";
                });
                if(tab === 'log') this.loadServerLogs();
                else this.renderBank();
            },
            
            // --- Firebase ë°ì´í„° ë¶ˆëŸ¬ì˜¤ê¸° ---
            loadServerLogs: function() {
                if(!db) return;
                const tbody = document.getElementById('teacher-log-body');
                tbody.innerHTML = '<tr><td colspan="4" class="p-4 text-center">ë¡œë”© ì¤‘...</td></tr>';
                
                db.collection("quiz_results").orderBy("timestamp", "desc").limit(50).get().then((querySnapshot) => {
                    let html = '';
                    let count = 0;
                    let logs = []; // ì—‘ì…€ ë‹¤ìš´ë¡œë“œìš©
                    querySnapshot.forEach((doc) => {
                        const d = doc.data();
                        count++;
                        logs.push(d);
                        html += `<tr class="border-b hover:bg-stone-50"><td class="p-3 text-stone-500 text-xs">${d.timeString}</td><td class="p-3 font-medium">${d.class}ë°˜ ${d.number}ë²ˆ ${d.name}</td><td class="p-3 font-bold text-amber-600">${d.score}</td><td class="p-3 text-xs">${d.status}</td></tr>`;
                    });
                    tbody.innerHTML = html || '<tr><td colspan="4" class="p-4 text-center">ê¸°ë¡ ì—†ìŒ</td></tr>';
                    document.getElementById('log-count').innerText = `(${count}ê±´)`;
                    this.state.logs = logs; // ì €ì¥
                }).catch((error) => {
                    console.error("Error getting documents: ", error);
                    tbody.innerHTML = '<tr><td colspan="4" class="p-4 text-center text-red-500">ë°ì´í„° ë¡œë”© ì‹¤íŒ¨</td></tr>';
                });
            },
            // ì²˜ìŒ íƒ­ ì—´ë¦´ ë•Œ ê¸°ë³¸ ì‹¤í–‰
            loadLogs: function() { this.loadServerLogs(); },

            downloadExcel: function() {
                if(!this.state.logs || !this.state.logs.length) { alert("ë°ì´í„°ê°€ ì—†ìŠµë‹ˆë‹¤."); return; }
                let csv = "\uFEFFì‹œê°„,ë°˜,ë²ˆí˜¸,ì´ë¦„,ì ìˆ˜,ìƒíƒœ\n" + this.state.logs.map(l => `${l.timeString},${l.class},${l.number},${l.name},${l.score},${l.status}`).join("\n");
                const link = document.createElement("a"); link.href = "data:text/csv;charset=utf-8," + encodeURI(csv);
                link.download = "ì—­ì‚¬í‰ê°€_ê²°ê³¼.csv"; link.click();
            },
            renderBank: function() {
                document.getElementById('bank-body').innerHTML = this.state.allQuestions.map(q => `<tr class="border-b hover:bg-stone-50"><td class="p-3 text-xs text-stone-400">#${q.id}</td><td class="p-3 text-xs"><span class="bg-stone-100 border px-1 rounded">${q.type}</span></td><td class="p-3 text-sm text-stone-800">${q.question}</td><td class="p-3 text-xs font-bold text-amber-700">${q.answer}</td></tr>`).join('');
            },
            toggleOptionInput: function() {
                const t = document.getElementById('new-q-type').value;
                document.getElementById('option-container').classList.toggle('hidden', !(t==='choice'||t==='order'));
            },
            addCustomQuestion: function() {
                const t = document.getElementById('new-q-type').value;
                const q = document.getElementById('new-q-text').value.trim();
                const a = document.getElementById('new-q-answer').value.trim();
                const e = document.getElementById('new-q-exp').value.trim();
                let o = [];
                if(!q || !a) { alert("í•„ìˆ˜ ì…ë ¥"); return; }
                if(t==='choice'||t==='order') {
                    const ot = document.getElementById('new-q-options').value.trim();
                    if(!ot) { alert("ë³´ê¸°ë¥¼ ì…ë ¥í•˜ì„¸ìš”."); return; }
                    o = ot.split(',').map(s=>s.trim());
                }
                const newQ = { id: 1000+this.state.customBank.length, type: t, question: q, options: o.length?o:null, answer: a, explanation: e||"í•´ì„¤ ì—†ìŒ" };
                this.state.customBank.push(newQ);
                localStorage.setItem('hq_custom_q', JSON.stringify(this.state.customBank));
                alert("ì¶”ê°€ë¨"); this.renderBank();
            },
            resetCustomQuestions: function() {
                if(confirm("ì´ˆê¸°í™”?")) { this.state.customBank=[]; localStorage.removeItem('hq_custom_q'); this.renderBank(); }
            }
        };

        window.app = app;
        window.onload = function() { app.init(); };
    </script>
</body>
</html>
