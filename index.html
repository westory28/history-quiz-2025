<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ìš©ì‹ ì¤‘í•™êµ ì—­ì‚¬êµì‚¬ ë°©ì¬ì„</title>
    
    <!-- í•„ìˆ˜ ë¼ì´ë¸ŒëŸ¬ë¦¬ -->
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    
    <!-- Firebase SDK -->
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-firestore.js"></script>

    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+KR:wght@400;500;700&family=Noto+Serif+KR:wght@700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">

    <style>
        body { font-family: 'Noto Sans KR', sans-serif; background-color: #f5f5f4; }
        .serif { font-family: 'Noto Serif KR', serif; }
        .fade-in { animation: fadeIn 0.3s ease-in-out; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(5px); } to { opacity: 1; transform: translateY(0); } }
        
        .timer-bar { transition: width 1s linear; }
        .timer-urgent { background-color: #ef4444 !important; animation: pulse 1s infinite; }
        @keyframes pulse { 0%, 100% { opacity: 1; } 50% { opacity: 0.5; } }

        .teacher-btn {
            background-color: #44403c; color: white; padding: 6px 12px;
            border-radius: 8px; font-size: 0.85rem; font-weight: bold;
            display: flex; align-items: center; gap: 6px; cursor: pointer;
            border: 1px solid #57534e; z-index: 50;
        }
        .teacher-btn:hover { background-color: #292524; }

        .modal-overlay { background-color: rgba(0, 0, 0, 0.5); }
        
        /* í…Œì´ë¸” ìŠ¤íƒ€ì¼ */
        .admin-table th, .admin-table td { border-bottom: 1px solid #e5e7eb; vertical-align: middle; }
        .admin-table th:not(:last-child), .admin-table td:not(:last-child) { border-right: 2px solid #d6d3d1; }
        .col-answer { background-color: #fffbeb; color: #b45309; font-weight: bold; }

        .seq-btn { padding: 8px 12px; border-radius: 6px; font-weight: bold; border: 1px solid #d1d5db; transition: all 0.2s; cursor: pointer; margin: 4px; }
        .seq-btn-default { background-color: #ffffff !important; color: #1f2937 !important; }
        .seq-btn-selected { background-color: #d97706 !important; color: #ffffff !important; border-color: #b45309 !important; box-shadow: 0 2px 4px rgba(0,0,0,0.1); }

        .ox-btn { height: 80px; font-size: 2.5rem; font-weight: 900; border-radius: 12px; transition: all 0.2s; border: 2px solid transparent; width: 100%; }
        .ox-btn:hover { transform: translateY(-2px); box-shadow: 0 4px 6px rgba(0,0,0,0.1); }
        .btn-o { background-color: #e0f2fe; color: #0284c7; border-color: #0284c7; }
        .btn-o.selected { background-color: #0284c7; color: white; }
        .btn-x { background-color: #fee2e2; color: #dc2626; border-color: #dc2626; }
        .btn-x.selected { background-color: #dc2626; color: white; }

        #loading-overlay { display: none; position: fixed; inset: 0; background: rgba(255,255,255,0.9); z-index: 9999; justify-content: center; align-items: center; flex-direction: column; }
        
        .logo-btn { cursor: pointer; transition: opacity 0.2s; }
        .logo-btn:hover { opacity: 0.8; }
        
        .q-image-thumb { max-width: 100%; max-height: 250px; border-radius: 8px; margin: 10px auto; border: 1px solid #e5e7eb; display: block; object-fit: contain; cursor: zoom-in; transition: transform 0.2s; }
        .q-image-thumb:hover { transform: scale(1.02); }

        #image-zoom-modal { display: none; position: fixed; inset: 0; background: rgba(0,0,0,0.9); z-index: 10000; justify-content: center; align-items: center; cursor: zoom-out; }
        #image-zoom-content { max-width: 95%; max-height: 95%; border-radius: 4px; }
        
        .rate-bar-bg { background-color: #e5e7eb; height: 6px; border-radius: 3px; overflow: hidden; width: 100%; margin-top: 4px; }
        .rate-bar-fill { height: 100%; transition: width 0.5s ease; }

        /* ì²´í¬ë°•ìŠ¤ ìŠ¤íƒ€ì¼ */
        .custom-checkbox { width: 18px; height: 18px; cursor: pointer; }
    </style>
</head>
<body class="text-stone-800 min-h-screen flex flex-col">

    <div id="loading-overlay">
        <div class="animate-spin rounded-full h-16 w-16 border-t-4 border-amber-600 border-solid mb-4"></div>
        <p class="text-xl font-bold text-stone-700" id="loading-text">ë°ì´í„° ì²˜ë¦¬ ì¤‘...</p>
    </div>

    <div id="image-zoom-modal" onclick="app.closeImageZoom()">
        <img id="image-zoom-content" src="" alt="í™•ëŒ€ ì´ë¯¸ì§€">
    </div>

    <header class="bg-stone-900 text-white py-4 shadow-lg sticky top-0 z-40">
        <div class="container mx-auto px-4 flex justify-between items-center relative">
            <h1 class="text-lg md:text-xl font-bold tracking-tight truncate pr-2 logo-btn" onclick="app.goToMain()">
                <span class="mr-2">ğŸ§‘â€ğŸ«</span> ìš©ì‹ ì¤‘í•™êµ ì—­ì‚¬êµì‚¬ ë°©ì¬ì„
            </h1>
            <button id="btn-teacher-mode" class="teacher-btn">
                <i class="fas fa-lock"></i> êµì‚¬
            </button>
        </div>
    </header>

    <main class="flex-grow container mx-auto px-4 py-6">
        
        <!-- 1. ë¡œê·¸ì¸ -->
        <section id="view-login" class="max-w-md mx-auto bg-white p-8 rounded-xl shadow-lg fade-in mt-8 border-t-4 border-amber-500">
            <div class="text-center mb-8">
                <span class="bg-amber-100 text-amber-900 text-sm font-bold px-3 py-1 rounded-full">ìš©ì‹ ì¤‘í•™êµ 2í•™ë…„ 2í•™ê¸° ì—­ì‚¬1</span>
                <h2 class="text-2xl font-bold serif text-stone-900 mt-4">ë‹¹ì‹ ì˜ ì—­ì‚¬ ì‹¤ë ¥ì€?</h2>
                <p class="text-red-500 font-bold text-sm mt-2"><i class="fas fa-stopwatch mr-1"></i> ì œí•œì‹œê°„ 60ì´ˆ (5ë¬¸ì œ)</p>
            </div>
            <div class="space-y-4">
                <div>
                    <label class="text-xs font-bold text-stone-500 block mb-1">í•™ë²ˆ ì •ë³´</label>
                    <div class="flex gap-2">
                        <div class="w-1/4 bg-stone-100 border border-stone-300 rounded flex items-center justify-center font-bold text-stone-600">2í•™ë…„</div>
                        <select id="input-class" class="w-2/4 p-3 border border-stone-300 rounded focus:border-amber-500 outline-none">
                            <option value="">ë°˜ ì„ íƒ</option>
                            <option value="1">1ë°˜</option><option value="2">2ë°˜</option><option value="3">3ë°˜</option><option value="4">4ë°˜</option><option value="5">5ë°˜</option><option value="6">6ë°˜</option><option value="7">7ë°˜</option><option value="8">8ë°˜</option><option value="9">9ë°˜</option><option value="10">10ë°˜</option>
                        </select>
                        <input type="number" id="input-number" placeholder="ë²ˆí˜¸" class="w-1/4 p-3 border border-stone-300 rounded focus:border-amber-500 outline-none text-center">
                    </div>
                </div>
                <div>
                    <label class="text-xs font-bold text-stone-500 block mb-1">ì´ë¦„</label>
                    <input type="text" id="input-name" placeholder="ì´ë¦„ ì…ë ¥" class="w-full p-3 border border-stone-300 rounded focus:border-amber-500 outline-none">
                </div>
                <button onclick="app.startQuiz()" class="w-full bg-stone-900 text-white font-bold py-4 rounded-lg hover:bg-stone-700 transition shadow-lg mt-4 transform active:scale-95">ë„ì „ ì‹œì‘ <i class="fas fa-play ml-2"></i></button>
            </div>
        </section>

        <!-- 2. í€´ì¦ˆ í™”ë©´ -->
        <section id="view-quiz" class="hidden max-w-2xl mx-auto fade-in">
            <div class="bg-white rounded-lg shadow-sm mb-6 sticky top-20 z-30 overflow-hidden border border-stone-200">
                <div class="flex justify-between items-center px-4 py-2 bg-stone-50 border-b border-stone-100">
                    <span class="text-sm font-bold text-stone-600" id="quiz-progress-text">1 / 5</span>
                    <span class="text-lg font-bold text-red-600 font-mono" id="timer-text">60ì´ˆ</span>
                </div>
                <div class="w-full bg-stone-200 h-2"><div id="timer-bar" class="bg-amber-500 h-full timer-bar" style="width: 100%"></div></div>
            </div>
            <div class="bg-white p-6 md:p-10 rounded-lg min-h-[400px] flex flex-col relative shadow-md">
                <div class="mb-4">
                    <!-- ëŒ€ë‹¨ì› í‘œì‹œ -->
                    <span id="student-question-unit" class="inline-block bg-stone-100 text-stone-500 text-xs font-bold px-3 py-1 rounded-md mb-2 border border-stone-200"></span>
                    <div class="flex justify-between items-center">
                        <span id="question-badge" class="bg-amber-100 text-amber-800 text-xs font-bold px-2 py-1 rounded border border-amber-200">ìœ í˜•</span>
                    </div>
                </div>
                <div id="question-image-area" class="mb-4 hidden text-center">
                    <img id="question-image" src="" alt="ë¬¸ì œ ì´ë¯¸ì§€" class="q-image-thumb" onclick="app.openImageZoom(this.src)">
                </div>
                <h3 id="question-text" class="text-xl md:text-2xl font-bold mt-2 mb-8 text-stone-900 leading-relaxed serif break-keep"></h3>
                <div id="answer-area" class="flex-grow mb-6"></div>
                <div class="flex gap-3 mt-auto">
                    <button id="btn-prev" onclick="app.prevQuestion()" class="hidden w-1/3 bg-stone-200 text-stone-700 font-bold py-4 rounded-lg hover:bg-stone-300 transition shadow-sm"><i class="fas fa-chevron-left mr-1"></i> ì´ì „</button>
                    <button id="btn-next" onclick="app.submitAnswer()" class="w-full bg-amber-600 text-white font-bold py-4 rounded-lg hover:bg-amber-700 transition shadow-md">ë‹¤ìŒ <i class="fas fa-chevron-right ml-1"></i></button>
                </div>
            </div>
        </section>

        <!-- 3. ê²°ê³¼ í™”ë©´ -->
        <section id="view-results" class="hidden max-w-lg mx-auto fade-in mt-6">
            <div class="bg-white p-8 rounded-xl shadow-xl text-center border-t-8 border-amber-500">
                <h2 class="text-3xl font-bold serif mb-2 text-stone-800">í‰ê°€ ì¢…ë£Œ</h2>
                <p class="text-stone-500 mb-6"><span id="result-name" class="font-bold text-stone-900"></span> í•™ìƒì˜ ìµœì¢… ê¸°ë¡</p>
                <div class="relative w-48 h-48 mx-auto mb-4">
                    <canvas id="scoreChart"></canvas>
                    <div class="absolute inset-0 flex items-center justify-center flex-col"><span class="text-5xl font-bold text-amber-600 font-mono" id="score-text">0</span><span class="text-xs text-stone-400">ì </span></div>
                </div>
                <div id="submission-status" class="bg-stone-50 p-3 rounded text-sm mb-6 border border-stone-200 text-stone-500"><i class="fas fa-circle-notch fa-spin"></i> ë°ì´í„° ì €ì¥ ì¤‘...</div>
                <div class="grid grid-cols-2 gap-3">
                    <button onclick="app.toggleReview()" class="bg-white border-2 border-stone-200 text-stone-700 font-bold py-3 rounded hover:bg-stone-50 hover:border-stone-400 transition"><i class="fas fa-book-open mr-1"></i> ì˜¤ë‹µë…¸íŠ¸</button>
                    <button onclick="location.reload()" class="bg-stone-900 text-white font-bold py-3 rounded hover:bg-stone-700 transition shadow-lg"><i class="fas fa-redo mr-1"></i> ë‹¤ì‹œ ë„ì „</button>
                </div>
            </div>
            <div id="review-section" class="hidden mt-6 bg-white p-6 rounded-xl shadow-lg border border-red-200">
                <h3 class="font-bold text-lg mb-4 text-red-600 border-b pb-2"><i class="fas fa-check-circle"></i> ì˜¤ë‹µ í™•ì¸</h3>
                <div id="review-list" class="space-y-4 text-left"></div>
            </div>
        </section>

        <!-- 4. êµì‚¬ ëŒ€ì‹œë³´ë“œ -->
        <section id="view-teacher" class="hidden max-w-6xl mx-auto bg-white p-6 rounded shadow-xl mt-4 border border-stone-300 relative">
            <div class="flex justify-between items-center mb-6 border-b pb-4">
                <div><h2 class="font-bold text-2xl text-stone-800"><i class="fas fa-chalkboard-teacher text-amber-600 mr-2"></i>êµì‚¬ ëŒ€ì‹œë³´ë“œ</h2><p class="text-xs text-stone-500 mt-1">ë¹„ë°€ë²ˆí˜¸: 19960423 | <span class="text-blue-600 font-bold">Firebase ì—°ë™ë¨</span></p></div>
                <button onclick="app.closeTeacherMode()" class="bg-stone-200 hover:bg-stone-300 text-stone-700 px-4 py-2 rounded text-sm font-bold">ë‚˜ê°€ê¸°</button>
            </div>
            <div class="flex flex-wrap gap-2 mb-6">
                <button onclick="app.setTeacherTab('log')" id="btn-tab-log" class="px-5 py-2 rounded-full bg-stone-800 text-white text-sm font-bold shadow transition"><i class="fas fa-list mr-1"></i> ì‹¤ì‹œê°„ ê¸°ë¡</button>
                <button onclick="app.setTeacherTab('bank')" id="btn-tab-bank" class="px-5 py-2 rounded-full bg-stone-100 text-stone-600 text-sm font-bold hover:bg-stone-200 shadow transition"><i class="fas fa-database mr-1"></i> ë¬¸ì œ ì€í–‰ & ë¶„ì„</button>
                <button onclick="app.setTeacherTab('add')" id="btn-tab-add" class="px-5 py-2 rounded-full bg-stone-100 text-stone-600 text-sm font-bold hover:bg-stone-200 shadow transition"><i class="fas fa-plus-circle mr-1"></i> ë¬¸ì œ ì¶”ê°€/ì—…ë¡œë“œ</button>
            </div>

            <!-- íƒ­: ê¸°ë¡ (ì„¸ë¶€ ë“œë¡­ë‹¤ìš´, ì‚­ì œ ì²´í¬ë°•ìŠ¤ ì¶”ê°€) -->
            <div id="tab-log">
                <div class="flex justify-between items-center mb-4 flex-wrap gap-2">
                    <h3 class="font-bold text-lg flex items-center">ì œì¶œ í˜„í™© <span id="log-count" class="text-sm font-normal text-stone-500 ml-2">(ë¡œë”©ì¤‘...)</span></h3>
                    <div class="flex gap-2 items-center">
                        <select id="filter-class" onchange="app.renderLogs()" class="p-2 border rounded text-sm bg-white"><option value="all">ì „ì²´ ë°˜</option><option value="1">1ë°˜</option><option value="2">2ë°˜</option><option value="3">3ë°˜</option><option value="4">4ë°˜</option><option value="5">5ë°˜</option><option value="6">6ë°˜</option><option value="7">7ë°˜</option><option value="8">8ë°˜</option><option value="9">9ë°˜</option><option value="10">10ë°˜</option></select>
                        <select id="sort-logs" onchange="app.renderLogs()" class="p-2 border rounded text-sm bg-white"><option value="time">ìµœì‹ ìˆœ</option><option value="number">ë²ˆí˜¸ìˆœ</option><option value="score_desc">ì ìˆ˜ ë†’ì€ìˆœ</option><option value="score_asc">ì ìˆ˜ ë‚®ì€ìˆœ</option></select>
                        <button onclick="app.deleteSelectedLogs()" class="bg-red-500 hover:bg-red-600 text-white px-3 py-2 rounded text-sm font-bold shadow"><i class="fas fa-trash"></i> ì„ íƒ ì‚­ì œ</button>
                        <button onclick="app.loadServerLogs()" class="bg-blue-600 hover:bg-blue-700 text-white px-3 py-2 rounded text-sm font-bold shadow"><i class="fas fa-sync-alt"></i></button>
                        <button onclick="app.downloadExcel()" class="bg-green-600 hover:bg-green-700 text-white px-3 py-2 rounded text-sm font-bold shadow"><i class="fas fa-file-excel"></i></button>
                    </div>
                </div>
                <div class="overflow-auto max-h-[500px] border rounded bg-stone-50">
                    <table class="w-full text-sm text-left admin-table">
                        <thead class="bg-stone-200 text-stone-700 sticky top-0 font-bold">
                            <tr>
                                <th class="p-3 w-10 text-center"><input type="checkbox" onchange="app.toggleAllLogs(this)"></th>
                                <th class="p-3">ì‹œê°„</th><th class="p-3">ì •ë³´</th><th class="p-3">ì ìˆ˜</th><th class="p-3">ìƒíƒœ</th>
                            </tr>
                        </thead>
                        <tbody id="teacher-log-body" class="bg-white"></tbody>
                    </table>
                </div>
            </div>

            <!-- íƒ­: ë¬¸ì œ ì€í–‰ (í•„í„°, ì²´í¬ë°•ìŠ¤ ì‚­ì œ ì¶”ê°€, ì´ˆê¸°í™” ë²„íŠ¼ ì œê±°) -->
            <div id="tab-bank" class="hidden">
                <div class="flex flex-col md:flex-row justify-between items-center mb-4 bg-stone-50 p-3 rounded border border-stone-200 gap-3">
                    <div class="flex items-center gap-2"><h3 class="font-bold text-lg">ì „ì²´ ë¬¸ì œ ë¦¬ìŠ¤íŠ¸ <span id="total-q-count" class="text-sm text-stone-500"></span></h3></div>
                    <div class="flex gap-2 flex-wrap">
                        <select id="bank-sort" onchange="app.renderBank()" class="p-2 border rounded text-xs">
                            <option value="id">ë²ˆí˜¸ìˆœ</option>
                            <option value="unit">ë‹¨ì›ìˆœ</option>
                            <option value="type">ìœ í˜•ìˆœ</option>
                            <option value="rate_asc">ì •ë‹µë¥  ë‚®ì€ ìˆœ</option>
                            <option value="rate_desc">ì •ë‹µë¥  ë†’ì€ ìˆœ</option>
                        </select>
                        <select id="bank-filter-unit" onchange="app.renderBank()" class="p-2 border rounded text-xs w-32"><option value="all">ëª¨ë“  ë‹¨ì›</option><option value="I.">I. ê³ ëŒ€</option><option value="II.">II. ì¢…êµ/ë¬¸í™”</option><option value="III.">III. ì§€ì—­êµë¥˜</option><option value="IV.">IV. ì œêµ­ì£¼ì˜</option><option value="V.">V. ì„¸ê³„ëŒ€ì „</option></select>
                        <select id="bank-filter-type" onchange="app.renderBank()" class="p-2 border rounded text-xs"><option value="all">ëª¨ë“  ìœ í˜•</option><option value="choice">ê°ê´€ì‹</option><option value="word">ë‹¨ë‹µí˜•</option><option value="ox">O/X</option><option value="order">ìˆœì„œ</option></select>
                        <button onclick="app.deleteSelectedQuestions()" class="bg-red-500 hover:bg-red-600 text-white px-3 py-2 rounded text-xs font-bold shadow"><i class="fas fa-trash"></i> ì„ íƒ ì‚­ì œ</button>
                    </div>
                </div>
                <div class="overflow-auto max-h-[500px] border rounded bg-stone-50">
                    <table class="w-full text-sm text-left admin-table table-bordered">
                        <thead class="bg-stone-200 text-stone-700 sticky top-0 font-bold">
                            <tr>
                                <th class="p-3 w-10 text-center"><input type="checkbox" onchange="app.toggleAllQuestions(this)"></th>
                                <th class="p-3 w-16 text-center">ID</th>
                                <th class="p-3 w-32">ë‹¨ì›</th>
                                <th class="p-3 w-20 text-center">ìœ í˜•</th>
                                <th class="p-3">ë¬¸ì œ</th>
                                <th class="p-3 w-20 text-center">ë¯¸ë¦¬ë³´ê¸°</th>
                                <th class="p-3 w-32 col-answer text-center">ì •ë‹µ</th>
                                <th class="p-3 w-24 text-center">ì •ë‹µë¥ </th>
                            </tr>
                        </thead>
                        <tbody id="bank-body" class="bg-white"></tbody>
                    </table>
                </div>
            </div>

            <!-- íƒ­: ë¬¸ì œ ì¶”ê°€ -->
            <div id="tab-add" class="hidden">
                <!-- ê¸°ì¡´ê³¼ ë™ì¼í•œ ë¬¸ì œ ì¶”ê°€ UI -->
                <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                    <div class="bg-stone-50 p-6 rounded border border-stone-200">
                        <div class="flex justify-between items-center mb-4 border-b pb-2"><h3 class="font-bold text-xl">ì§ì ‘ ë¬¸ì œ ë§Œë“¤ê¸°</h3><span id="next-q-id-display" class="bg-amber-100 text-amber-800 text-xs font-bold px-3 py-1 rounded-full border border-amber-200"></span></div>
                        <div class="space-y-4">
                            <div><label class="block text-sm font-bold mb-1">ë‹¨ì› ì„ íƒ</label><select id="new-q-unit" class="w-full p-2 border rounded bg-white"><option value="I. ë¬¸ëª…ì˜ ë°œìƒê³¼ ê³ ëŒ€ ì„¸ê³„ì˜ í˜•ì„±">I. ê³ ëŒ€ ì„¸ê³„</option><option value="II. ì„¸ê³„ ì¢…êµì˜ í™•ì‚°ê³¼ ì§€ì—­ ë¬¸í™”ì˜ í˜•ì„±">II. ì„¸ê³„ ì¢…êµ/ì§€ì—­ ë¬¸í™”</option><option value="III. ì§€ì—­ ì„¸ê³„ì˜ êµë¥˜ì™€ ë³€í™”">III. ì§€ì—­ ì„¸ê³„ êµë¥˜</option><option value="IV. ì œêµ­ì£¼ì˜ ì¹¨ëµê³¼ êµ­ë¯¼ êµ­ê°€ ê±´ì„¤ ìš´ë™">IV. ì œêµ­ì£¼ì˜/êµ­ë¯¼ êµ­ê°€</option><option value="V. ì„¸ê³„ ëŒ€ì „ê³¼ ì‚¬íšŒ ë³€ë™">V. ì„¸ê³„ ëŒ€ì „/ì‚¬íšŒ ë³€ë™</option></select></div>
                            <div><label class="block text-sm font-bold mb-1">ìœ í˜•</label><select id="new-q-type" class="w-full p-2 border rounded" onchange="app.toggleOptionInput('new')"><option value="choice">ê°ê´€ì‹</option><option value="word">ë‹¨ë‹µí˜•</option><option value="order">ìˆœì„œ ë§ì¶”ê¸°</option><option value="ox">O/X í€´ì¦ˆ</option></select></div>
                            <div><label class="block text-sm font-bold mb-1">ì´ë¯¸ì§€ (ì„ íƒ)</label><input type="file" id="new-q-image" accept="image/*" class="w-full text-xs p-2 border rounded bg-white" onchange="app.handleImageUpload(this, 'new')"><img id="new-q-image-preview" class="hidden mt-2 h-20 rounded border border-gray-300"><input type="hidden" id="new-q-image-base64"></div>
                            <div><label class="block text-sm font-bold mb-1">ë¬¸ì œ</label><textarea id="new-q-text" class="w-full p-2 border rounded h-20"></textarea></div>
                            <div id="option-container-new"><label class="block text-sm font-bold mb-1">ë³´ê¸° (ì½¤ë§ˆë¡œ êµ¬ë¶„)</label><input type="text" id="new-q-options" class="w-full p-2 border rounded" placeholder="ì˜ˆ: A, B, C, D"></div>
                            <div><label class="block text-sm font-bold mb-1">ì •ë‹µ</label><input type="text" id="new-q-answer" class="w-full p-2 border rounded"></div>
                            <div><label class="block text-sm font-bold mb-1">í•´ì„¤</label><input type="text" id="new-q-exp" class="w-full p-2 border rounded"></div>
                            <button onclick="app.addCustomQuestion()" class="w-full bg-amber-600 text-white font-bold py-3 rounded hover:bg-amber-700 transition">ì¶”ê°€í•˜ê¸°</button>
                        </div>
                    </div>
                    <div class="bg-green-50 p-6 rounded border border-green-200 h-fit">
                        <h3 class="font-bold text-xl mb-4 border-b pb-2 text-green-800">ì—‘ì…€ ì¼ê´„ ì—…ë¡œë“œ</h3>
                        <input type="file" id="excel-file" accept=".xlsx, .xls" class="block w-full text-sm text-slate-500 file:mr-4 file:py-2 file:px-4 file:rounded-full file:border-0 file:text-sm file:font-semibold file:bg-green-100 file:text-green-700 hover:file:bg-green-200 mb-4"/>
                        <button onclick="app.uploadExcel()" class="w-full bg-green-600 text-white font-bold py-3 rounded hover:bg-green-700 transition shadow"><i class="fas fa-file-upload mr-1"></i> ì—‘ì…€ ì—…ë¡œë“œ ì‹œì‘</button>
                        <div class="mt-4 text-center"><button onclick="app.downloadTemplate()" class="text-xs text-gray-500 underline hover:text-blue-500">ì—‘ì…€ ì–‘ì‹ ë‹¤ìš´ë¡œë“œ</button></div>
                    </div>
                </div>
            </div>
        </section>

        <!-- í•™ìƒ ìƒì„¸ ì •ë³´ ëª¨ë‹¬ -->
        <div id="student-detail-modal" class="fixed inset-0 z-50 hidden flex items-center justify-center">
            <div class="modal-overlay absolute inset-0" onclick="document.getElementById('student-detail-modal').classList.add('hidden')"></div>
            <div class="bg-white p-8 rounded-lg shadow-2xl z-10 w-full max-w-2xl mx-4 border-t-8 border-blue-500 max-h-[80vh] overflow-y-auto">
                <h3 class="font-bold text-xl mb-4 text-gray-800 border-b pb-2">í•™ìƒ ì‘ì‹œ ìƒì„¸ ì •ë³´</h3>
                <div id="student-detail-content"></div>
                <div class="mt-4 text-center"><button onclick="document.getElementById('student-detail-modal').classList.add('hidden')" class="bg-gray-200 px-4 py-2 rounded font-bold hover:bg-gray-300">ë‹«ê¸°</button></div>
            </div>
        </div>

        <!-- ë¯¸ë¦¬ë³´ê¸° ëª¨ë‹¬ -->
        <div id="preview-modal" class="fixed inset-0 z-50 hidden flex items-center justify-center">
            <div class="modal-overlay absolute inset-0" onclick="document.getElementById('preview-modal').classList.add('hidden')"></div>
            <div class="bg-white p-8 rounded-lg shadow-2xl z-10 w-full max-w-lg mx-4 border-t-8 border-amber-500 max-h-[80vh] overflow-y-auto">
                <div class="flex justify-between items-center mb-4"><span class="bg-stone-100 text-stone-600 text-xs font-bold px-2 py-1 rounded">ë¯¸ë¦¬ë³´ê¸°</span><button onclick="document.getElementById('preview-modal').classList.add('hidden')" class="text-gray-400 hover:text-gray-600"><i class="fas fa-times"></i></button></div>
                <div id="preview-content"></div>
                <div class="mt-6 text-center"><button onclick="document.getElementById('preview-modal').classList.add('hidden')" class="bg-stone-200 px-4 py-2 rounded text-sm font-bold hover:bg-stone-300">ë‹«ê¸°</button></div>
            </div>
        </div>

        <!-- ìˆ˜ì • ëª¨ë‹¬ (ê¸°ì¡´ ì½”ë“œ ìœ ì§€, ìƒëµí•˜ì§€ ì•ŠìŒ) -->
         <div id="edit-modal" class="fixed inset-0 z-50 hidden flex items-center justify-center">
            <div class="modal-overlay absolute inset-0" onclick="app.closeEditModal()"></div>
            <div class="bg-white p-6 rounded-lg shadow-xl z-10 w-full max-w-2xl mx-4 max-h-[90vh] overflow-y-auto">
                <h3 class="font-bold text-xl mb-4 border-b pb-2">ë¬¸ì œ ìˆ˜ì •</h3>
                <input type="hidden" id="edit-q-id">
                <div class="space-y-4">
                    <div><label class="block text-sm font-bold mb-1">ë‹¨ì›</label><select id="edit-q-unit" class="w-full p-2 border rounded"><option value="I. ë¬¸ëª…ì˜ ë°œìƒê³¼ ê³ ëŒ€ ì„¸ê³„ì˜ í˜•ì„±">I. ê³ ëŒ€ ì„¸ê³„</option><option value="II. ì„¸ê³„ ì¢…êµì˜ í™•ì‚°ê³¼ ì§€ì—­ ë¬¸í™”ì˜ í˜•ì„±">II. ì„¸ê³„ ì¢…êµ</option><option value="III. ì§€ì—­ ì„¸ê³„ì˜ êµë¥˜ì™€ ë³€í™”">III. ì§€ì—­ ì„¸ê³„</option><option value="IV. ì œêµ­ì£¼ì˜ ì¹¨ëµê³¼ êµ­ë¯¼ êµ­ê°€ ê±´ì„¤ ìš´ë™">IV. ì œêµ­ì£¼ì˜</option><option value="V. ì„¸ê³„ ëŒ€ì „ê³¼ ì‚¬íšŒ ë³€ë™">V. ì„¸ê³„ ëŒ€ì „</option></select></div>
                    <div><label class="block text-sm font-bold mb-1">ìœ í˜•</label><select id="edit-q-type" class="w-full p-2 border rounded" onchange="app.toggleOptionInput('edit')"><option value="choice">ê°ê´€ì‹</option><option value="word">ë‹¨ë‹µí˜•</option><option value="order">ìˆœì„œ ë§ì¶”ê¸°</option><option value="ox">O/X í€´ì¦ˆ</option></select></div>
                    <div><label class="block text-sm font-bold mb-1">ì´ë¯¸ì§€ ìˆ˜ì •</label><input type="file" id="edit-q-image-input" accept="image/*" class="w-full text-xs p-2 border rounded" onchange="app.handleImageUpload(this, 'edit')"><img id="edit-q-image-preview" class="hidden q-image-thumb mt-2"><input type="hidden" id="edit-q-image-base64"><button onclick="app.removeEditImage()" class="text-red-500 text-xs mt-1 hover:underline">ì´ë¯¸ì§€ ì‚­ì œ</button></div>
                    <div><label class="block text-sm font-bold mb-1">ë¬¸ì œ</label><textarea id="edit-q-text" class="w-full p-2 border rounded h-20"></textarea></div>
                    <div id="option-container-edit"><label class="block text-sm font-bold mb-1">ë³´ê¸° (ì½¤ë§ˆë¡œ êµ¬ë¶„)</label><input type="text" id="edit-q-options" class="w-full p-2 border rounded"></div>
                    <div><label class="block text-sm font-bold mb-1">ì •ë‹µ</label><input type="text" id="edit-q-answer" class="w-full p-2 border rounded"></div>
                    <div><label class="block text-sm font-bold mb-1">í•´ì„¤</label><input type="text" id="edit-q-exp" class="w-full p-2 border rounded"></div>
                    <div class="flex gap-2 pt-2"><button onclick="app.saveEditedQuestion()" class="flex-1 bg-green-600 text-white font-bold py-3 rounded hover:bg-green-700">ì €ì¥</button><button onclick="app.closeEditModal()" class="flex-1 bg-stone-200 text-stone-700 font-bold py-3 rounded hover:bg-stone-300">ì·¨ì†Œ</button></div>
                </div>
            </div>
        </div>

    </main>

    <footer class="bg-stone-100 py-6 mt-8 border-t border-stone-200 text-center">
        <p class="text-stone-400 text-xs font-bold font-mono">Copyright Â© ìš©ì‹ ì¤‘í•™êµ ì—­ì‚¬êµì‚¬ ë°©ì¬ì„. All rights reserved.</p>
    </footer>

    <script>
        const firebaseConfig = { apiKey: "AIzaSyAOlPQ5PFmL0zxmGrGcuEBnqBXisph7kPU", authDomain: "history-quiz-yongsin.firebaseapp.com", projectId: "history-quiz-yongsin", storageBucket: "history-quiz-yongsin.firebasestorage.app", messagingSenderId: "177587430482", appId: "1:177587430482:web:d79cc145c11e335cc3ab8b", measurementId: "G-LHN97D7R2R" };
        let db; try { if (!firebase.apps.length) { firebase.initializeApp(firebaseConfig); } db = firebase.firestore(); } catch(e) { alert("Firebase ì˜¤ë¥˜"); }
        const TEACHER_PW = "19960423";
        const UNIT_LIST = ["I. ë¬¸ëª…ì˜ ë°œìƒê³¼ ê³ ëŒ€ ì„¸ê³„ì˜ í˜•ì„±", "II. ì„¸ê³„ ì¢…êµì˜ í™•ì‚°ê³¼ ì§€ì—­ ë¬¸í™”ì˜ í˜•ì„±", "III. ì§€ì—­ ì„¸ê³„ì˜ êµë¥˜ì™€ ë³€í™”", "IV. ì œêµ­ì£¼ì˜ ì¹¨ëµê³¼ êµ­ë¯¼ êµ­ê°€ ê±´ì„¤ ìš´ë™", "V. ì„¸ê³„ ëŒ€ì „ê³¼ ì‚¬íšŒ ë³€ë™"];

        const app = {
            state: { student:{}, questions:[], allQuestions:[], currentIndex:0, answers:{}, score:0, isTeacherMode:false, timer:null, timeLeft:60, isTimeOut:false, logs:[], questionStats: {} },
            init: function() {
                const btnTeacher = document.getElementById('btn-teacher-mode');
                if(btnTeacher) btnTeacher.onclick = () => this.toggleTeacherMode();
                this.loadQuestionsFromFirebase();
            },
            showLoading: function(show) { document.getElementById('loading-overlay').style.display = show ? 'flex' : 'none'; },
            
            // --- 5ë¶„ ì¬ì‘ì‹œ ë°©ì§€ (ê°•ë ¥) ---
            startQuiz: async function() {
                const cls = document.getElementById('input-class').value;
                const num = document.getElementById('input-number').value;
                const name = document.getElementById('input-name').value.trim();
                if(!cls || !num || !name) { alert("ì •ë³´ë¥¼ ëª¨ë‘ ì…ë ¥í•˜ì„¸ìš”."); return; }
                this.showLoading(true);
                try {
                    const logsRef = db.collection("quiz_results");
                    const snapshot = await logsRef.where("class", "==", cls).where("number", "==", num).where("name", "==", name).orderBy("timestamp", "desc").limit(1).get();
                    if(!snapshot.empty) {
                        const lastTime = snapshot.docs[0].data().timestamp.toDate();
                        const diffMins = (new Date() - lastTime) / (1000 * 60);
                        if (diffMins < 5) {
                            this.showLoading(false);
                            alert(`ì´ë¯¸ ì œì¶œí•˜ì…¨ìŠµë‹ˆë‹¤.\n${Math.ceil(5 - diffMins)}ë¶„ ë’¤ì— ë‹¤ì‹œ ì‹œë„í•˜ì„¸ìš”.`);
                            return;
                        }
                    }
                } catch(e) { console.error("ì¤‘ë³µ ì²´í¬ ì˜¤ë¥˜:", e); }
                this.showLoading(false);
                this.state.student = { class:cls, number:num, name:name };
                if(this.state.allQuestions.length === 0) { alert("ë¬¸ì œê°€ ì—†ìŠµë‹ˆë‹¤. ì„ ìƒë‹˜ê»˜ ë¬¸ì˜í•˜ì„¸ìš”."); return; }

                // --- ë‹¨ì›ë³„ ì¶œì œ ë¡œì§ (ê° ë‹¨ì› 1ê°œì”©) ---
                const selectedQuestions = [];
                const usedIds = new Set();
                const unitGroups = {};
                this.state.allQuestions.forEach(q => { const u = q.unit || "ê¸°íƒ€"; if(!unitGroups[u]) unitGroups[u] = []; unitGroups[u].push(q); });
                
                UNIT_LIST.forEach(u => {
                    if(unitGroups[u] && unitGroups[u].length > 0) {
                        const q = unitGroups[u][Math.floor(Math.random() * unitGroups[u].length)];
                        selectedQuestions.push(q); usedIds.add(q.id);
                    }
                });
                // ë¶€ì¡±ë¶„ ì±„ìš°ê¸°
                if (selectedQuestions.length < 5) {
                    const remaining = this.state.allQuestions.filter(q => !usedIds.has(q.id));
                    const shuffled = remaining.sort(()=>0.5-Math.random());
                    for(let i=0; i<5-selectedQuestions.length; i++) if(shuffled[i]) selectedQuestions.push(shuffled[i]);
                }
                this.state.questions = selectedQuestions.sort(()=>0.5-Math.random());
                this.state.currentIndex = 0; this.state.answers = {}; this.state.score = 0; this.state.timeLeft = 60; this.state.isTimeOut = false; this.state.isQuizActive = true; 
                this.showView('view-quiz'); this.renderQuestion(); this.startTimer();
            },

            // --- ë°ì´í„° ì €ì¥ (ìƒì„¸ ë‹µì•ˆ í¬í•¨) ---
            saveToFirebase: function(detailLogs = []) {
                if(!db) return;
                const data = { 
                    timestamp: firebase.firestore.FieldValue.serverTimestamp(), 
                    timeString: new Date().toLocaleString(), 
                    class: this.state.student.class, 
                    number: this.state.student.number, 
                    name: this.state.student.name, 
                    score: this.state.score, 
                    status: this.state.isTimeOut ? "ì‹œê°„ì´ˆê³¼" : "ì™„ë£Œ", 
                    details: detailLogs // í•™ìƒì´ ì„ íƒí•œ ë‹µ, ì •ì˜¤ë‹µ ì—¬ë¶€ ì €ì¥
                };
                db.collection("quiz_results").add(data);
            },

            // --- êµì‚¬ ëŒ€ì‹œë³´ë“œ ê¸°ëŠ¥ ---
            renderLogs: function() {
                const clsFilter = document.getElementById('filter-class').value;
                const sortType = document.getElementById('sort-logs').value;
                const tbody = document.getElementById('teacher-log-body');
                let filtered = [...this.state.logs];
                
                // ë°˜ í•„í„°
                if (clsFilter !== 'all') filtered = filtered.filter(l => l.class === clsFilter);
                
                // ì •ë ¬ (ë²ˆí˜¸, ì ìˆ˜, ì‹œê°„)
                if (sortType === 'number') filtered.sort((a,b) => parseInt(a.number) - parseInt(b.number));
                else if (sortType === 'score_desc') filtered.sort((a,b) => b.score - a.score);
                else if (sortType === 'score_asc') filtered.sort((a,b) => a.score - b.score);
                
                if (filtered.length === 0) { tbody.innerHTML = '<tr><td colspan="5" class="p-4 text-center">ê¸°ë¡ ì—†ìŒ</td></tr>'; return; }
                
                tbody.innerHTML = filtered.map(d => 
                    `<tr class="border-b hover:bg-stone-50 cursor-pointer" onclick="app.showStudentDetail('${d.docId}')">
                        <td class="p-3 text-center"><input type="checkbox" class="log-checkbox" value="${d.docId}" onclick="event.stopPropagation()"></td>
                        <td class="p-3 text-stone-500 text-xs">${d.timeString}</td>
                        <td class="p-3 font-medium">${d.class}ë°˜ ${d.number}ë²ˆ ${d.name}</td>
                        <td class="p-3 font-bold text-amber-600">${d.score}</td>
                        <td class="p-3 text-xs">${d.status}</td>
                    </tr>`
                ).join('');
            },

            // [ì¶”ê°€] í•™ìƒ ìƒì„¸ ë³´ê¸° íŒì—…
            showStudentDetail: function(docId) {
                const log = this.state.logs.find(l => l.docId === docId);
                if(!log || !log.details) { alert("ìƒì„¸ ë°ì´í„°ê°€ ì—†ìŠµë‹ˆë‹¤."); return; }
                
                let html = `<div class="mb-4 font-bold text-lg">${log.class}ë°˜ ${log.number}ë²ˆ ${log.name} (${log.score}ì )</div>`;
                html += `<div class="space-y-3">`;
                log.details.forEach((d, idx) => {
                    const q = this.state.allQuestions.find(x => x.id === d.id);
                    const qText = q ? q.question : "ì‚­ì œëœ ë¬¸ì œ";
                    const isCorrect = d.correct;
                    html += `
                        <div class="p-3 border rounded ${isCorrect ? 'bg-green-50 border-green-200' : 'bg-red-50 border-red-200'}">
                            <div class="text-sm font-bold mb-1">Q${idx+1}. ${qText}</div>
                            <div class="text-xs">í•™ìƒ ë‹µ: <span class="font-mono font-bold">${d.u}</span> / ì •ë‹µ ì—¬ë¶€: ${isCorrect ? 'O' : 'X'}</div>
                        </div>`;
                });
                html += `</div>`;
                document.getElementById('student-detail-content').innerHTML = html;
                document.getElementById('student-detail-modal').classList.remove('hidden');
            },

            // [ì¶”ê°€] ì„ íƒ ì‚­ì œ ê¸°ëŠ¥
            toggleAllLogs: function(source) { document.querySelectorAll('.log-checkbox').forEach(cb => cb.checked = source.checked); },
            deleteSelectedLogs: function() {
                const checked = Array.from(document.querySelectorAll('.log-checkbox:checked')).map(cb => cb.value);
                if(checked.length === 0) { alert("ì‚­ì œí•  ê¸°ë¡ì„ ì„ íƒí•˜ì„¸ìš”."); return; }
                if(confirm(`${checked.length}ê°œì˜ ê¸°ë¡ì„ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?`)) {
                    this.showLoading(true);
                    const batch = db.batch();
                    checked.forEach(id => batch.delete(db.collection("quiz_results").doc(id)));
                    batch.commit().then(() => {
                        this.showLoading(false);
                        this.loadServerLogs();
                    });
                }
            },
            toggleAllQuestions: function(source) { document.querySelectorAll('.q-checkbox').forEach(cb => cb.checked = source.checked); },
            deleteSelectedQuestions: function() {
                const checked = Array.from(document.querySelectorAll('.q-checkbox:checked')).map(cb => cb.value);
                if(checked.length === 0) { alert("ì‚­ì œí•  ë¬¸ì œë¥¼ ì„ íƒí•˜ì„¸ìš”."); return; }
                if(confirm(`${checked.length}ê°œì˜ ë¬¸ì œë¥¼ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?`)) {
                    this.showLoading(true);
                    const batch = db.batch();
                    checked.forEach(id => batch.delete(db.collection("quiz_questions").doc(id)));
                    batch.commit().then(() => {
                        this.showLoading(false);
                        this.loadQuestionsFromFirebase();
                    });
                }
            },

            // --- ë¬¸ì œ ì€í–‰ í•„í„° ë° ì •ë ¬ ---
            renderBank: function() {
                this.calculateStats();
                let filtered = [...this.state.allQuestions];
                const unitFilter = document.getElementById('bank-filter-unit').value;
                const typeFilter = document.getElementById('bank-filter-type').value;
                if (unitFilter !== 'all') filtered = filtered.filter(q => (q.unit || "").startsWith(unitFilter));
                if (typeFilter !== 'all') filtered = filtered.filter(q => q.type === typeFilter);

                const sortType = document.getElementById('bank-sort').value;
                if (sortType === 'id') filtered.sort((a, b) => a.id - b.id);
                else if (sortType === 'unit') filtered.sort((a, b) => (a.unit || "").localeCompare(b.unit || ""));
                else if (sortType === 'type') filtered.sort((a, b) => a.type.localeCompare(b.type));
                else if (sortType.startsWith('rate')) {
                    filtered.sort((a, b) => {
                        const sA = this.state.questionStats[a.id] || { t:0, c:0 };
                        const sB = this.state.questionStats[b.id] || { t:0, c:0 };
                        const rA = sA.t ? sA.c/sA.t : 0;
                        const rB = sB.t ? sB.c/sB.t : 0;
                        return sortType === 'rate_asc' ? rA - rB : rB - rA;
                    });
                }

                document.getElementById('total-q-count').innerText = `(${filtered.length}ë¬¸í•­)`;
                document.getElementById('bank-body').innerHTML = filtered.map(q => {
                    const stat = this.state.questionStats[q.id] || { t:0, c:0 };
                    const rate = stat.t > 0 ? Math.round((stat.c/stat.t)*100) : 0;
                    return `<tr class="border-b hover:bg-stone-50">
                        <td class="p-3 text-center"><input type="checkbox" class="q-checkbox" value="${q.id}"></td>
                        <td class="p-3 text-xs text-center">${q.id}</td>
                        <td class="p-3"><div class="text-xs text-gray-500">${q.unit || 'ê¸°íƒ€'}</div></td>
                        <td class="p-3 text-center"><span class="bg-stone-100 border px-1 rounded text-xs">${q.type}</span></td>
                        <td class="p-3 text-sm cursor-pointer hover:text-blue-600" onclick="app.editQuestion(${q.id})">${q.question}</td>
                        <td class="p-3 text-center"><button onclick="app.previewQuestion(${q.id})"><i class="fas fa-eye text-gray-400 hover:text-blue-500"></i></button></td>
                        <td class="p-3 text-xs font-bold text-center col-answer">${q.answer}</td>
                        <td class="p-3 text-center w-24"><div class="text-xs font-bold">${rate}%</div><div class="rate-bar-bg"><div class="rate-bar-fill ${rate<40?'bg-red-500':rate<70?'bg-yellow-500':'bg-green-500'}" style="width:${rate}%"></div></div></td>
                    </tr>`;
                }).join('');
            },

            // --- ë‚˜ë¨¸ì§€ í•„ìˆ˜ í•¨ìˆ˜ë“¤ (ë¡œì§ ìœ ì§€) ---
            calculateStats: function() {
                const stats = {};
                this.state.logs.forEach(l => {
                    if(l.details) l.details.forEach(d => {
                        if(!stats[d.id]) stats[d.id] = {t:0, c:0};
                        stats[d.id].t++; if(d.correct) stats[d.id].c++;
                    });
                });
                this.state.questionStats = stats;
            },
            loadQuestionsFromFirebase: function() {
                if(!db) return;
                this.showLoading(true);
                db.collection("quiz_questions").get().then((snap) => {
                    let data = []; snap.forEach(doc => { let d = doc.data(); d.id = parseInt(doc.id); data.push(d); });
                    data.sort((a,b)=>a.id-b.id); this.state.allQuestions = data; this.showLoading(false);
                    if(this.state.isTeacherMode) this.renderBank();
                });
            },
            loadServerLogs: function() {
                if(!db) return;
                db.collection("quiz_results").orderBy("timestamp", "desc").limit(200).get().then(snap => {
                    let logs = []; snap.forEach(doc => { let d = doc.data(); d.docId = doc.id; logs.push(d); });
                    this.state.logs = logs; this.renderLogs();
                });
            },
            
            // UI Helper
            toggleTeacherMode: function() { const pw = prompt("ë¹„ë°€ë²ˆí˜¸:"); if(pw===TEACHER_PW) { this.state.isTeacherMode=true; this.showView('view-teacher'); this.loadServerLogs(); } else if(pw) alert("ì˜¤ë¥˜"); },
            closeTeacherMode: function() { this.state.isTeacherMode=false; this.showView('view-login'); },
            showView: function(id) { document.querySelectorAll('main > section').forEach(el => el.classList.add('hidden')); document.getElementById(id).classList.remove('hidden'); window.scrollTo(0,0); },
            setTeacherTab: function(tab) {
                ['log','bank','add'].forEach(t => document.getElementById('tab-'+t).classList.add('hidden'));
                document.getElementById('tab-'+tab).classList.remove('hidden');
                if(tab==='log') this.loadServerLogs(); else if(tab==='add') this.updateNextQuestionNumber(); else this.renderBank();
            },
            updateNextQuestionNumber: function() {
                const maxId = this.state.allQuestions.reduce((max, item) => Math.max(max, item.id), 0);
                document.getElementById('next-q-id-display').innerText = `í˜„ì¬ ${maxId + 1}ë²ˆ ë¬¸ì œ ìƒì„± ì¤‘`;
            },
            // ... (ê¸°íƒ€ ì—‘ì…€ ì—…ë¡œë“œ, ì´ë¯¸ì§€ ì²˜ë¦¬, ìˆ˜ì •/ë¯¸ë¦¬ë³´ê¸° ë“±ì˜ í•¨ìˆ˜ë“¤ì€ ê¸°ì¡´ê³¼ ë™ì¼í•˜ê²Œ ìœ ì§€) ...
            goToMain: function() { if(this.state.isQuizActive) { if(confirm("í¬ê¸°í•˜ì‹œê² ìŠµë‹ˆê¹Œ? (5ë¶„ ì œí•œ ì ìš©)")) { this.state.isTimeOut=true; this.saveToFirebase(); this.showView('view-login'); clearInterval(this.state.timer); } } else this.showView('view-login'); },
            openImageZoom: function(src) { document.getElementById('image-zoom-content').src = src; document.getElementById('image-zoom-modal').style.display='flex'; },
            closeImageZoom: function() { document.getElementById('image-zoom-modal').style.display='none'; },
            shuffleArray: function(array) { for (let i = array.length - 1; i > 0; i--) { const j = Math.floor(Math.random() * (i + 1)); [array[i], array[j]] = [array[j], array[i]]; } return array; },
            startTimer: function() { if(this.state.timer) clearInterval(this.state.timer); const bar = document.getElementById('timer-bar'), txt = document.getElementById('timer-text'); bar.style.width='100%'; txt.innerText='60ì´ˆ'; this.state.timer = setInterval(() => { this.state.timeLeft--; txt.innerText = this.state.timeLeft + 'ì´ˆ'; bar.style.width = (this.state.timeLeft/60)*100 + '%'; if(this.state.timeLeft<=0) { clearInterval(this.state.timer); this.state.isTimeOut=true; alert("ì¢…ë£Œ"); this.finishQuiz(); } }, 1000); },
            renderQuestion: function() { /* (ê¸°ì¡´ ë Œë”ë§ ì½”ë“œ ìœ ì§€) */ 
                const q = this.state.questions[this.state.currentIndex];
                document.getElementById('quiz-progress-text').innerText = `${this.state.currentIndex+1}/5`;
                document.getElementById('question-badge').innerText = {'choice':'ê°ê´€ì‹','blank':'ë‹¨ë‹µ','word':'ë‹¨ë‹µ','order':'ìˆœì„œ','ox':'O/X'}[q.type];
                document.getElementById('student-question-unit').innerText = q.unit || "ê¸°íƒ€";
                const img = document.getElementById('question-image'); 
                if(q.image) { img.src=q.image; img.parentNode.classList.remove('hidden'); } else img.parentNode.classList.add('hidden');
                document.getElementById('question-text').innerText = q.question;
                const area = document.getElementById('answer-area'); area.innerHTML = ''; this.tempAnswer = this.state.answers[q.id] || null;
                // (ë²„íŠ¼ ìƒì„± ë¡œì§ ìƒëµ - ìœ„ì™€ ë™ì¼)
                if(q.type === 'choice') { q.options.forEach((opt,i) => { const btn = document.createElement('button'); btn.className="w-full text-left p-4 border rounded mb-2 hover:bg-gray-100"; if(this.tempAnswer===opt) btn.classList.add('bg-amber-100','border-amber-500'); btn.innerHTML=`${i+1}. ${opt}`; btn.onclick=()=>{this.tempAnswer=opt; this.renderQuestion();}; area.appendChild(btn); }); }
                else if(q.type === 'ox') { ['O','X'].forEach(opt => { const btn=document.createElement('button'); btn.className="w-1/2 p-4 border rounded mx-1 text-2xl font-bold"; btn.innerText=opt; if(this.tempAnswer===opt) btn.classList.add('bg-blue-100','border-blue-500'); btn.onclick=()=>{this.tempAnswer=opt; this.renderQuestion();}; area.appendChild(btn); }); area.className="flex"; }
                else if(q.type === 'word') { const inp = document.createElement('input'); inp.className="w-full p-3 border rounded text-center"; inp.value=this.tempAnswer||''; inp.oninput=e=>this.tempAnswer=e.target.value; area.appendChild(inp); }
                else if(q.type === 'order') { 
                    this.orderTemp = this.tempAnswer ? this.tempAnswer.split('-') : [];
                    const box = document.createElement('div'); box.className="border p-2 mb-2 min-h-[50px]";
                    this.orderTemp.forEach(t=> { const b=document.createElement('button'); b.innerText=t; b.className="mr-2 p-1 bg-amber-200 rounded"; b.onclick=()=>{this.orderTemp=this.orderTemp.filter(x=>x!==t); this.renderQuestion();}; box.appendChild(b); });
                    const opts = document.createElement('div');
                    q.options.filter(o=>!this.orderTemp.includes(o)).forEach(t=>{ const b=document.createElement('button'); b.innerText=t; b.className="mr-2 p-1 border rounded"; b.onclick=()=>{this.orderTemp.push(t); this.tempAnswer=this.orderTemp.join('-'); this.renderQuestion();}; opts.appendChild(b); });
                    area.append(box, opts);
                }
                const pBtn = document.getElementById('btn-prev'); const nBtn = document.getElementById('btn-next');
                if(this.state.currentIndex===0) pBtn.classList.add('hidden'); else pBtn.classList.remove('hidden');
            },
            prevQuestion: function() { if(this.state.currentIndex>0) { if(this.tempAnswer) this.state.answers[this.state.questions[this.state.currentIndex].id] = this.tempAnswer; this.state.currentIndex--; this.renderQuestion(); } },
            submitAnswer: function() { if(this.tempAnswer) this.state.answers[this.state.questions[this.state.currentIndex].id] = this.tempAnswer; if(this.state.currentIndex<4) { this.state.currentIndex++; this.renderQuestion(); } else this.finishQuiz(); },
            toggleReview: function() { document.getElementById('review-section').classList.toggle('hidden'); },
            
            // ì—‘ì…€ ì—…ë¡œë“œ ë° ê¸°íƒ€ í•¨ìˆ˜ë“¤ì€ ê·¸ëŒ€ë¡œ ìœ ì§€
            uploadExcel: function() { /* ... */ },
            downloadTemplate: function() { /* ... */ },
            addCustomQuestion: function() { /* ... */ }
        };
        window.onload = () => app.init();
    </script>
</body>
</html>
