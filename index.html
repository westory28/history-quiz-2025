<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>2025학년도 2학기 역사과 형성평가 (최종)</title>
    
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- Chart.js -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

    <!-- Google Fonts -->
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+KR:wght@300;400;500;700&family=Noto+Serif+KR:wght@400;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">

    <style>
        body { font-family: 'Noto Sans KR', sans-serif; background-color: #f5f5f4; }
        h1, h2, .serif { font-family: 'Noto Serif KR', serif; }
        .fade-in { animation: fadeIn 0.5s ease-in-out; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
        .chart-container { position: relative; width: 100%; max-width: 400px; margin: 0 auto; height: 300px; }
        
        /* Teacher Dashboard Table Styling */
        .admin-table th { background-color: #e7e5e4; color: #44403c; font-weight: 600; padding: 0.75rem; text-align: left; font-size: 0.875rem; }
        .admin-table td { padding: 0.75rem; border-bottom: 1px solid #e7e5e4; font-size: 0.875rem; vertical-align: top; }
        .admin-table tr:hover { background-color: #fafaf9; }
    </style>

    <!-- Chosen Palette: Warm History Academia -->
    <!-- Application Structure: 
         Updated to support 1-10 classes, Google Sheets integration, and full Question Bank Viewer for teachers.
    -->
</head>
<body class="text-stone-800 min-h-screen flex flex-col">

    <!-- Header -->
    <header class="bg-stone-800 text-stone-100 py-4 shadow-md sticky top-0 z-50">
        <div class="container mx-auto px-4 flex justify-between items-center">
            <div>
                <h1 class="text-xl md:text-2xl font-bold"><i class="fas fa-history mr-2 text-amber-500"></i>역사과 형성평가</h1>
            </div>
            <button onclick="app.toggleTeacherMode()" class="text-stone-400 hover:text-white text-sm transition">
                <i class="fas fa-chalkboard-teacher"></i> 교사용 모드
            </button>
        </div>
    </header>

    <main class="flex-grow container mx-auto px-4 py-8 relative">
        
        <!-- View 1: Student Login -->
        <section id="view-login" class="max-w-md mx-auto bg-white p-8 rounded-lg shadow-lg fade-in mt-10">
            <h2 class="text-2xl font-bold mb-6 text-center text-stone-700 border-b-2 border-amber-500 pb-2 inline-block">학생 정보 입력</h2>
            <div class="space-y-5">
                <div>
                    <label class="block text-sm font-medium text-stone-600 mb-1">학년 / 반</label>
                    <div class="flex gap-2">
                        <div class="w-1/3 p-3 border border-stone-300 rounded bg-stone-100 text-center font-bold text-stone-500">2학년</div>
                        <select id="input-class" class="w-2/3 p-3 border border-stone-300 rounded focus:ring-2 focus:ring-amber-500 outline-none bg-white">
                            <option value="">반 선택</option>
                            <!-- 1 to 10 Classes -->
                            <option value="1">1반</option><option value="2">2반</option><option value="3">3반</option>
                            <option value="4">4반</option><option value="5">5반</option><option value="6">6반</option>
                            <option value="7">7반</option><option value="8">8반</option><option value="9">9반</option>
                            <option value="10">10반</option>
                        </select>
                    </div>
                </div>
                <div>
                    <label class="block text-sm font-medium text-stone-600 mb-1">번호</label>
                    <input type="number" id="input-number" placeholder="번호 (예: 15)" class="w-full p-3 border border-stone-300 rounded focus:ring-2 focus:ring-amber-500 outline-none">
                </div>
                <div>
                    <label class="block text-sm font-medium text-stone-600 mb-1">이름</label>
                    <input type="text" id="input-name" placeholder="본인 이름" class="w-full p-3 border border-stone-300 rounded focus:ring-2 focus:ring-amber-500 outline-none">
                </div>
                
                <button onclick="app.startQuiz()" class="w-full mt-4 bg-stone-800 hover:bg-stone-700 text-white font-bold py-4 rounded transition duration-300 shadow-md flex justify-center items-center">
                    <span>문제 풀기 시작</span> <i class="fas fa-arrow-right ml-2"></i>
                </button>
            </div>
        </section>

        <!-- View 2: Quiz Interface -->
        <section id="view-quiz" class="hidden max-w-2xl mx-auto fade-in">
            <div class="mb-6 flex items-center justify-between bg-white p-4 rounded shadow-sm">
                <span class="text-stone-600 font-bold text-lg" id="quiz-progress-text">문제 1 / 5</span>
                <div class="w-1/2 bg-stone-200 rounded-full h-3">
                    <div id="quiz-progress-bar" class="bg-amber-600 h-3 rounded-full transition-all duration-500" style="width: 0%"></div>
                </div>
            </div>

            <div class="bg-white p-6 md:p-10 rounded-lg shadow-xl min-h-[450px] flex flex-col relative border-t-4 border-amber-500">
                <span id="question-badge" class="absolute top-4 right-4 bg-stone-100 text-stone-600 text-xs font-bold px-3 py-1 rounded border border-stone-200 uppercase tracking-wide">
                    유형
                </span>
                
                <h3 id="question-text" class="text-xl md:text-2xl font-bold mt-4 mb-8 text-stone-800 leading-loose serif">
                    <!-- Question Text -->
                </h3>

                <div id="answer-area" class="flex-grow mb-6">
                    <!-- Dynamic Answer Inputs -->
                </div>

                <div class="flex justify-end pt-6 border-t border-stone-100">
                    <button onclick="app.submitAnswer()" class="bg-amber-600 hover:bg-amber-700 text-white font-bold py-3 px-8 rounded shadow transition transform active:scale-95">
                        다음 문제 <i class="fas fa-chevron-right ml-1"></i>
                    </button>
                </div>
            </div>
        </section>

        <!-- View 3: Results -->
        <section id="view-results" class="hidden max-w-4xl mx-auto fade-in">
            <div class="grid grid-cols-1 md:grid-cols-2 gap-8">
                <div class="bg-white p-8 rounded-lg shadow-lg flex flex-col items-center justify-center text-center relative overflow-hidden">
                    <div class="absolute top-0 left-0 w-full h-2 bg-gradient-to-r from-amber-400 to-stone-600"></div>
                    <h2 class="text-3xl font-bold text-stone-800 mb-2 serif">평가 완료</h2>
                    <p class="text-stone-500 mb-6"><span id="result-name" class="font-bold text-stone-800"></span> 학생의 결과입니다.</p>
                    
                    <div class="chart-container mb-4">
                        <canvas id="scoreChart"></canvas>
                    </div>
                    
                    <div class="text-4xl font-bold text-amber-600 mb-2" id="score-text">0점</div>
                    
                    <div id="submission-status" class="mt-4 text-sm p-3 bg-stone-50 rounded w-full border border-stone-200">
                        <p class="text-stone-400"><i class="fas fa-circle-notch fa-spin mr-1"></i> 결과 전송 중...</p>
                    </div>
                </div>

                <div class="flex flex-col gap-4">
                    <div class="bg-white p-6 rounded-lg shadow-lg flex-grow flex flex-col justify-center items-center text-center">
                        <i class="fas fa-book-reader text-5xl text-stone-300 mb-4"></i>
                        <h3 class="text-xl font-bold mb-2">오답 노트 확인</h3>
                        <p class="text-stone-500 text-sm mb-6">틀린 문제를 다시 확인하고<br>완벽하게 내 것으로 만드세요.</p>
                        <button onclick="app.toggleReview()" class="w-full bg-white border-2 border-stone-800 text-stone-800 hover:bg-stone-50 font-bold py-3 rounded transition">
                            오답 노트 보기
                        </button>
                    </div>
                    <button onclick="location.reload()" class="w-full bg-stone-800 text-white hover:bg-stone-700 font-bold py-4 rounded-lg shadow transition">
                        <i class="fas fa-redo mr-2"></i> 처음으로 돌아가기
                    </button>
                </div>
            </div>

            <div id="review-section" class="hidden mt-8 bg-white p-8 rounded-lg shadow-lg border-l-4 border-red-400 fade-in">
                <h3 class="text-2xl font-bold mb-6 serif text-stone-800 border-b pb-2"><i class="fas fa-check-double text-red-400 mr-2"></i>오답 노트 & 해설</h3>
                <div id="review-list" class="space-y-8"></div>
            </div>
        </section>

        <!-- View 4: Teacher Dashboard (Updated) -->
        <section id="view-teacher" class="hidden max-w-6xl mx-auto bg-white p-6 rounded-lg shadow-xl fade-in mt-4 border border-stone-200">
            <div class="flex justify-between items-center mb-6 pb-4 border-b">
                <h2 class="text-2xl font-bold text-stone-800"><i class="fas fa-user-graduate mr-2 text-amber-600"></i>교사 대시보드</h2>
                <div class="flex gap-2">
                    <button onclick="app.showTeacherTab('log')" id="btn-tab-log" class="px-4 py-2 rounded bg-stone-800 text-white text-sm">제출 로그</button>
                    <button onclick="app.showTeacherTab('bank')" id="btn-tab-bank" class="px-4 py-2 rounded bg-stone-100 text-stone-600 hover:bg-stone-200 text-sm">문제 은행 확인(200제)</button>
                    <button onclick="app.closeTeacherMode()" class="px-4 py-2 rounded text-red-500 hover:bg-red-50 text-sm ml-4"><i class="fas fa-times"></i> 나가기</button>
                </div>
            </div>

            <!-- Tab: Logs -->
            <div id="teacher-tab-log">
                <div class="grid grid-cols-1 md:grid-cols-3 gap-4 mb-6">
                    <div class="bg-blue-50 p-4 rounded border border-blue-100">
                        <h4 class="text-blue-800 text-xs font-bold uppercase">총 응시 건수</h4>
                        <p id="teacher-total-students" class="text-3xl font-bold text-blue-900 mt-1">0</p>
                    </div>
                    <div class="bg-green-50 p-4 rounded border border-green-100">
                        <h4 class="text-green-800 text-xs font-bold uppercase">평균 점수</h4>
                        <p id="teacher-avg-score" class="text-3xl font-bold text-green-900 mt-1">0</p>
                    </div>
                    <div class="bg-amber-50 p-4 rounded border border-amber-100 text-xs text-amber-900">
                        <strong><i class="fas fa-link"></i> 구글 시트 연동 상태:</strong><br>
                        <span id="sheet-status" class="block mt-1">확인 중...</span>
                    </div>
                </div>

                <div class="overflow-x-auto bg-white border rounded">
                    <table class="w-full text-left admin-table">
                        <thead>
                            <tr>
                                <th>시간</th> <th>학생 정보</th> <th>점수</th> <th>오답 상세</th>
                            </tr>
                        </thead>
                        <tbody id="teacher-log-body"></tbody>
                    </table>
                </div>
            </div>

            <!-- Tab: Question Bank -->
            <div id="teacher-tab-bank" class="hidden">
                <div class="flex justify-between items-center mb-4">
                    <h3 class="font-bold text-lg">전체 문제 리스트 (<span id="total-q-count">0</span>문항)</h3>
                    <p class="text-xs text-stone-500">* HTML 파일 코드를 수정하여 문제를 추가하세요.</p>
                </div>
                <div class="overflow-y-auto max-h-[500px] border rounded bg-stone-50">
                    <table class="w-full text-left admin-table bg-white">
                        <thead>
                            <tr>
                                <th class="w-16">ID</th>
                                <th class="w-20">단원</th>
                                <th class="w-20">유형</th>
                                <th>문제 내용</th>
                                <th>정답</th>
                            </tr>
                        </thead>
                        <tbody id="question-bank-body">
                            <!-- JS Injected -->
                        </tbody>
                    </table>
                </div>
            </div>
        </section>

    </main>

    <script>
        // ==========================================
        // [선생님 설정 구역]
        // 1. 배포한 구글 앱스 스크립트 URL을 따옴표 안에 넣으세요.
        const GOOGLE_SCRIPT_URL = "https://script.google.com/macros/s/AKfycby9MZkDDhyerj2jHKC7PPD8arMR86u9aiBhCKCn5_yabZL9WJv5zygH1Lb15cg70EJFQg/exec"; 
        // ==========================================

        /* 문제 은행 데이터 (Question Bank)
           - 선생님, 여기에 200문제를 이 형식으로 계속 추가하시면 됩니다.
           - type: 'blank'(빈칸), 'choice'(객관식), 'word'(단답형), 'order'(순서)
           - options: 객관식 보기 배열 혹은 순서맞추기 항목 배열
        */
        const questionBank = [
            // [예시] 고대
            { id: 1, unit: "고대", type: "blank", question: "아테네 민주 정치는 [ _____ ] 시대에 꽃피웠다.", answer: "페리클레스", explanation: "페리클레스 시대에 직접 민주주의가 완성되었습니다." },
            { id: 2, unit: "고대", type: "choice", question: "그리스-페르시아 전쟁 승리 후 아테네 중심의 동맹은?", answer: "델로스 동맹", options: ["펠로폰네소스 동맹", "델로스 동맹", "신성 동맹", "삼국 동맹"], explanation: "아테네를 맹주로 델로스 동맹이 결성되었습니다." },
            { id: 3, unit: "고대", type: "word", question: "로마 공화정 초기 평민의 권익을 보호하기 위한 대표 직책은?", answer: "호민관", explanation: "평민회에서 선출된 호민관은 거부권을 가졌습니다." },
            
            // [예시] 중세
            { id: 4, unit: "중세", type: "choice", question: "십자군 전쟁의 결과로 옳은 것은?", answer: "교황권 쇠퇴", options: ["장원제 강화", "교황권 쇠퇴", "기사 계급 성장", "동방 무역 쇠퇴"], explanation: "전쟁 실패로 교황권은 쇠퇴하고 왕권이 강화되었습니다." },
            { id: 5, unit: "중세", type: "blank", question: "스콜라 철학은 신앙과 [ _____ ]의 조화를 추구했다.", answer: "이성", explanation: "토마스 아퀴나스가 대표적입니다." },
            
            // [예시] 근대 (산업혁명, 프랑스혁명)
            { id: 6, unit: "근대", type: "order", question: "프랑스 혁명 순서를 올바르게 나열하시오.", answer: "삼부회 소집-바스티유 습격-인권선언-공포정치", options: ["바스티유 습격", "공포정치", "삼부회 소집", "인권선언"], explanation: "삼부회 소집 -> 바스티유 -> 인권선언 -> 공포정치 순서입니다." },
            { id: 7, unit: "근대", type: "word", question: "산업혁명이 가장 먼저 시작된 나라는?", answer: "영국", explanation: "영국은 자본, 자원, 시장 등 조건이 갖춰져 있었습니다." },
            { id: 8, unit: "근대", type: "blank", question: "제국주의는 독점 자본주의, 인종주의, 그리고 [ _____ ]을 배경으로 한다.", answer: "사회진화론", explanation: "강자가 약자를 지배하는 것을 정당화했습니다." },
            
            // [예시] 현대 (1차대전)
            { id: 9, unit: "현대", type: "choice", question: "1차 대전 삼국 협상 국가가 아닌 곳은?", answer: "독일", options: ["영국", "프랑스", "러시아", "독일"], explanation: "독일은 삼국 동맹측입니다." },
            { id: 10, unit: "현대", type: "blank", question: "1차 대전의 도화선이 된 사건은 [ _____ ] 사건이다.", answer: "사라예보", explanation: "오스트리아 황태자 부부가 암살된 사건입니다." },

            // 여기에 계속 문제를 복사해서 추가하세요... (id는 겹치지 않게 숫자만 늘려주세요)
        ];

        const app = {
            state: {
                student: {},
                questions: [],
                currentIndex: 0,
                answers: {},
                score: 0,
                isTeacherMode: false
            },

            init: function() {
                // 초기 상태 점검
                const status = GOOGLE_SCRIPT_URL ? "연동됨 (URL 설정완료)" : "연동 안됨 (URL 비어있음)";
                document.getElementById('sheet-status').innerText = status;
                document.getElementById('sheet-status').className = GOOGLE_SCRIPT_URL ? "block mt-1 text-green-600 font-bold" : "block mt-1 text-red-500 font-bold";
            },

            toggleTeacherMode: function() {
                if (this.state.isTeacherMode) { this.closeTeacherMode(); return; }
                const pw = prompt("선생님 비밀번호를 입력하세요 (기본: 1234)");
                if (pw === '1234') {
                    this.state.isTeacherMode = true;
                    this.renderTeacherDashboard();
                    this.showView('view-teacher');
                } else if (pw !== null) alert("비밀번호 오류");
            },

            closeTeacherMode: function() {
                this.state.isTeacherMode = false;
                this.showView('view-login');
            },

            showView: function(viewId) {
                document.querySelectorAll('main > section').forEach(el => el.classList.add('hidden'));
                document.getElementById(viewId).classList.remove('hidden');
                window.scrollTo(0, 0);
            },

            startQuiz: function() {
                const cls = document.getElementById('input-class').value;
                const num = document.getElementById('input-number').value;
                const name = document.getElementById('input-name').value.trim();

                if (!cls || !num || !name) { alert("반, 번호, 이름을 모두 입력해주세요."); return; }

                this.state.student = { class: cls, number: num, name: name };
                
                // 200문제 중 랜덤 5개 추출 로직
                const shuffled = [...questionBank].sort(() => 0.5 - Math.random());
                this.state.questions = shuffled.slice(0, 5);
                this.state.currentIndex = 0;
                this.state.answers = {};
                this.state.score = 0;

                this.showView('view-quiz');
                this.renderQuestion();
            },

            renderQuestion: function() {
                const q = this.state.questions[this.state.currentIndex];
                const total = 5;
                const progressPct = ((this.state.currentIndex) / total) * 100;
                
                document.getElementById('quiz-progress-text').innerText = `문제 ${this.state.currentIndex + 1} / ${total}`;
                document.getElementById('quiz-progress-bar').style.width = `${progressPct + 20}%`; // 미리 조금 채워줌

                const typeMap = { 'blank': '빈칸 채우기', 'choice': '객관식', 'word': '단답형', 'order': '순서 맞추기' };
                document.getElementById('question-badge').innerText = typeMap[q.type];
                document.getElementById('question-text').innerText = q.question;

                const area = document.getElementById('answer-area');
                area.innerHTML = '';

                if (q.type === 'choice') {
                    const ul = document.createElement('div');
                    ul.className = "grid grid-cols-1 gap-3";
                    q.options.forEach((opt, idx) => {
                        const btn = document.createElement('button');
                        btn.className = "text-left p-4 rounded border border-stone-200 hover:bg-amber-50 hover:border-amber-400 transition w-full flex items-center group";
                        btn.innerHTML = `<span class="w-8 h-8 rounded-full bg-stone-100 text-stone-500 flex items-center justify-center font-bold mr-3 group-hover:bg-amber-200 group-hover:text-amber-800 transition">${idx+1}</span> ${opt}`;
                        btn.onclick = () => {
                            Array.from(ul.children).forEach(c => c.className = "text-left p-4 rounded border border-stone-200 hover:bg-amber-50 hover:border-amber-400 transition w-full flex items-center group");
                            btn.className = "text-left p-4 rounded border-2 border-amber-500 bg-amber-50 w-full flex items-center shadow-sm";
                            app.currentTempAnswer = opt;
                        };
                        ul.appendChild(btn);
                    });
                    area.appendChild(ul);
                    app.currentTempAnswer = null;
                } else if (q.type === 'blank' || q.type === 'word') {
                    const input = document.createElement('input');
                    input.type = "text";
                    input.placeholder = "정답을 입력하세요";
                    input.className = "w-full p-4 text-lg border-b-2 border-stone-300 focus:border-amber-500 outline-none bg-stone-50 transition";
                    input.oninput = (e) => app.currentTempAnswer = e.target.value.trim();
                    input.onkeydown = (e) => { if(e.key === 'Enter') app.submitAnswer(); };
                    area.appendChild(input);
                    app.currentTempAnswer = null;
                } else if (q.type === 'order') {
                    app.sequenceTemp = [];
                    const container = document.createElement('div');
                    
                    const answerBox = document.createElement('div');
                    answerBox.className = "min-h-[70px] p-4 bg-amber-50 border-2 border-dashed border-amber-300 rounded-lg mb-4 flex flex-wrap gap-2 items-center justify-center";
                    answerBox.innerHTML = '<span class="text-stone-400 text-sm">보기를 순서대로 클릭하세요</span>';
                    
                    const sourceBox = document.createElement('div');
                    sourceBox.className = "grid grid-cols-1 gap-2";
                    const shuffledOpts = [...q.options].sort(() => 0.5 - Math.random());
                    
                    shuffledOpts.forEach(opt => {
                        const btn = document.createElement('button');
                        btn.className = "p-3 bg-white border border-stone-200 rounded shadow-sm hover:bg-stone-50 text-left transition active:scale-95";
                        btn.innerText = opt;
                        btn.onclick = function() {
                            if (this.parentNode === sourceBox) {
                                if(answerBox.innerHTML.includes('보기를')) answerBox.innerHTML = '';
                                answerBox.appendChild(this);
                                this.className = "p-2 bg-amber-600 text-white rounded text-sm shadow-md";
                                app.sequenceTemp.push(opt);
                            } else {
                                sourceBox.appendChild(this);
                                this.className = "p-3 bg-white border border-stone-200 rounded shadow-sm hover:bg-stone-50 text-left transition";
                                app.sequenceTemp = app.sequenceTemp.filter(i => i !== opt);
                                if(answerBox.children.length === 0) answerBox.innerHTML = '<span class="text-stone-400 text-sm">보기를 순서대로 클릭하세요</span>';
                            }
                        };
                        sourceBox.appendChild(btn);
                    });
                    container.append(answerBox, sourceBox);
                    area.appendChild(container);
                }
            },

            submitAnswer: function() {
                const q = this.state.questions[this.state.currentIndex];
                let ans = this.currentTempAnswer;

                if (q.type === 'order') {
                    if (!this.sequenceTemp || this.sequenceTemp.length !== q.options.length) {
                        alert("모든 순서를 채워주세요."); return;
                    }
                    ans = this.sequenceTemp.join('-');
                } else {
                    if (!ans) { alert("정답을 입력하거나 선택해주세요."); return; }
                }

                this.state.answers[q.id] = ans;

                if (this.state.currentIndex < 4) {
                    this.state.currentIndex++;
                    this.renderQuestion();
                } else {
                    this.finishQuiz();
                }
            },

            finishQuiz: function() {
                let correct = 0;
                let details = [];

                this.state.questions.forEach(q => {
                    const u = this.state.answers[q.id].replace(/\s+/g, '');
                    const a = q.answer.replace(/\s+/g, '');
                    if (u === a) correct++;
                    else details.push({ q: q.question, u: this.state.answers[q.id], a: q.answer, exp: q.explanation });
                });

                this.state.score = correct * 20;
                this.state.incorrectDetails = details;
                
                this.showView('view-results');
                this.renderResults();
                this.submitData();
                this.saveLocalLog();
            },

            renderResults: function() {
                document.getElementById('result-name').innerText = this.state.student.name;
                document.getElementById('score-text').innerText = this.state.score + "점";
                
                const ctx = document.getElementById('scoreChart').getContext('2d');
                if (window.myPieChart) window.myPieChart.destroy();
                window.myPieChart = new Chart(ctx, {
                    type: 'doughnut',
                    data: {
                        labels: ['정답', '오답'],
                        datasets: [{ data: [this.state.score, 100 - this.state.score], backgroundColor: ['#d97706', '#e7e5e4'], borderWidth: 0 }]
                    },
                    options: { maintainAspectRatio: false, cutout: '75%', plugins: { legend: {display:false}, tooltip: {enabled:false} } }
                });

                const list = document.getElementById('review-list');
                list.innerHTML = '';
                if (this.state.incorrectDetails.length === 0) {
                    list.innerHTML = '<div class="text-center py-10"><i class="fas fa-trophy text-amber-500 text-5xl mb-4"></i><p class="text-lg font-bold">축하합니다! 만점입니다.</p></div>';
                } else {
                    this.state.incorrectDetails.forEach(d => {
                        list.innerHTML += `
                            <div class="border-b border-stone-200 pb-4 last:border-0">
                                <p class="font-bold text-lg mb-3">Q. ${d.q}</p>
                                <div class="flex flex-col sm:flex-row gap-2 text-sm mb-3">
                                    <div class="flex-1 bg-red-50 p-3 rounded text-red-800 border border-red-100"><span class="font-bold mr-2">학생 답:</span> ${d.u}</div>
                                    <div class="flex-1 bg-green-50 p-3 rounded text-green-800 border border-green-100"><span class="font-bold mr-2">정답:</span> ${d.a}</div>
                                </div>
                                <p class="text-stone-600 bg-stone-100 p-3 rounded text-sm"><i class="fas fa-comment-dots text-stone-400 mr-1"></i> ${d.exp}</p>
                            </div>
                        `;
                    });
                }
            },

            toggleReview: function() {
                const el = document.getElementById('review-section');
                el.classList.toggle('hidden');
                if(!el.classList.contains('hidden')) el.scrollIntoView({behavior:'smooth'});
            },

            submitData: function() {
                const status = document.getElementById('submission-status');
                if (!GOOGLE_SCRIPT_URL) {
                    status.innerHTML = '<span class="text-red-500 font-bold">※ 테스트 모드 (전송 안 됨)</span><br>HTML 파일을 열어 GOOGLE_SCRIPT_URL을 설정해주세요.';
                    return;
                }

                const fd = new FormData();
                fd.append('class', this.state.student.class);
                fd.append('number', this.state.student.number);
                fd.append('name', this.state.student.name);
                fd.append('score', this.state.score);
                fd.append('wrong_count', this.state.incorrectDetails.length);

                fetch(GOOGLE_SCRIPT_URL, { method: 'POST', body: fd })
                    .then(r => r.json())
                    .then(d => {
                        if(d.result === 'success') status.innerHTML = '<span class="text-green-600 font-bold"><i class="fas fa-check-circle"></i> 선생님께 제출 완료!</span>';
                        else throw new Error(d.error);
                    })
                    .catch(e => {
                        console.error(e);
                        status.innerHTML = '<span class="text-red-500">전송 실패 (인터넷 확인 요망)</span>';
                    });
            },

            saveLocalLog: function() {
                const log = {
                    time: new Date().toLocaleTimeString(),
                    info: `${this.state.student.class}반 ${this.state.student.number}번 ${this.state.student.name}`,
                    score: this.state.score,
                    detail: this.state.incorrectDetails.map(x => x.q.substring(0,8)+'...').join(', ') || '오답 없음'
                };
                let logs = JSON.parse(localStorage.getItem('hq_logs') || '[]');
                logs.push(log);
                localStorage.setItem('hq_logs', JSON.stringify(logs));
            },

            showTeacherTab: function(tabName) {
                document.getElementById('teacher-tab-log').classList.add('hidden');
                document.getElementById('teacher-tab-bank').classList.add('hidden');
                document.getElementById('btn-tab-log').className = "px-4 py-2 rounded bg-stone-100 text-stone-600 hover:bg-stone-200 text-sm";
                document.getElementById('btn-tab-bank').className = "px-4 py-2 rounded bg-stone-100 text-stone-600 hover:bg-stone-200 text-sm";

                document.getElementById('teacher-tab-' + tabName).classList.remove('hidden');
                document.getElementById('btn-tab-' + tabName).className = "px-4 py-2 rounded bg-stone-800 text-white text-sm";
            },

            renderTeacherDashboard: function() {
                // Tab 1: Logs
                const logs = JSON.parse(localStorage.getItem('hq_logs') || '[]').reverse();
                const tbody = document.getElementById('teacher-log-body');
                tbody.innerHTML = '';
                let total = 0;
                logs.forEach(l => {
                    total += l.score;
                    tbody.innerHTML += `<tr><td>${l.time}</td><td>${l.info}</td><td class="font-bold">${l.score}</td><td>${l.detail}</td></tr>`;
                });
                document.getElementById('teacher-total-students').innerText = logs.length;
                document.getElementById('teacher-avg-score').innerText = logs.length ? Math.round(total/logs.length) : 0;

                // Tab 2: Question Bank Viewer
                document.getElementById('total-q-count').innerText = questionBank.length;
                const bankBody = document.getElementById('question-bank-body');
                bankBody.innerHTML = '';
                questionBank.forEach(q => {
                    const typeBadge = `<span class="px-2 py-1 rounded bg-stone-100 text-xs border border-stone-300">${q.type}</span>`;
                    bankBody.innerHTML += `<tr>
                        <td class="font-mono text-xs text-stone-400">#${q.id}</td>
                        <td>${q.unit}</td>
                        <td>${typeBadge}</td>
                        <td class="text-stone-800 font-medium">${q.question}</td>
                        <td class="text-amber-700 font-bold">${q.answer}</td>
                    </tr>`;
                });
            }
        };

        window.onload = () => app.init();
    </script>
</body>
</html>
