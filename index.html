<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>2025학년도 2학기 역사과 형성평가 (최종_완성)</title>
    
    <!-- 필수 라이브러리 -->
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+KR:wght@400;500;700&family=Noto+Serif+KR:wght@700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">

    <style>
        body { font-family: 'Noto Sans KR', sans-serif; background-color: #f5f5f4; }
        .serif { font-family: 'Noto Serif KR', serif; }
        .fade-in { animation: fadeIn 0.3s ease-in-out; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(5px); } to { opacity: 1; transform: translateY(0); } }
        
        /* 타임어택 바 */
        .timer-bar { transition: width 1s linear; }
        .timer-urgent { background-color: #ef4444 !important; animation: pulse 1s infinite; }
        @keyframes pulse { 0%, 100% { opacity: 1; } 50% { opacity: 0.5; } }

        /* 교사용 버튼 */
        .teacher-btn {
            background-color: #44403c;
            color: white;
            padding: 8px 12px;
            border-radius: 8px;
            font-size: 0.85rem;
            font-weight: bold;
            display: flex;
            align-items: center;
            gap: 6px;
            cursor: pointer;
            border: 1px solid #57534e;
        }
        .teacher-btn:hover { background-color: #292524; }
    </style>
</head>
<body class="text-stone-800 min-h-screen flex flex-col">

    <!-- 상단 헤더 -->
    <header class="bg-stone-900 text-white py-4 shadow-lg sticky top-0 z-50">
        <div class="container mx-auto px-4 flex justify-between items-center">
            <h1 class="text-lg md:text-xl font-bold tracking-tight">
                <i class="fas fa-history text-amber-500 mr-2"></i>용신중학교 2학년 역사과
            </h1>
            <!-- 교사용 버튼 -->
            <button onclick="openTeacherMode()" class="teacher-btn">
                <i class="fas fa-lock"></i> 교사용
            </button>
        </div>
    </header>

    <main class="flex-grow container mx-auto px-4 py-6">
        
        <!-- 1. 로그인 화면 -->
        <section id="view-login" class="max-w-md mx-auto bg-white p-8 rounded-xl shadow-lg fade-in mt-8 border-t-4 border-amber-500">
            <div class="text-center mb-8">
                <span class="bg-amber-100 text-amber-800 text-xs font-bold px-2 py-1 rounded-full">용신중학교 2학기 역사1 형성평가</span>
                <h2 class="text-2xl font-bold serif text-stone-900 mt-2">당신의 역사 수준은?</h2>
                <p class="text-red-500 font-bold text-sm mt-2"><i class="fas fa-stopwatch mr-1"></i> 제한시간 60초 (5문제)</p>
            </div>
            
            <div class="space-y-4">
                <div>
                    <label class="text-xs font-bold text-stone-500 block mb-1">학번 정보</label>
                    <div class="flex gap-2">
                        <div class="w-1/4 bg-stone-100 border border-stone-300 rounded flex items-center justify-center font-bold text-stone-600">2학년</div>
                        <select id="input-class" class="w-2/4 p-3 border border-stone-300 rounded focus:border-amber-500 outline-none">
                            <option value="">반 선택</option>
                            <option value="1">1반</option><option value="2">2반</option><option value="3">3반</option>
                            <option value="4">4반</option><option value="5">5반</option><option value="6">6반</option>
                            <option value="7">7반</option><option value="8">8반</option><option value="9">9반</option>
                            <option value="10">10반</option>
                        </select>
                        <input type="number" id="input-number" placeholder="번호" class="w-1/4 p-3 border border-stone-300 rounded focus:border-amber-500 outline-none text-center">
                    </div>
                </div>
                <div>
                    <label class="text-xs font-bold text-stone-500 block mb-1">이름</label>
                    <input type="text" id="input-name" placeholder="이름 입력" class="w-full p-3 border border-stone-300 rounded focus:border-amber-500 outline-none">
                </div>
                
                <button onclick="app.startQuiz()" class="w-full bg-stone-900 text-white font-bold py-4 rounded-lg hover:bg-stone-700 transition shadow-lg mt-4 transform active:scale-95">
                    도전 시작 <i class="fas fa-play ml-2"></i>
                </button>
            </div>
        </section>

        <!-- 2. 퀴즈 화면 -->
        <section id="view-quiz" class="hidden max-w-2xl mx-auto fade-in">
            <div class="bg-white rounded-lg shadow-sm mb-6 sticky top-20 z-40 overflow-hidden border border-stone-200">
                <div class="flex justify-between items-center px-4 py-2 bg-stone-50 border-b border-stone-100">
                    <span class="text-sm font-bold text-stone-600" id="quiz-progress-text">1 / 5</span>
                    <span class="text-lg font-bold text-red-600 font-mono" id="timer-text">60초</span>
                </div>
                <div class="w-full bg-stone-200 h-2">
                    <div id="timer-bar" class="bg-amber-500 h-full timer-bar" style="width: 100%"></div>
                </div>
            </div>

            <div class="bg-white p-6 md:p-10 rounded-lg min-h-[400px] flex flex-col relative shadow-md">
                <span id="question-badge" class="absolute top-0 right-0 bg-stone-100 text-stone-600 text-xs font-bold px-3 py-1 rounded-bl-lg border-l border-b border-stone-200">
                    유형
                </span>
                
                <h3 id="question-text" class="text-xl md:text-2xl font-bold mt-4 mb-8 text-stone-900 leading-relaxed serif break-keep">
                    <!-- 문제 내용 -->
                </h3>

                <div id="answer-area" class="flex-grow mb-6">
                    <!-- 정답 입력란 -->
                </div>

                <button onclick="app.submitAnswer()" class="w-full bg-amber-600 text-white font-bold py-4 rounded-lg hover:bg-amber-700 transition shadow-md">
                    다음 문제 <i class="fas fa-chevron-right ml-1"></i>
                </button>
            </div>
        </section>

        <!-- 3. 결과 화면 -->
        <section id="view-results" class="hidden max-w-lg mx-auto fade-in mt-6">
            <div class="bg-white p-8 rounded-xl shadow-xl text-center border-t-8 border-amber-500">
                <h2 class="text-3xl font-bold serif mb-2 text-stone-800">평가 종료</h2>
                <p class="text-stone-500 mb-6"><span id="result-name" class="font-bold text-stone-900"></span> 학생의 최종 기록</p>
                
                <div class="relative w-48 h-48 mx-auto mb-4">
                    <canvas id="scoreChart"></canvas>
                    <div class="absolute inset-0 flex items-center justify-center flex-col">
                        <span class="text-5xl font-bold text-amber-600 font-mono" id="score-text">0</span>
                        <span class="text-xs text-stone-400">점</span>
                    </div>
                </div>

                <div id="submission-status" class="bg-stone-50 p-3 rounded text-sm mb-6 border border-stone-200 text-stone-500">
                    <i class="fas fa-circle-notch fa-spin"></i> 데이터 전송 대기중...
                </div>

                <div class="grid grid-cols-2 gap-3">
                    <button onclick="app.toggleReview()" class="bg-white border-2 border-stone-200 text-stone-700 font-bold py-3 rounded hover:bg-stone-50 hover:border-stone-400 transition">
                        <i class="fas fa-book-open mr-1"></i> 오답노트
                    </button>
                    <button onclick="location.reload()" class="bg-stone-900 text-white font-bold py-3 rounded hover:bg-stone-700 transition shadow-lg">
                        <i class="fas fa-redo mr-1"></i> 다시 도전
                    </button>
                </div>
            </div>

            <!-- 오답노트 (숨김) -->
            <div id="review-section" class="hidden mt-6 bg-white p-6 rounded-xl shadow-lg border border-red-200">
                <h3 class="font-bold text-lg mb-4 text-red-600 border-b pb-2"><i class="fas fa-check-circle"></i> 오답 확인</h3>
                <div id="review-list" class="space-y-4 text-left"></div>
            </div>
        </section>

        <!-- 4. 교사용 대시보드 -->
        <section id="view-teacher" class="hidden max-w-6xl mx-auto bg-white p-6 rounded shadow-xl mt-4 border border-stone-300">
            <div class="flex justify-between items-center mb-6 border-b pb-4">
                <div>
                    <h2 class="font-bold text-2xl text-stone-800"><i class="fas fa-chalkboard-teacher text-amber-600 mr-2"></i>교사 대시보드</h2>
                    <p class="text-xs text-stone-500 mt-1">비밀번호: 0423</p>
                </div>
                <button onclick="app.closeTeacherMode()" class="bg-stone-200 hover:bg-stone-300 text-stone-700 px-4 py-2 rounded text-sm font-bold">나가기</button>
            </div>
            
            <div class="flex gap-2 mb-4">
                <button onclick="app.setTeacherTab('log')" id="btn-tab-log" class="px-5 py-2 rounded-full bg-stone-800 text-white text-sm font-bold">학생 기록</button>
                <button onclick="app.setTeacherTab('bank')" id="btn-tab-bank" class="px-5 py-2 rounded-full bg-stone-100 text-stone-600 text-sm font-bold hover:bg-stone-200">문제 은행</button>
            </div>

            <div id="tab-log">
                <div class="overflow-auto max-h-[600px] border rounded bg-stone-50">
                    <table class="w-full text-sm text-left">
                        <thead class="bg-stone-200 text-stone-700 sticky top-0 font-bold">
                            <tr><th class="p-3">시간</th><th class="p-3">학생</th><th class="p-3">점수</th><th class="p-3">상태</th></tr>
                        </thead>
                        <tbody id="teacher-log-body" class="bg-white"></tbody>
                    </table>
                </div>
            </div>

            <div id="tab-bank" class="hidden">
                <p class="text-sm font-bold text-stone-600 mb-2">총 문항 수: <span id="total-q" class="text-amber-600">0</span>개</p>
                <div class="overflow-auto max-h-[600px] border rounded bg-stone-50">
                    <table class="w-full text-sm text-left">
                        <thead class="bg-stone-200 text-stone-700 sticky top-0 font-bold">
                            <tr><th class="p-3 w-12">ID</th><th class="p-3 w-20">유형</th><th class="p-3">문제</th><th class="p-3 w-32">정답</th></tr>
                        </thead>
                        <tbody id="bank-body" class="bg-white"></tbody>
                    </table>
                </div>
            </div>
        </section>

    </main>

    <script>
        // 선생님 구글 시트 URL
        const GOOGLE_SCRIPT_URL = "https://script.google.com/macros/s/AKfycby9MZkDDhyerj2jHKC7PPD8arMR86u9aiBhCKCn5_yabZL9WJv5zygH1Lb15cg70EJFQg/exec";

        /* 문제 은행 (50문항 - 검수 완료) */
        const questionBank = [
            // I. 고대
            { id: 1, type: "choice", question: "아테네 민주 정치가 절정에 달했던 시기의 지도자는?", answer: "페리클레스", options: ["페리클레스", "알렉산드로스", "카이사르", "솔론"], explanation: "페리클레스 시대에 직접 민주주의가 완성되었습니다." },
            { id: 2, type: "blank", question: "아테네 민주 정치에서 여성, 노예, [ _____ ]은 정치에 참여할 수 없었다.", answer: "외국인", explanation: "제한적 민주 정치였습니다." },
            { id: 3, type: "choice", question: "그리스가 페르시아 전쟁에서 승리한 후 아테네를 중심으로 맺은 동맹은?", answer: "델로스 동맹", options: ["펠로폰네소스 동맹", "델로스 동맹", "신성 동맹", "삼국 동맹"], explanation: "아테네가 해상 제국으로 성장하는 계기가 되었습니다." },
            { id: 4, type: "word", question: "그리스-페르시아 전쟁의 승전보를 알리기 위해 달린 데서 유래한 전투 이름은?", answer: "마라톤", explanation: "마라톤 전투입니다." },
            { id: 5, type: "choice", question: "로마 공화정 초기 귀족들의 회의 기구로 최고 의결 기관은?", answer: "원로원", options: ["원로원", "민회", "호민관", "집정관"], explanation: "실질적인 통치권을 행사했습니다." },
            { id: 6, type: "word", question: "로마에서 평민의 권리를 보호하고 귀족의 결정에 거부권을 행사한 직책은?", answer: "호민관", explanation: "평민회에서 선출되었습니다." },
            { id: 7, type: "choice", question: "로마의 첫 황제로 '아우구스투스' 칭호를 받은 인물은?", answer: "옥타비아누스", options: ["카이사르", "옥타비아누스", "안토니우스", "네로"], explanation: "사실상의 제정을 시작했습니다." },
            { id: 8, type: "blank", question: "로마 제국의 번영과 평화가 지속된 시기를 [ _____ ] 로마나 라고 한다.", answer: "팍스", explanation: "Pax Romana(로마의 평화)." },
            { id: 9, type: "choice", question: "로마 제국을 4분할 통치하여 효율성을 꾀했던 황제는?", answer: "디오클레티아누스", options: ["콘스탄티누스", "디오클레티아누스", "테오도시우스", "트라야누스"], explanation: "제국을 나누어 다스렸습니다." },

            // II. 중세
            { id: 10, type: "choice", question: "중세 봉건제에서 주군이 봉신에게 하사한 토지를 무엇이라 하는가?", answer: "봉토", options: ["봉토", "장원", "화폐", "면벌부"], explanation: "토지를 매개로 한 계약 관계였습니다." },
            { id: 11, type: "blank", question: "중세 장원에 속박되어 영주의 땅을 경작하던 농민을 [ _____ ]라고 한다.", answer: "농노", explanation: "거주 이전의 자유가 없는 반자유민입니다." },
            { id: 12, type: "word", question: "황제가 교황에게 용서를 빈 사건은? (ㅋㄴㅅ의 굴욕)", answer: "카노사의 굴욕", explanation: "교황권이 황제권보다 강해지는 계기였습니다." },
            { id: 13, type: "choice", question: "십자군 전쟁의 결과로 옳은 것은?", answer: "교황권 쇠퇴", options: ["교황권 강화", "교황권 쇠퇴", "장원제 강화", "무역 쇠퇴"], explanation: "전쟁 실패로 교황 권위가 추락했습니다." },
            { id: 14, type: "choice", question: "신앙과 이성의 조화를 추구한 중세 서유럽의 철학은?", answer: "스콜라 철학", options: ["스콜라 철학", "경험주의", "실존주의", "계몽 사상"], explanation: "아퀴나스가 대표적입니다." },
            { id: 15, type: "blank", question: "스콜라 철학을 집대성한 인물은 토마스 [ _____ ]이다.", answer: "아퀴나스", explanation: "'신학 대전'을 저술했습니다." },
            { id: 16, type: "choice", question: "뾰족한 첨탑과 스테인드글라스가 특징인 중세 건축 양식은?", answer: "고딕 양식", options: ["로마네스크", "고딕 양식", "비잔티움", "바로크"], explanation: "하늘을 향한 열망을 표현했습니다." },
            { id: 17, type: "word", question: "비잔티움 제국의 유스티니아누스 대제가 편찬한 법전은?", answer: "유스티니아누스 법전", explanation: "로마법을 집대성했습니다." },

            // 르네상스 & 종교개혁
            { id: 18, type: "choice", question: "이탈리아 르네상스의 근본 정신으로 '인간 중심'을 강조한 것은?", answer: "인문주의", options: ["신본주의", "인문주의", "민족주의", "제국주의"], explanation: "고대 그리스, 로마 문화를 부활시키려 했습니다." },
            { id: 19, type: "choice", question: "'모나리자'를 그린 르네상스의 거장은?", answer: "레오나르도 다빈치", options: ["미켈란젤로", "라파엘로", "레오나르도 다빈치", "보티첼리"], explanation: "천재적인 예술가이자 과학자였습니다." },
            { id: 20, type: "blank", question: "알프스 이북의 르네상스는 현실 사회와 [ _____ ]를 비판하는 성격이 강했다.", answer: "교회", explanation: "종교 개혁의 배경이 되었습니다." },
            { id: 21, type: "word", question: "활판 인쇄술을 발명하여 지식 확산에 기여한 인물은?", answer: "구텐베르크", explanation: "성경 보급에 기여했습니다." },
            { id: 22, type: "choice", question: "루터가 비판한 가톨릭 교회의 행위는?", answer: "면벌부 판매", options: ["성직 매매", "면벌부 판매", "십자군 원정", "마녀 사냥"], explanation: "돈으로 죄를 사할 수 없다고 주장했습니다." },
            { id: 23, type: "choice", question: "'예정설'을 주장하고 직업 소명설을 강조한 종교 개혁가는?", answer: "칼뱅", options: ["루터", "칼뱅", "헨리 8세", "쯔빙글리"], explanation: "상공인들의 환영을 받았습니다." },
            { id: 24, type: "choice", question: "이혼 문제로 가톨릭과 결별하고 영국 국교회를 세운 왕은?", answer: "헨리 8세", options: ["엘리자베스 1세", "헨리 8세", "루이 14세", "찰스 1세"], explanation: "정치적 이유로 종교 개혁을 했습니다." },

            // III. 근대
            { id: 25, type: "choice", question: "신항로 개척 당시 서인도 제도에 도착한 인물은?", answer: "콜럼버스", options: ["바스코 다 가마", "마젤란", "콜럼버스", "디아스"], explanation: "아메리카 대륙을 발견했습니다." },
            { id: 26, type: "word", question: "최초로 세계 일주에 성공하여 지구가 둥글다는 것을 증명한 탐험대는?", answer: "마젤란", explanation: "태평양을 횡단했습니다." },
            { id: 27, type: "blank", question: "절대 왕정 시기, 왕권은 신이 주었다는 [ _____ ]설이 유행했다.", answer: "왕권신수", explanation: "절대 권력을 정당화했습니다." },
            { id: 28, type: "choice", question: "에스파냐의 전성기를 이끌며 '무적함대'를 만든 왕은?", answer: "펠리페 2세", options: ["펠리페 2세", "엘리자베스 1세", "루이 14세", "표트르 대제"], explanation: "독실한 가톨릭 신자였습니다." },
            { id: 29, type: "choice", question: "'짐이 곧 국가다'라고 말한 프랑스의 태양왕은?", answer: "루이 14세", options: ["루이 16세", "루이 14세", "나폴레옹", "앙리 4세"], explanation: "베르사유 궁전을 지었습니다." },
            { id: 30, type: "word", question: "러시아의 근대화를 위해 서유럽 문물을 적극 수용한 황제는?", answer: "표트르 대제", explanation: "수염세를 걷는 등 개혁을 추진했습니다." },

            // 시민 혁명
            { id: 31, type: "choice", question: "영국 명예혁명 후 의회가 승인받은 문서는?", answer: "권리장전", options: ["대헌장", "권리청원", "권리장전", "독립선언문"], explanation: "입헌 군주제의 기틀이 되었습니다." },
            { id: 32, type: "blank", question: "미국 독립 혁명의 계기가 된 사건은 [ _____ ] 차 사건이다.", answer: "보스턴", explanation: "영국의 부당한 세금에 저항했습니다." },
            { id: 33, type: "order", question: "프랑스 혁명의 순서를 맞추시오.", answer: "삼부회-바스티유-인권선언-공포정치", options: ["바스티유습격", "공포정치", "인권선언", "삼부회소집"], explanation: "삼부회 소집 -> 바스티유 습격 -> 인권선언 -> 공포정치" },
            { id: 34, type: "choice", question: "프랑스 혁명 당시 공포 정치를 주도한 인물은?", answer: "로베스피에르", options: ["루이 16세", "로베스피에르", "나폴레옹", "당통"], explanation: "단두대를 이용해 반대파를 숙청했습니다." },
            { id: 35, type: "choice", question: "이탈리아 통일 영웅 가리발디가 이끈 부대는?", answer: "붉은 셔츠대", options: ["붉은 셔츠대", "철혈 부대", "십자군", "의용군"], explanation: "시칠리아와 나폴리를 점령했습니다." },
            { id: 36, type: "word", question: "독일 통일 과정에서 비스마르크가 내세운 정책은?", answer: "철혈 정책", explanation: "군사력(철과 피)을 강조했습니다." },

            // IV. 제국주의 & 산업화
            { id: 37, type: "choice", question: "산업 혁명이 가장 먼저 시작된 나라는?", answer: "영국", options: ["프랑스", "독일", "미국", "영국"], explanation: "자본, 자원, 노동력, 정치 안정이 갖춰져 있었습니다." },
            { id: 38, type: "blank", question: "제국주의를 정당화하는 데 이용된 사상은 [ _____ ]론 이다.", answer: "사회진화", explanation: "강자가 약자를 지배하는 것을 당연시했습니다." },
            { id: 39, type: "choice", question: "제국주의 열강의 식민지 쟁탈전이 가장 치열했던 대륙은?", answer: "아프리카", options: ["아시아", "아프리카", "아메리카", "유럽"], explanation: "서구 열강에 의해 분할되었습니다." },

            // V. 세계 대전
            { id: 40, type: "choice", question: "제1차 세계 대전의 도화선이 된 사건은?", answer: "사라예보 사건", options: ["보스턴 차 사건", "사라예보 사건", "피의 일요일", "진주만 습격"], explanation: "오스트리아 황태자 부부가 암살되었습니다." },
            { id: 41, type: "choice", question: "제1차 대전 당시 영국, 프랑스, 러시아 측 동맹은?", answer: "삼국 협상", options: ["삼국 동맹", "삼국 협상", "추축국", "연합국"], explanation: "독일 측 삼국 동맹과 대립했습니다." },
            { id: 42, type: "word", question: "1차 대전 후 독일에게 막대한 배상금을 물린 조약은?", answer: "베르사유 조약", explanation: "2차 대전의 원인 중 하나입니다." },
            { id: 43, type: "blank", question: "대공황 극복을 위해 미국이 실시한 정책은 [ _____ ] 정책이다.", answer: "뉴딜", explanation: "정부가 경제에 적극 개입했습니다." },
            { id: 44, type: "choice", question: "개인의 자유를 억압하고 국가를 우선시하는 사상은?", answer: "전체주의", options: ["자유주의", "민주주의", "전체주의", "개인주의"], explanation: "나치즘, 파시즘이 대표적입니다." },
            { id: 45, type: "choice", question: "제2차 세계 대전 중 나치가 자행한 유대인 학살은?", answer: "홀로코스트", options: ["홀로코스트", "아파르트헤이트", "킬링필드", "인종 청소"], explanation: "인류 최악의 비극입니다." },
            
            // 추가 문제
            { id: 46, type: "choice", question: "고딕 양식의 대표적인 건축물은?", answer: "노트르담 대성당", options: ["판테온", "파르테논 신전", "노트르담 대성당", "콜로세움"], explanation: "파리에 있는 대표적 고딕 건축물입니다." },
            { id: 47, type: "blank", question: "루이 14세가 권위를 과시하기 위해 지은 궁전은 [ _____ ] 궁전이다.", answer: "베르사유", explanation: "화려한 바로크 양식의 궁전입니다." },
            { id: 48, type: "choice", question: "영국 청교도 혁명을 이끌고 공화정을 수립한 인물은?", answer: "크롬웰", options: ["찰스 1세", "크롬웰", "제임스 2세", "윌리엄 3세"], explanation: "왕을 처형하고 독재를 했습니다." },
            { id: 49, type: "word", question: "미국 독립 선언문에서 강조한 천부인권은 생명, 자유, 그리고 무엇의 추구인가?", answer: "행복", explanation: "행복 추구권입니다." },
            { id: 50, type: "choice", question: "나폴레옹이 유럽 원정을 통해 전파한 사상은?", answer: "자유주의", options: ["왕권신수설", "자유주의", "복고주의", "전체주의"], explanation: "프랑스 혁명의 이념을 전파했습니다." }
        ];

        /* 앱 로직 */
        const app = {
            state: {
                student: {},
                questions: [],
                currentIndex: 0,
                answers: {},
                score: 0,
                isTeacherMode: false,
                timer: null,
                timeLeft: 60,
                isTimeOut: false
            },

            init: function() {
                try {
                    this.renderBank();
                } catch(e) { console.error(e); }
            },

            // 교사용 모드 토글 (전역 함수에서 호출됨)
            toggleTeacherMode: function() {
                if (this.state.isTeacherMode) {
                    this.closeTeacherMode();
                    return;
                }
                const pw = prompt("교사용 비밀번호를 입력하세요:");
                if (pw === '0423') { 
                    this.state.isTeacherMode = true;
                    this.showView('view-teacher');
                    this.renderLogs();
                } else if (pw !== null) {
                    alert("비밀번호가 일치하지 않습니다.");
                }
            },

            closeTeacherMode: function() {
                this.state.isTeacherMode = false;
                this.showView('view-login');
            },

            showView: function(viewId) {
                document.querySelectorAll('main > section').forEach(el => el.classList.add('hidden'));
                document.getElementById(viewId).classList.remove('hidden');
                window.scrollTo(0, 0);
            },

            startQuiz: function() {
                const cls = document.getElementById('input-class').value;
                const num = document.getElementById('input-number').value;
                const name = document.getElementById('input-name').value.trim();

                if (!cls || !num || !name) {
                    alert("학년, 반, 번호, 이름을 모두 입력해주세요.");
                    return;
                }

                this.state.student = { class: cls, number: num, name: name };
                
                const shuffled = this.shuffleArray([...questionBank]);
                this.state.questions = shuffled.slice(0, 5); 
                
                this.state.currentIndex = 0;
                this.state.answers = {};
                this.state.score = 0;
                this.state.timeLeft = 60;
                this.state.isTimeOut = false;

                this.showView('view-quiz');
                this.renderQuestion();
                this.startTimer();
            },

            shuffleArray: function(array) {
                for (let i = array.length - 1; i > 0; i--) {
                    const j = Math.floor(Math.random() * (i + 1));
                    [array[i], array[j]] = [array[j], array[i]];
                }
                return array;
            },

            startTimer: function() {
                if (this.state.timer) clearInterval(this.state.timer);
                
                const bar = document.getElementById('timer-bar');
                const text = document.getElementById('timer-text');
                
                bar.style.width = '100%';
                bar.classList.remove('timer-urgent');
                text.innerText = '60초';
                text.classList.remove('animate-pulse');

                this.state.timer = setInterval(() => {
                    this.state.timeLeft--;
                    text.innerText = this.state.timeLeft + '초';
                    const pct = (this.state.timeLeft / 60) * 100;
                    bar.style.width = pct + '%';

                    if (this.state.timeLeft <= 10) {
                        bar.classList.add('timer-urgent');
                        text.classList.add('animate-pulse');
                    }

                    if (this.state.timeLeft <= 0) {
                        clearInterval(this.state.timer);
                        this.state.isTimeOut = true;
                        alert("시간 초과! 자동으로 제출됩니다.");
                        this.finishQuiz();
                    }
                }, 1000);
            },

            renderQuestion: function() {
                const q = this.state.questions[this.state.currentIndex];
                document.getElementById('quiz-progress-text').innerText = `${this.state.currentIndex + 1} / 5`;
                
                const typeName = { 'choice':'객관식', 'blank':'빈칸', 'word':'단답형', 'order':'순서' };
                document.getElementById('question-badge').innerText = typeName[q.type] || '문제';
                document.getElementById('question-text').innerText = q.question;

                const area = document.getElementById('answer-area');
                area.innerHTML = '';
                this.tempAnswer = null;

                if (q.type === 'choice') {
                    const grid = document.createElement('div');
                    grid.className = "grid grid-cols-1 gap-3";
                    q.options.forEach((opt, idx) => {
                        const btn = document.createElement('button');
                        // 기본 스타일
                        btn.className = "w-full text-left p-4 rounded border border-stone-200 hover:bg-stone-50 transition flex items-center bg-white text-stone-800";
                        btn.innerHTML = `<span class="w-6 h-6 rounded-full bg-stone-200 text-stone-600 flex items-center justify-center text-xs font-bold mr-3">${idx+1}</span> ${opt}`;
                        btn.onclick = (e) => {
                            // 모든 버튼 초기화
                            Array.from(grid.children).forEach(c => {
                                c.className = "w-full text-left p-4 rounded border border-stone-200 hover:bg-stone-50 transition flex items-center bg-white text-stone-800";
                                c.querySelector('span').className = "w-6 h-6 rounded-full bg-stone-200 text-stone-600 flex items-center justify-center text-xs font-bold mr-3";
                            });
                            // 선택된 버튼 스타일 (진한 배경 + 흰색 글씨)
                            btn.className = "w-full text-left p-4 rounded border-2 border-amber-600 bg-amber-600 text-white flex items-center font-bold shadow-sm transform scale-[1.02] transition-all";
                            btn.querySelector('span').className = "w-6 h-6 rounded-full bg-white text-amber-600 flex items-center justify-center text-xs font-bold mr-3";
                            this.tempAnswer = opt;
                        };
                        grid.appendChild(btn);
                    });
                    area.appendChild(grid);
                } else if (q.type === 'order') {
                    this.orderTemp = [];
                    const box = document.createElement('div');
                    box.className = "border-2 border-dashed border-amber-300 rounded p-4 mb-3 bg-amber-50 min-h-[50px] flex flex-wrap gap-2";
                    const optsDiv = document.createElement('div');
                    optsDiv.className = "flex flex-wrap gap-2";
                    
                    const shuffledOpts = this.shuffleArray([...q.options]);
                    shuffledOpts.forEach(opt => {
                        const btn = document.createElement('button');
                        btn.className = "px-3 py-2 bg-white border border-stone-300 rounded shadow-sm hover:bg-stone-100";
                        btn.innerText = opt;
                        btn.onclick = () => {
                            if (btn.parentElement === optsDiv) {
                                box.appendChild(btn);
                                btn.classList.add('bg-amber-600', 'text-white');
                                this.orderTemp.push(opt);
                            } else {
                                optsDiv.appendChild(btn);
                                btn.classList.remove('bg-amber-600', 'text-white');
                                this.orderTemp = this.orderTemp.filter(x => x !== opt);
                            }
                        };
                        optsDiv.appendChild(btn);
                    });
                    area.append(box, optsDiv);
                } else {
                    const inp = document.createElement('input');
                    inp.type = "text";
                    inp.className = "w-full p-4 border-b-2 border-stone-300 focus:border-amber-500 outline-none text-center text-lg bg-white";
                    inp.placeholder = "정답을 입력하세요";
                    inp.oninput = (e) => this.tempAnswer = e.target.value;
                    inp.onkeydown = (e) => { if(e.key === 'Enter') this.submitAnswer(); };
                    area.appendChild(inp);
                }
            },

            submitAnswer: function() {
                const q = this.state.questions[this.state.currentIndex];
                let ans = this.tempAnswer;

                if (q.type === 'order') {
                    if (!this.orderTemp || this.orderTemp.length !== q.options.length) {
                        alert("순서를 모두 완성해주세요."); return;
                    }
                    ans = this.orderTemp.join('-');
                } else {
                    if (!ans) { alert("정답을 입력하거나 선택해주세요."); return; }
                }

                this.state.answers[q.id] = ans;

                if (this.state.currentIndex < 4) {
                    this.state.currentIndex++;
                    this.renderQuestion();
                } else {
                    this.finishQuiz();
                }
            },

            finishQuiz: function() {
                clearInterval(this.state.timer);
                
                let correct = 0;
                let details = [];

                this.state.questions.forEach(q => {
                    const userAns = this.state.answers[q.id] || "";
                    const normUser = userAns.toString().replace(/\s+/g, '').trim();
                    const normAns = q.answer.toString().replace(/\s+/g, '').trim();
                    
                    let isCorrect = false;
                    if (q.type === 'word') {
                        isCorrect = normUser.includes(normAns) || normAns.includes(normUser);
                    } else {
                        isCorrect = (normUser === normAns);
                    }

                    if (isCorrect) correct++;
                    else {
                        details.push({ q: q.question, u: userAns || "미입력", a: q.answer, exp: q.explanation });
                    }
                });

                this.state.score = correct * 20;
                this.state.incorrectDetails = details;

                this.showView('view-results');
                this.renderResults();
                this.submitData();
                this.saveLog();
            },

            // 구글 시트 전송 로직 (URLSearchParams + no-cors) - 핵심 수정!
            submitData: function() {
                const status = document.getElementById('submission-status');
                
                // FormData 대신 URLSearchParams 사용 (호환성 UP)
                const params = new URLSearchParams();
                params.append('class', this.state.student.class);
                params.append('number', this.state.student.number);
                params.append('name', this.state.student.name);
                params.append('score', this.state.score);
                params.append('wrong_count', this.state.incorrectDetails.length);
                if(this.state.isTimeOut) params.append('note', '시간초과');

                // 전송
                fetch(GOOGLE_SCRIPT_URL, {
                    method: 'POST',
                    mode: 'no-cors', // CORS 우회 (필수)
                    headers: {
                        'Content-Type': 'application/x-www-form-urlencoded'
                    },
                    body: params.toString()
                })
                .then(() => {
                    // 성공 처리
                    status.className = "bg-green-100 text-green-700 p-3 rounded text-sm mb-6 border border-green-200 font-bold";
                    status.innerHTML = '<i class="fas fa-check-circle"></i> 선생님께 제출 완료!';
                })
                .catch(err => {
                    console.error(err);
                    status.className = "bg-red-100 text-red-700 p-3 rounded text-sm mb-6 border border-red-200";
                    status.innerHTML = '인터넷 연결을 확인해주세요. (전송 실패)';
                });
            },

            renderResults: function() {
                document.getElementById('result-name').innerText = this.state.student.name;
                document.getElementById('score-text').innerText = this.state.score;

                const ctx = document.getElementById('scoreChart').getContext('2d');
                if (window.myChart) window.myChart.destroy();
                window.myChart = new Chart(ctx, {
                    type: 'doughnut',
                    data: {
                        labels: ['정답', '오답'],
                        datasets: [{ data: [this.state.score, 100 - this.state.score], backgroundColor: ['#d97706', '#e5e7eb'], borderWidth: 0 }]
                    },
                    options: { cutout: '80%', plugins: { legend: { display: false } } }
                });

                const list = document.getElementById('review-list');
                list.innerHTML = '';
                if (this.state.incorrectDetails.length === 0) {
                    list.innerHTML = '<div class="text-center text-stone-500 py-4">틀린 문제가 없습니다. 완벽합니다!</div>';
                } else {
                    this.state.incorrectDetails.forEach(d => {
                        list.innerHTML += `
                            <div class="border-b border-stone-100 pb-3 last:border-0">
                                <p class="font-bold text-stone-800 mb-1">Q. ${d.q}</p>
                                <div class="flex gap-2 text-xs mb-2">
                                    <span class="text-red-600 bg-red-50 px-2 py-1 rounded">내 답: ${d.u}</span>
                                    <span class="text-green-600 bg-green-50 px-2 py-1 rounded font-bold">정답: ${d.a}</span>
                                </div>
                                <p class="text-stone-500 text-xs bg-stone-50 p-2 rounded">${d.exp}</p>
                            </div>
                        `;
                    });
                }
            },

            saveLog: function() {
                const logs = JSON.parse(localStorage.getItem('hq_logs') || '[]');
                logs.push({
                    time: new Date().toLocaleTimeString(),
                    student: `${this.state.student.class}반 ${this.state.student.number}번 ${this.state.student.name}`,
                    score: this.state.score,
                    status: this.state.isTimeOut ? "시간초과" : "정상제출"
                });
                localStorage.setItem('hq_logs', JSON.stringify(logs));
            },

            toggleReview: function() {
                document.getElementById('review-section').classList.toggle('hidden');
            },

            setTeacherTab: function(tab) {
                document.getElementById('tab-log').classList.add('hidden');
                document.getElementById('tab-bank').classList.add('hidden');
                document.getElementById('btn-tab-log').className = "px-5 py-2 rounded-full bg-stone-100 text-stone-600 text-sm font-bold hover:bg-stone-200";
                document.getElementById('btn-tab-bank').className = "px-5 py-2 rounded-full bg-stone-100 text-stone-600 text-sm font-bold hover:bg-stone-200";

                document.getElementById('tab-' + tab).classList.remove('hidden');
                document.getElementById('btn-tab-' + tab).className = "px-5 py-2 rounded-full bg-stone-800 text-white text-sm font-bold";
            },

            renderLogs: function() {
                const logs = JSON.parse(localStorage.getItem('hq_logs') || '[]').reverse();
                const tbody = document.getElementById('teacher-log-body');
                tbody.innerHTML = logs.map(l => `
                    <tr class="border-b hover:bg-stone-50">
                        <td class="p-3 text-stone-500">${l.time}</td>
                        <td class="p-3 font-medium">${l.student}</td>
                        <td class="p-3 font-bold text-amber-600">${l.score}점</td>
                        <td class="p-3 text-xs ${l.status==='시간초과'?'text-red-500':'text-green-600'}">${l.status}</td>
                    </tr>
                `).join('');
                this.renderBank();
            },

            renderBank: function() {
                document.getElementById('total-q').innerText = questionBank.length;
                const bankBody = document.getElementById('bank-body');
                bankBody.innerHTML = questionBank.map(q => `
                    <tr class="border-b hover:bg-stone-50">
                        <td class="p-3 text-xs text-stone-400 font-mono">#${q.id}</td>
                        <td class="p-3"><span class="bg-stone-100 text-stone-600 text-xs px-2 py-1 rounded border">${q.type}</span></td>
                        <td class="p-3 text-stone-800">${q.question}</td>
                        <td class="p-3 text-amber-700 font-bold text-xs">${q.answer}</td>
                    </tr>
                `).join('');
            }
        };

        // 안전한 교사용 버튼 실행을 위한 전역 함수
        function openTeacherMode() {
            if (window.app) {
                app.toggleTeacherMode();
            } else {
                alert("앱이 아직 로딩 중입니다. 1초 뒤에 다시 시도해주세요.");
            }
        }

        // 초기화
        window.onload = function() {
            window.app = app; // 전역 app 설정
            app.init();
        };
    </script>
</body>
</html>
